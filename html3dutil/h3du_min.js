(function(a,b){"function"===typeof define&&define.amd?define(["exports"],b):"object"===typeof exports?b(exports):b(a)})(this,function(a){if(!a.Promise){var b=function(a){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];a&&this._invokeResolver(a)};b.resolve=function(a){return new this(function(b){b(a)})};b.reject=function(a){return new this(function(b,c){c(a)})};b.all=b.when=function(a){return new this(function(b,c){var d=0,e=[];a.forEach(function(a,
f){d++;a.then(function(a){e[f]=a;d--;d||b(e)},function(a){d=1/0;c(a)})})})};b.race=function(a){return new this(function(b,c){a.forEach(function(a){a.then(b,c)})})};b.prototype.then=function(a,d){this._cb.fulfilled.push(a);this._cb.rejected.push(d);var c=new b;this._thenPromises.push(c);0<this._state&&this._schedule();return c};b.prototype.fulfill=function(a){if(0!==this._state)return this;this._state=1;this._value=a;this._thenPromises.length&&this._schedule();return this};b.prototype.reject=function(a){if(0!==
this._state)return this;this._state=2;this._value=a;this._thenPromises.length&&this._schedule();return this};b.prototype.resolve=function(a){if(a===this)this.reject(new TypeError("Promise resolved by its own instance"));else if(a instanceof this.constructor)a.chain(this);else{var b;if(null===a||"undefined"===typeof a||"object"!==typeof a&&"function"!==typeof a)this.fulfill(a);else{try{b=a.then}catch(h){this.reject(h);return}if("function"===typeof b){var c=!1,f=function(a){c||(c=!0,this.resolve(a))},
g=function(a){c||(c=!0,this.reject(a))};try{b.call(a,f.bind(this),g.bind(this))}catch(h){c||this.reject(h)}}else this.fulfill(a)}}};b.prototype.chain=function(a){return this.then(function(b){a.resolve(b)},function(b){a.reject(b)})};b.prototype["catch"]=function(a){return this.then(null,a)};b.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};b.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var a=this._cb.fulfilled.shift(),
b=this._cb.rejected.shift();this._executeCallback(1===this._state?a:b)}};b.prototype._executeCallback=function(a){var b=this._thenPromises.shift();if("function"!==typeof a)1===this._state?b.fulfill(this._value):b.reject(this._value);else try{var c=a(this._value);b.resolve(c);return c}catch(f){b.reject(f)}};b.prototype._invokeResolver=function(a){try{a(this.resolve.bind(this),this.reject.bind(this))}catch(d){this.reject(d)}};a.Promise=b}});/*
 CC0-1.0
*/
window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimationFrame||(window.requestAnimationFrame=function(a){window.setTimeout(function(){a(window.performance.now())},17)}));window.performance||(window.performance={});window.performance.now||(window.performance.now=function(){return 1E3*(new Date).getTime()-window.performance._startTime},window.performance._startTime=1E3*(new Date).getTime());
var H3DU={renderLoop:function(a){a(window.performance.now());var b=function(c){window.requestAnimationFrame(b);a(c)};window.requestAnimationFrame(b)},createCanvasElement:function(a,b,c){var d=document.createElement("canvas");a&&a.appendChild(d);if(null===b||"undefined"===typeof b)d.width=Math.ceil(d.clientWidth)+"";else{if(0>b)throw Error("width negative");d.width=Math.ceil(b)+""}if(null===c||"undefined"===typeof c)d.height=Math.ceil(d.clientHeight)+"";else{if(0>c)throw Error("height negative");d.height=
Math.ceil(c)+""}return d},get3DOr2DContext:function(a){if(!a||!a.getContext)return null;var b=null,c={preserveDrawingBuffer:!0,alpha:!1};c.antialias=window.devicePixelRatio&&1<window.devicePixelRatio?!1:!0;try{b=a.getContext("webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("experimental-webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("moz-webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("webkit-3d",c)}catch(d){b=null}if(!b)try{b=a.getContext("2d",c)}catch(d){b=null}H3DU.is3DContext(b)&&(b.getExtension("OES_element_index_uint"),
b.getExtension("OES_standard_derivatives"));return b},get3DContext:function(a,b){var c=H3DU.get3DOr2DContext(a),d=null;!c&&window.WebGLShader?d="Failed to initialize graphics support required by this page.":window.WebGLShader&&!H3DU.is3DContext(c)?d="This page requires WebGL, but it failed to start. Your computer might not support WebGL.":c&&H3DU.is3DContext(c)||(d="This page requires a WebGL-supporting browser.");return d?((b||window.alert)(d),null):c},is3DContext:function(a){return a&&"compileShader"in
a},getPromiseResultsAll:function(a,b,c){return H3DU.getPromiseResults(a,b,c).then(function(a){return 0<a.failures.length?Promise.reject(a):Promise.resolve(a.successes)})},getPromiseResults:function(a,b,c){function d(a,b,c){return function(d){a&&a(d);b.successes[c]=d;return!0}}function e(a,b,c){return function(d){a&&a(d);b.failures[c]=d;return!0}}if(!a||0===a.length)return Promise.resolve({successes:[],failures:[],results:[]});for(var f={successes:[],failures:[],results:[]},g=[],h=0;h<a.length;h++){var k=
h;g.push(a[h].then(d(b,f,k),e(c,f,k)))}return Promise.all(g).then(function(a){for(var b=0;b<f.successes.length;b++)"undefined"===typeof f.successes[b]&&(f.successes.splice(b,1),--b);for(b=0;b<f.failures.length;b++)"undefined"===typeof f.failures[b]&&(f.failures.splice(b,1),--b);f.results=a;return Promise.resolve(f)})},loadFileFromUrl:function(a,b){var c=b||"text";return new Promise(function(b,e){var d=new XMLHttpRequest;d.onreadystatechange=function(d){d=d.target;4===d.readyState&&(200<=d.status&&
300>d.status?(d="xml"===c?d.responseXML:"json"===c?"response"in d?d.response:JSON.parse(d.responseText):"arraybuffer"===c?d.response:d.responseText+"",b({url:a,data:d})):e({url:a}))};d.onerror=function(b){e({url:a,error:b})};d.open("get",a,!0);d.responseType=c;d.send()})},getTimePosition:function(a,b,c){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)a.lastTime=b;return 1*(b-a.time)%c/c},newFrames:function(a,b){if("undefined"===
typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)return a.lastTime=b,0;var c=b-a.lastTime;a.lastTime=b;return 60*c/1E3}};
(function(a){var b=function(){throw Error();};(function(a){a.skipWhite=function(a,b,c){for(;b<c;){var d=a.charCodeAt(b);if(32===d||13===d||12===d||9===d||10===d)++b;else break}return b};a.parseComma=function(a,c,d){var e=c;c=b.skipWhite(a,c,d);return c<d&&44===a.charCodeAt(c)?b.skipWhite(a,c+1,d):e};a.parseEndparen=function(a,c,d){var e=c;c=b.skipWhite(a,c,d);return c<d&&41===a.charCodeAt(c)?c+1:e};a.hsl=function(a,c,d,h){var e,f;e=c;if((f=b.parseHue(a,c,d,h,0))===c)return e;c=f;if((f=b.sepPct(a,
c,d,h,1))===c)return e;c=f;if((f=b.sepPct(a,c,d,h,2))===c)return e;c=f;f=b.parseEndparen(a,c,d);if(f===c)return e;c=f;a=b.hlsToRgb(h[0],h[2],h[1]);h[0]=a[0];h[1]=a[1];h[2]=a[2];h[3]=255;return c};a.pct=function(a,c,d,h,k){var e=b.parseNumber(a,c,d);if(e!==c){if(e>=d||37!==a.charAt(e))return c;h[k]=255*b.stringToPercent(a,c,e)/100;return e+1}return e};a.parseByte=function(a,c,d,h,k){d=b.parseInteger(a,c,d,!0);d!==c&&(h[k]=b.stringToByte(a,c,d));return d};a.parseHue=function(a,c,d,h,k){var e=c;c=b.skipWhite(a,
c,d);d=b.parseNumber(a,c,d);return d!==c?(h[k]=b.stringToHue(a,c,d),d):e};a.sepByte=function(a,c,d,h,k){var e=b.parseComma(a,c,d);return e!==c?b.parseByte(a,e,d,h,k):e};a.sepPct=function(a,c,d,h,k){var e=b.parseComma(a,c,d);return e!==c?b.pct(a,e,d,h,k):e};a.sepAlpha=function(a,c,d,h,k){var e=b.parseComma(a,c,d);e!==c&&(c=e,e=b.parseNumber(a,c,d),e!==c&&(h[k]=b.stringToAlpha(a,c,e)));return e};a.hsla=function(a,c,d,h){var e,f;e=c;if((f=b.parseHue(a,c,d,h,0))===c)return e;c=f;if((f=b.sepPct(a,c,d,
h,1))===c)return e;c=f;if((f=b.sepPct(a,c,d,h,2))===c)return e;c=f;if((f=b.sepAlpha(a,c,d,h,3))===c)return e;c=f;f=b.hlsToRgb(h[0],h[2],h[1]);h[0]=f[0];h[1]=f[1];h[2]=f[2];f=b.parseEndparen(a,c,d);return f===c?e:f};a.rgba=function(a,c,d,h){var e,f;e=c;var g=c=b.skipWhite(a,c,d),l=!0;(f=b.pct(a,c,d,h,0))===c?l=!1:c=f;l&&(f=b.sepPct(a,c,d,h,1))===c?l=!1:c=f;l&&(f=b.sepPct(a,c,d,h,2))===c?l=!1:c=f;l&&(f=b.sepAlpha(a,c,d,h,3))===c?l=!1:c=f;l||(c=g,l=!0,(f=b.parseByte(a,c,d,h,0))===c?l=!1:c=f,l&&(f=b.sepByte(a,
c,d,h,1))===c?l=!1:c=f,l&&(f=b.sepByte(a,c,d,h,2))===c?l=!1:c=f,l&&(f=b.sepAlpha(a,c,d,h,3))===c?l=!1:c=f);if(!l)return e;f=b.parseEndparen(a,c,d);return f===c?e:f};a.rgb=function(a,c,d,h){var e,f;e=c;var g=c=b.skipWhite(a,c,d),l=!0;(f=b.pct(a,c,d,h,0))===c?l=!1:c=f;l&&(f=b.sepPct(a,c,d,h,1))===c?l=!1:c=f;l&&(f=b.sepPct(a,c,d,h,2))===c?l=!1:c=f;l||(c=g,l=!0,(f=b.parseByte(a,c,d,h,0))===c?l=!1:c=f,l&&(f=b.sepByte(a,c,d,h,1))===c?l=!1:c=f,l&&(f=b.sepByte(a,c,d,h,2))===c?l=!1:c=f);if(!l)return e;h[3]=
255;f=b.parseEndparen(a,c,d);return f===c?e:f};a.stringToNumber=function(a,b,c){a=a.substring(b,b+(c-b));return parseFloat(a)};a.stringToPercent=function(a,c,d){a=b.stringToNumber(a,c,d);return Number.isNaN(a)?-1:0>a?0:100<a?100:a};a.stringToAlpha=function(a,c,d){a=b.stringToNumber(a,c,d);return 0>a?0:1<a?255:255*a};a.stringToHue=function(a,c,d){a=b.stringToNumber(a,c,d);return Number.isNaN(a)||a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY?0:(a%360+360)%360};a.stringToByte=function(a,
c,d){a=b.stringToNumber(a,c,d);return 0>a?0:255<a?255:a};a.parseInteger=function(a,b,c,d){var e=!1,f=b;for(d&&b<c&&(43===a.charCodeAt(b)||45===a.charCodeAt(b))&&++b;b<c&&48<=a.charCodeAt(b)&&57>=a.charCodeAt(b);)++b,e=!0;return e?b:f};a.parseNumber=function(a,c,d){var e=c,f,g=0;if((f=b.parseInteger(a,c,d,!0))!==e)return c=f,c<d&&46===a.charCodeAt(c)?(++c,(f=b.parseInteger(a,c,d,!1))!==c?c<d&&(69===a.charCodeAt(c)||101===a.charCodeAt(c))&&(g=b.parseInteger(a,c+1,d,!0))!==c+1?g:f:c-1):c;c<d&&(43===
a.charCodeAt(c)||45===a.charCodeAt(c))&&++c;return c<d&&46===a.charCodeAt(c)&&(++c,(f=b.parseInteger(a,c,d,!1))!==c)?c<d&&(69===a.charCodeAt(c)||101===a.charCodeAt(c))&&(g=b.parseInteger(a,c+1,d,!0))!==c+1?g:f:e};a.hlsToRgb=a.HlsToRgb=function(a,b,c){b=0>b?0:255<b?255:b;c=0>c?0:255<c?255:c;if(0===c)return[b,b,b];c=127.5>=b?b*(255+c)/255:b+c-b*c/255;var d=2*b-c,e;if(0>a||360<=a)a=(a%360+360)%360;var f=a+120;360<=f&&(f-=360);b=60>f?d+(c-d)*f/60:180>f?c:240>f?d+(c-d)*(240-f)/60:d;f=a;e=60>f?d+(c-d)*
f/60:180>f?c:240>f?d+(c-d)*(240-f)/60:d;f=a-120;0>f&&(f+=360);a=60>f?d+(c-d)*f/60:180>f?c:240>f?d+(c-d)*(240-f)/60:d;return[0>b?0:255<b?255:b,0>e?0:255<e?255:e,0>a?0:255<a?255:a]};a.dehexchar=function(a){return 48<=a&&57>=a?a-48:65<=a&&70>=a?a+10-65:97<=a&&102>=a?a+10-97:-1};a.rgbHex=function(a,c,d){if(null===a||"undefined"===typeof a||0===a.length)return!1;var e=a.length,f=[0,0,0,0,0,0,0,0],g=0,m=0;if("#"===a.charAt(0))--e,++g;else if(d)return!1;if(3!==e&&4!==e&&6!==e&&8!==e)return!1;for(d=g;d<a.length;++d){g=
b.dehexchar(a.charCodeAt(d));if(0>g)return!1;f[m++]=g}c[3]=4===e?f[3]|f[3]<<4:8===e?f[7]|f[6]<<4:255;3===e||4===e?(c[0]=f[0]|f[0]<<4,c[1]=f[1]|f[1]<<4,c[2]=f[2]|f[2]<<4):6<=e&&(c[0]=f[1]|f[0]<<4,c[1]=f[3]|f[2]<<4,c[2]=f[5]|f[4]<<4);return!0};a.colorToRgba=a.colorToRgba=function(a){if(null===a||"undefined"===typeof a||0===a.length)return null;a=a.replace(/^[\r\n\t \u000c]+|[\r\n\t \u000c]+$/g,"");a=a.toLowerCase();if("transparent"===a)return[0,0,0,0];if(null===a||"undefined"===typeof a||0===a.length)return null;
var c=[0,0,0,0];if("#"===a.charAt(0)&&b.rgbHex(a,c,!0))return c;if(4<a.length&&"rgb("===a.substring(0,4))return b.rgb(a,4,a.length,c)===a.length?c:null;if(5<a.length&&"rgba("===a.substring(0,5))return b.rgba(a,5,a.length,c)===a.length?c:null;if(4<a.length&&"hsl("===a.substring(0,4))return b.hsl(a,4,a.length,c)===a.length?c:null;if(5<a.length&&"hsla("===a.substring(0,5))return b.hsla(a,5,a.length,c)===a.length?c:null;var d=b.colorToRgbaSetUpNamedColors();return null!==d[a]&&"undefined"!==typeof d[a]?
(b.rgbHex(d[a],c,!1),c):null};a.namedColorMap=a.namedColorMap=null;a.nc="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
a.colorToRgbaSetUpNamedColors=function(){if("undefined"===typeof b.namedColorMap||null===b.namedColorMap){for(var a={},c=0;c<b.nc.length;c+=2)a[b.nc[c]]=b.nc[c+1];a.grey=a.gray;a.darkgrey=a.darkgray;a.darkslategrey=a.darkslategray;a.dimgrey=a.dimgray;a.lightgrey=a.lightgray;a.lightslategrey=a.lightslategray;a.slategrey=a.slategray;b.namedColorMap=a}return b.namedColorMap}})(b,b.prototype);var c=function(a){a[0]=0>a[0]?0:Math.min(a[0],1);a[1]=0>a[1]?0:Math.min(a[1],1);a[2]=0>a[2]?0:Math.min(a[2],1);
a[3]=0>a[3]?0:Math.min(a[3],1);return a};a.toGLColor=function(a,e,f,g){return null===a||"undefined"===typeof a?[0,0,0,0]:"string"===typeof a?(a=b.colorToRgba(a)||[0,0,0,0],e=1/255,a[0]*=e,a[1]*=e,a[2]*=e,a[3]*=e,c(a)):"number"===typeof a&&"number"===typeof e&&"number"===typeof f?[a,e,f,"number"!==typeof g?1:g]:a.constructor===Array?c([a[0]||0,a[1]||0,a[2]||0,"number"!==typeof a[3]?1:a[3]]):c(a||[0,0,0,0])}})(H3DU);H3DU._toContext=function(a){return a&&a.getContext?a.getContext():a};
H3DU._isPowerOfTwo=function(a){if(Math.floor(a)!==a||0>=a)return!1;for(;1<a&&0===(a&1);)a>>=1;return 1===a};H3DU._isIdentityExceptTranslate=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&1===a[15]};H3DU.ShaderProgram=function(a,b,c){this._init(a,new H3DU.ShaderInfo(b,c))};H3DU.ShaderProgram._fromShaderInfo=function(a,b){var c=new H3DU.ShaderProgram(null);c._init(a,b);return c};
H3DU.ShaderProgram.prototype._init=function(a,b){if(a&&(a=a.getContext?a.getContext():a,this.shaderInfo=b,this.context=a,this.prog=H3DU.ShaderProgram._compileShaders(a,b.vertexShader,b.fragmentShader),this.uniformValues={},this.actives={},this.attributes=[],this.uniformTypes={},this.savedUniforms={},this.attributeNames=[],H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms),this.CURRENT_PROGRAM=35725,this.FLOAT=5126,"undefined"!==typeof this.prog&&
null!==this.prog)){for(var c,d={},e=a.getProgramParameter(this.prog,a.ACTIVE_ATTRIBUTES),f=0;f<e;++f)if(c=a.getActiveAttrib(this.prog,f),null!==c&&"undefined"!==typeof c){c=c.name;var g=a.getAttribLocation(this.prog,c);0<=g&&(this.attributes.push(g),d[c]=g,this.attributeNames.push([c,g]))}e=a.getProgramParameter(this.prog,a.ACTIVE_UNIFORMS);for(f=0;f<e;++f)g=this.context.getActiveUniform(this.prog,f),null!==g&&"undefined"!==typeof g&&(c=g.name,d[c]=this.context.getUniformLocation(this.prog,c),this.uniformTypes[c]=
g.type);this.actives=d}};H3DU.ShaderProgram.prototype._disableOthers=function(a){for(var b={},c=0;c<a.length;c++)b[a[c][0]]=!0;for(c=0;c<this.attributeNames.length;c++)a=this.attributeNames[c],b[a[0]]||this.context.disableVertexAttribArray(a[1])};H3DU.ShaderProgram.prototype.dispose=function(){this.program&&this.context.deleteProgram(this.program);this.program=this.context=null;this.actives={};this.attributes={};this.uniformTypes={}};H3DU.ShaderProgram.prototype.getContext=function(){return this.context};
H3DU.ShaderProgram.prototype._setUniformInternal=function(a,b){var c=this.get(b);if(null!==c&&"undefined"!==typeof c){var d=a[b];"number"===typeof d?this.uniformTypes[b]===this.FLOAT?this.context.uniform1f(c,d):this.context.uniform1i(c,d):3===d.length?this.context.uniform3fv(c,d):2===d.length?this.context.uniform2fv(c,d):4===d.length?this.context.uniform4fv(c,d):16===d.length?this.context.uniformMatrix4fv(c,!1,d):9===d.length&&this.context.uniformMatrix3fv(c,!1,d)}};
H3DU.ShaderProgram.prototype.get=function(a){a=this.actives[a];return null===a||"undefined"===typeof a?null:a};H3DU.ShaderProgram.prototype.getUniform=function(a){var b="string"===typeof a?this.get(a):a;if(null===b||"number"===typeof b)return null;a=this.uniformValues[a];return null===a||"undefined"===typeof a?this.context.getUniform(this.program,b):a instanceof Array?a.slice(0,a.length):a};
H3DU.ShaderProgram.prototype._setSavedUniforms=function(){var a,b=0;if("undefined"===typeof Object.keys)for(a in this.savedUniforms)Object.prototype.hasOwnProperty.call(this.savedUniforms,a)&&(this._setUniformInternal(this.savedUniforms,a),b++);else for(var c=Object.keys(this.savedUniforms),b=c.length,d=0;d<b;d++)a=c[d],this._setUniformInternal(this.savedUniforms,a);return b};
H3DU.ShaderProgram.prototype.use=function(){this.context.useProgram(this.prog);0<this._setSavedUniforms()&&(this.savedUniforms={});return this};H3DU.ShaderProgram.prototype._update=function(){H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms);return this};
H3DU.ShaderProgram.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,this.savedUniforms);this.context.getParameter(this.CURRENT_PROGRAM)===this.prog&&0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
H3DU.ShaderProgram._compileShaders=function(a,b,c){function d(a,b,c){var d=a.createShader(b);a.shaderSource(d,c);a.compileShader(d);if(!a.getShaderParameter(d,a.COMPILE_STATUS)){c=c.split("\n");for(var e=0;e<c.length;e++)c[e]="/* "+(e+1)+" */   "+c[e];console.log(c.join("\n"));console.log((b===a.VERTEX_SHADER?"vertex: ":"fragment: ")+a.getShaderInfoLog(d));return null}return d}b=b&&0!==b.length?d(a,a.VERTEX_SHADER,b):null;c=c&&0!==c.length?d(a,a.FRAGMENT_SHADER,c):null;var e=null;null!==b&&"undefined"!==
typeof b&&null!==c&&"undefined"!==typeof c&&(e=a.createProgram(),a.attachShader(e,b),a.attachShader(e,c),a.linkProgram(e),a.getProgramParameter(e,a.LINK_STATUS)||(console.log("link: "+a.getProgramInfoLog(e)),a.deleteProgram(e),e=null),a.detachShader(e,b),a.detachShader(e,c));null!==b&&"undefined"!==typeof b&&a.deleteShader(b);null!==c&&"undefined"!==typeof c&&a.deleteShader(c);return e};H3DU.ShaderProgram.makeEffectFragment=function(a){return H3DU.ShaderInfo.makeEffectFragment(a)};
H3DU.ShaderProgram.makeCopyEffect=function(){return H3DU.ShaderInfo.makeCopyEffect()};H3DU.ShaderProgram.makeEffect=function(a,b){return H3DU.ShaderInfo.makeEffect(b)};H3DU.ShaderProgram.getInvertEffect=function(){return H3DU.ShaderInfo.makeInvertEffect()};H3DU.ShaderProgram.getEdgeDetectEffect=function(){return H3DU.ShaderInfo.makeEdgeDetectEffect()};H3DU.ShaderProgram.getDefaultVertex=function(){return H3DU.ShaderInfo.getDefaultVertex()};H3DU.ShaderProgram.getDefaultFragment=function(){return H3DU.ShaderInfo.getDefaultFragment()};H3DU.Transform=function(){this.scale=[1,1,1];this.position=[0,0,0];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=H3DU.Math.mat4identity()};H3DU.Transform.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],this.matrix[10]]:this.scale.slice(0,3)};H3DU.Transform.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};
H3DU.Transform.prototype.getQuaternion=function(){return this.complexMatrix?H3DU.Math.quatNormInPlace(H3DU.Math.quatFromMat4(this.matrix)):this.rotation.slice(0,4)};H3DU.Transform.prototype.reset=function(){this.matrix=H3DU.Math.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;return this};
H3DU.Transform.prototype.setMatrix=function(a){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=H3DU.Math.quatFromMat4(this.matrix);this.rotation=H3DU.Math.quatNormInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&
0===a[14]&&1===a[15];return this};H3DU.Transform.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&H3DU.Math.quatIsIdentity(this.rotation);return this._isIdentity};H3DU.Transform.prototype.resetTransform=function(){return this.reset()};
H3DU.Transform.prototype.setScale=function(a,b,c){if(this.complexMatrix)return this;this.scale=null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.setPosition=function(a,b,c){if(this.complexMatrix)return this;this.position=null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.movePosition=function(a,b,c){if(this.complexMatrix)return this;null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?(this.position[0]+=a,this.position[1]+=b,this.position[2]+=c):"number"!==typeof a?(this.position[0]+=a[0],this.position[1]+=a[1],this.position[2]+=a[2]):(this.position[0]+=a,this.position[1]+=a,this.position[2]+=a);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];
this._matrixDirty=!0;return this};H3DU.Transform.prototype.setQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=a.slice(0,4);H3DU.Math.quatNormInPlace(this.rotation);this._matrixDirty=!0;return this};H3DU.Transform.prototype.setOrientation=function(a,b,c,d){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};
H3DU.Transform.prototype.multQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=H3DU.Math.quatNormInPlace(H3DU.Math.quatMultiply(this.rotation,a));this._matrixDirty=!0;return this};H3DU.Transform.prototype.multOrientation=function(a,b,c,d){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};
H3DU.Transform.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,H3DU.Math.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=
H3DU.Math.mat4multiply(this.matrix,H3DU.Math.quatToMat4(this.rotation));H3DU.Math.mat4scaleInPlace(this.matrix,this.scale);var a=this.matrix;this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]}else if(this._isIdentity)return H3DU.Math.mat4identity();return this.matrix.slice(0,16)};
H3DU.Transform.prototype.copy=function(){var a=new H3DU.Transform;a.scale=this.scale.slice(0,this.scale.length);a.position=this.position.slice(0,this.scale.length);a.complexMatrix=this.complexMatrix;a._matrixDirty=this._matrixDirty;a.matrix=this.matrix.slice(0,this.matrix.length);return a};H3DU.Meshes={};
H3DU.Meshes.createBox=function(a,b,c,d){a*=.5;b*=.5;c*=.5;a=[-a,-b,c,-1,0,0,1,0,-a,b,c,-1,0,0,1,1,-a,b,-c,-1,0,0,0,1,-a,-b,-c,-1,0,0,0,0,a,-b,-c,1,0,0,1,0,a,b,-c,1,0,0,1,1,a,b,c,1,0,0,0,1,a,-b,c,1,0,0,0,0,a,-b,-c,0,-1,0,1,0,a,-b,c,0,-1,0,1,1,-a,-b,c,0,-1,0,0,1,-a,-b,-c,0,-1,0,0,0,a,b,c,0,1,0,1,0,a,b,-c,0,1,0,1,1,-a,b,-c,0,1,0,0,1,-a,b,c,0,1,0,0,0,-a,-b,-c,0,0,-1,1,0,-a,b,-c,0,0,-1,1,1,a,b,-c,0,0,-1,0,1,a,-b,-c,0,0,-1,0,0,a,-b,c,0,0,1,1,0,a,b,c,0,0,1,1,1,-a,b,c,0,0,1,0,1,-a,-b,c,0,0,1,0,0];if(d)for(d=
0;d<a.length;d+=8)a[d+3]=-a[d+3],a[d+4]=-a[d+4],a[d+5]=-a[d+5];return new H3DU.Mesh(a,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.TEXCOORDS_BIT)};
H3DU.Meshes.createCylinder=function(a,b,c,d,e,f,g){var h=new H3DU.Mesh;if(null===d||"undefined"===typeof d)d=32;if(null===e||"undefined"===typeof e)e=1;if(2>=d)throw Error("too few slices");if(1>e)throw Error("too few stacks");if(0>c)throw Error("negative height");if(0>=a&&0>=b||0===c)return h;for(var k=g?-1:1,n=[0,1],m=[0],l=H3DU.Math.PiTimes2,p=1;p<d;p++){var r=1*p/d,q=l*r,t=Math.cos(q);n.push(0<=q&&6.283185307179586>q?3.141592653589793>=q?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(q),t);m.push(r)}n.push(0,
1);m.push(1);d*=2;if(0<c)for(l=0,r=a,a===b?(t=0,q=k):(p=Math.atan2(a-b,c),q=Math.cos(p),t=0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-q*q):-Math.sqrt(1-q*q):Math.sin(p),t*=k,q*=k),k=1/e,p=0;p<e;p++){var w=l,x=p+1===e?1:(p+1)*k,A=c*w,z=c*x,v=r,D=a+(b-a)*x,l=x,r=D;h.mode(H3DU.Mesh.TRIANGLE_STRIP);h.texCoord2(1,w);h.normal3(0,q,t);h.vertex3(0,v,A);h.texCoord2(1,x);h.normal3(0,q,t);h.vertex3(0,D,z);for(var u=2,I=1;u<=d;u+=2,I++){var B=m[I],y,C;y=n[u];C=n[u+1];h.texCoord2(1-B,w);h.normal3(y*
q,C*q,t);h.vertex3(y*v,C*v,A);h.texCoord2(1-B,x);h.normal3(y*q,C*q,t);h.vertex3(y*D,C*D,z)}}return f?h.recalcNormals(f,g):h};
H3DU.Meshes.createLathe=function(a,b,c,d){var e=new H3DU.Mesh;if(4>a.length)throw Error("too few points");if(null===b||"undefined"===typeof b)b=32;if(2>=b)throw Error("too few slices");if(0!==a.length%1)throw Error("points array length is not an even number");var f;for(f=0;f<a.length;f+=2)if(0>a[f<<1])throw Error("point's x is less than 0");var g=[0,1],h=[0],k=H3DU.Math.PiTimes2;for(f=1;f<b;f++){var n=1*f/b,m=k*n,l=Math.cos(m);g.push(0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-l*l):
-Math.sqrt(1-l*l):Math.sin(m),l);h.push(n)}g.push(0,1);h.push(1);b*=2;var p=0,k=a.length/2-1,n=1/k;for(f=0;f<k;f++){var m=p,l=f+1===k?1:(f+1)*n,p=f<<1,r=a[p+1],q=a[p+3],t=Math.min(r,q),r=Math.max(r,q),q=a[p],w=a[p+2],p=l;e.mode(H3DU.Mesh.TRIANGLE_STRIP);e.texCoord2(1,m);e.vertex3(0,q,t);e.texCoord2(1,l);e.vertex3(0,w,r);for(var x=2,A=1;x<=b;x+=2,A++){var z=h[A],v,D;v=g[x];D=g[x+1];e.texCoord2(1-z,m);e.vertex3(v*q,D*q,t);e.texCoord2(1-z,l);e.vertex3(v*w,D*w,r)}}return e.recalcNormals(c,d)};
H3DU.Meshes.createClosedCylinder=function(a,b,c,d,e,f,g){e=H3DU.Meshes.createCylinder(a,b,c,d,e,f,g);a=H3DU.Meshes.createDisk(0,a,d,2,!g).reverseWinding();b=H3DU.Meshes.createDisk(0,b,d,2,g);b.transform(H3DU.Math.mat4translated(0,0,c));return e.merge(a).merge(b)};H3DU.Meshes.createDisk=function(a,b,c,d,e){return H3DU.Meshes.createPartialDisk(a,b,c,d,0,360,e)};
H3DU.Meshes.createPartialDisk=function(a,b,c,d,e,f,g){var h=new H3DU.Mesh;if(null===c||"undefined"===typeof c)c=32;if(null===d||"undefined"===typeof d)d=1;if(null===e||"undefined"===typeof e)e=0;if(null===f||"undefined"===typeof f)f=360;if(2>=c)throw Error("too few slices");if(1>d)throw Error("too few loops");if(a>b)throw Error("inner greater than outer");0>a&&(a=0);0>b&&(b=0);if(0===b||0===f)return h;var k=360===f&&0===e,n=0>f?-1:1;0>f&&(f=-f);f%=360;0===f&&(f=360);var m=[],l=[],p=H3DU.Math.PiTimes2;
f=360===f?p:f*H3DU.Math.PiDividedBy180;e*=H3DU.Math.PiDividedBy180;0>n&&(f=-f);for(n=0;n<=c;n++){var r=1*n/c,q=1===r&&f===p?e:e+f*r,q=0>q?p- -q%p:q%p,t=Math.cos(q);m.push(0<=q&&6.283185307179586>q?3.141592653589793>=q?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(q),t);l.push(r)}k&&(m[0]=0,m[1]=1,m[m.length-1]=1,m[m.length-2]=0,l[0]=0,l[l.length-1]=1);c*=2;e=b-a;k=a;g?h.normal3(0,0,-1):h.normal3(0,0,1);for(n=0;n<d;n++){g=k;l=a+(n+1)/d*e;p=g/b;f=l/b;k=l;r=0===n&&0===a;h.mode(r?H3DU.Mesh.TRIANGLE_FAN:
H3DU.Mesh.TRIANGLE_STRIP);var w;if(r)for(q=c/2,r=c,w=q;0<=r;r-=2,w--)q=m[r],t=m[r+1],r===c&&(h.texCoord2(.5*(1+q*p),.5*(1+t*p)),h.vertex3(q*g,t*g,0)),h.texCoord2(.5*(1+q*f),.5*(1+t*f)),h.vertex3(q*l,t*l,0);else for(w=r=0;r<=c;r+=2,w++)q=m[r],t=m[r+1],h.texCoord2(.5*(1+q*f),.5*(1+t*f)),h.vertex3(q*l,t*l,0),h.texCoord2(.5*(1+q*p),.5*(1+t*p)),h.vertex3(q*g,t*g,0)}return h};
H3DU.Meshes.createTorus=function(a,b,c,d,e,f){var g=new H3DU.Mesh;if(null===d||"undefined"===typeof d)d=16;if(null===c||"undefined"===typeof c)c=16;if(3>d)throw Error("crosswise is less than 3");if(3>c)throw Error("lengthwise is less than 3");if(0>a||0>b)throw Error("inner or outer is less than 0");if(0===b||0===a)return g;for(var h=H3DU.Math.PiTimes2,k=[],n=[],m,l,p=0;p<d;p++)l=p*h/d,m=Math.cos(l),l=0<=l&&6.283185307179586>l?3.141592653589793>=l?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(l),k.push(l,
m);k.push(k[0]);k.push(k[1]);for(p=0;p<c;p++)l=p*h/c,m=Math.cos(l),l=0<=l&&6.283185307179586>l?3.141592653589793>=l?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(l),n.push(l,m);n.push(n[0]);n.push(n[1]);for(h=0;h<c;h++){m=h/c;var r=(h+1)/c,q=n[2*h],t=n[2*h+1],w=n[2*h+2],x=n[2*h+3];g.mode(H3DU.Mesh.TRIANGLE_STRIP);for(p=0;p<=d;p++){l=p/d;var A=k[2*p],z=k[2*p+1],v=z*(b+x*a),D=A*(b+x*a),u=w*a,I=x*z,B=x*A,y=w;g.normal3(I,B,y);g.texCoord2(l,r);g.vertex3(v,D,u);v=z*(b+t*a);D=A*(b+t*a);u=q*a;I=t*z;B=t*A;y=
q;g.normal3(I,B,y);g.texCoord2(l,m);g.vertex3(v,D,u)}}return e?g.recalcNormals(e,f):g};
H3DU.Meshes.createPlane=function(a,b,c,d,e){var f=new H3DU.Mesh;if(null===a||"undefined"===typeof a)a=1;if(null===b||"undefined"===typeof b)b=1;if(null===c||"undefined"===typeof c)c=1;if(null===d||"undefined"===typeof d)d=1;if(0>a||0>b)throw Error("width or height is less than 0");if(0>=d||0>=c)throw Error("widthDiv or heightDiv is 0 or less");if(0===a||0===b)return f;var g=.5*-a,h=.5*-b;e?f.normal3(0,0,-1):f.normal3(0,0,1);for(e=0;e<d;e++){f.mode(H3DU.Mesh.TRIANGLE_STRIP);var k=e/d,n=(e+1)/d,m=h+
b*k,l=h+b*n;f.texCoord2(0,n);f.vertex3(g,l,0);f.texCoord2(0,k);f.vertex3(g,m,0);for(var p=0;p<c;p++){var r=(p+1)/c,q=g+a*r;f.texCoord2(r,n);f.vertex3(q,l,0);f.texCoord2(r,k);f.vertex3(q,m,0)}}return f};H3DU.Meshes.createSphere=function(a,b,c,d,e){return H3DU.Meshes._createCapsule(a,0,b,c,1,d,e)};H3DU.Meshes.createCapsule=function(a,b,c,d,e,f,g){if(null===d||"undefined"===typeof d)d=8;if(1>d)throw Error("too few stacks");return H3DU.Meshes._createCapsule(a,b,c,2*d,e,f,g)};
H3DU.Meshes._createCapsule=function(a,b,c,d,e,f,g){function h(a,b,c,d,e,f){a.normal3(c*b,d*b,e*b);a.vertex3(c,d,e+f)}var k=new H3DU.Mesh;if(null===c||"undefined"===typeof c)c=16;if(null===d||"undefined"===typeof d)d=16;if(null===e||"undefined"===typeof e)e=1;if(null===a||"undefined"===typeof a)a=1;if(null===b||"undefined"===typeof b)b=1;if(2>d)throw Error("too few stacks");if(2>=c)throw Error("too few slices");if(1>e&&0<b)throw Error("too few middle stacks");if(0>b)throw Error("negative length");
if(0>a)throw Error("negative radius");if(0===a)return k;for(var n,m,l=.5*b,p=d/2,r=g?-1:1,q=[0,1],t=[],w=[],x=[0],A,z=H3DU.Math.PiTimes2,v=1;v<c;v++){var D=1*v/c;m=z*D;n=Math.cos(m);m=0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(m);q.push(m,n);x.push(D)}q.push(0,1);x.push(1);z=2*a;z/=z+b;D=[];for(v=1;v<d;v++){var u=1*v/d;m=Math.PI*u;n=Math.cos(m);m=0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(m);t.push(m);
D.push(-n);w.push(u)}t.push(0);w.push(1);D.push(1);c*=2;n=-1;for(var I=m=0,v=0;v<d;v++){var B=D[v],y=w[v];A=a*n;var u=a*B,C=v<p?-l:l,J=m,G=a*t[v],L=I,M=y;0<b&&(L=v<p?I*z:1-(1-I)*z,M=v<p?y*z:1-(1-y)*z);n=B;I=y;m=G;v===d-1||0===v?k.mode(H3DU.Mesh.TRIANGLES):(k.mode(H3DU.Mesh.TRIANGLE_STRIP),k.texCoord2(1,L),h(k,r,0,J,A,C),k.texCoord2(1,M),h(k,r,0,G,u,C));for(var K=0,N=0,F=1,E,H,y=2,O=1;y<=c;y+=2,O++)B=x[O],v===d-1?(E=K+.5*(B-K),k.texCoord2(1-K,L),h(k,r,N*J,F*J,A,C),k.texCoord2(1-E,M),h(k,r,0,G,u,C),
E=q[y],H=q[y+1],k.texCoord2(1-B,L),h(k,r,E*J,H*J,A,C),N=E,F=H,K=B):0===v?(E=K+.5*(B-K),k.texCoord2(1-E,L),h(k,r,0,J,A,C),k.texCoord2(1-K,M),h(k,r,N*G,F*G,u,C),E=q[y],H=q[y+1],k.texCoord2(1-B,M),h(k,r,E*G,H*G,u,C),N=E,F=H,K=B):(E=q[y],H=q[y+1],k.texCoord2(1-B,L),h(k,r,E*J,H*J,A,C),k.texCoord2(1-B,M),h(k,r,E*G,H*G,u,C));if(v+1===p&&0<b)for(C=.5*z,J=2*l,K=1-C,N=1-z,F=0;F<e;F++){A=-l+(0===F?0:J*F/e);var P=F===e-1?l:-l+J*(F+1)/e,L=C+(0===F?0:N*F/e),M=F===e-1?K:C+N*(F+1)/e;k.mode(H3DU.Mesh.TRIANGLE_STRIP);
k.texCoord2(1,L);h(k,r,0,G,u,A);k.texCoord2(1,M);h(k,r,0,G,u,P);y=2;for(O=1;y<=c;y+=2,O++)B=x[O],E=q[y],H=q[y+1],k.texCoord2(1-B,L),h(k,r,E*G,H*G,u,A),k.texCoord2(1-B,M),h(k,r,E*G,H*G,u,P)}}return f?k.recalcNormals(f,g):k.normalizeNormals()};
H3DU.Meshes.createPointedStar=function(a,b,c,d){var e=new H3DU.Mesh;if(2>a||0>b||0>c||0>=b&&0>=c)return e;e.mode(H3DU.Mesh.TRIANGLE_FAN);var f=0,g=0,h=H3DU.Math.PiTimes2,k=1/(2*a),n=1/Math.max(b,c);e.normal3(0,0,d?-1:1).texCoord2(.5,.5).vertex2(0,0);for(d=0;d<2*a;d++){var m=h*d*k,l=Math.cos(m),p=0===(d&1)?b:c,m=-(0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-l*l):-Math.sqrt(1-l*l):Math.sin(m))*p,l=l*p,p=.5*(1+m*n),r=.5*(1+l*n);0===d&&(f=m,g=l);e.texCoord2(p,r).vertex2(m,l)}e.texCoord2(.5*
(1+f*n),.5*(1+g*n)).vertex2(f,g);return e};H3DU.Scene3D=function(a){var b=a;"function"===typeof a.getContext&&(b=HTMLCanvasElement&&b.constructor===HTMLCanvasElement?H3DU.get3DContext(a):H3DU._toContext(b));this.context=b;this.textureCache={};this._textureLoader=new H3DU.TextureLoader;this._meshLoader=new H3DU.BufferedMesh._MeshLoader;this._renderedOutsideScene=!1;this.shapes=[];this._errors=!1;this._frontFace=H3DU.Scene3D.CCW;this._cullFace=H3DU.Scene3D.NONE;this.clearColor=[0,0,0,1];this.fboFilter=null;this._subScene=new H3DU.Batch3D;this._subScene.getLights().setDefaults();
this._programs=new H3DU.Scene3D.ProgramCache;this.useDevicePixelRatio=!1;this._is3d=H3DU.is3DContext(this.context);this._pixelRatio=1;this.autoResize=!0;this.width=Math.ceil(1*this.context.canvas.clientWidth);this.height=Math.ceil(1*this.context.canvas.clientHeight);this.context.canvas.width=this.width;this.context.canvas.height=this.height;this._is3d&&(this._programs.getProgram(H3DU.Scene3D.LIGHTING_ENABLED|H3DU.Scene3D.SPECULAR_ENABLED|H3DU.Scene3D.SPECULAR_MAP_ENABLED,this.context),this.context.viewport(0,
0,this.width,this.height),this.context.enable(this.context.BLEND),this.context.blendFunc(this.context.SRC_ALPHA,this.context.ONE_MINUS_SRC_ALPHA),this.context.enable(this.context.DEPTH_TEST),this.context.depthFunc(this.context.LEQUAL),this.context.disable(this.context.CULL_FACE),this.context.clearDepth(1),this._setClearColor(),this._setFace())};H3DU.Scene3D.prototype.getCanvas=function(){return this.context?this.context.canvas:null};H3DU.Scene3D.LIGHTING_ENABLED=1;
H3DU.Scene3D.SPECULAR_MAP_ENABLED=2;H3DU.Scene3D.NORMAL_MAP_ENABLED=4;H3DU.Scene3D.SPECULAR_ENABLED=8;H3DU.Scene3D.TEXTURE_ENABLED=16;H3DU.Scene3D.COLORATTR_ENABLED=32;
H3DU.Scene3D._materialToFlags=function(a){var b;b=0|(a.basic?0:H3DU.Scene3D.LIGHTING_ENABLED);b|=0!==a.specular[0]||0!==a.specular[1]||0!==a.specular[2]?H3DU.Scene3D.SPECULAR_ENABLED:0;b|=a.specularMap?H3DU.Scene3D.SPECULAR_MAP_ENABLED:0;b|=a.normalMap?H3DU.Scene3D.NORMAL_MAP_ENABLED:0;return b|=a.texture?H3DU.Scene3D.TEXTURE_ENABLED:0};H3DU.Scene3D.ProgramCache=function(){this._programs=[];this._customPrograms=[]};
H3DU.Scene3D.ProgramCache.prototype.dispose=function(){var a,b;for(a=0;a<this._customPrograms.length;a++)b=this._customPrograms[a],b[2].dispose();for(a=0;a<this._programs.length;a++)(b=this._programs[a])&&b.dispose();this._customPrograms=[];this._programs=[]};
H3DU.Scene3D.ProgramCache.prototype.getCustomProgram=function(a,b){if(!b)throw Error();if(a instanceof H3DU.ShaderProgram)return a;for(var c=0;c<this._customPrograms.length;c++){var d=this._customPrograms[c];if(d[0]===a&&d[1]===b)return d[2]._update(),d[2]}c=H3DU.ShaderProgram._fromShaderInfo(b,a);this._customPrograms.push([a,b,c]);return c};
H3DU.Scene3D.ProgramCache.prototype.getProgram=function(a,b){if(!b)throw Error();var c=this._programs[a];if(c)for(var d=0;d<c.length;d++){if(c[d][0]===b)return c[d][1]}else this._programs[a]=[];c="";0!==(a&H3DU.Scene3D.LIGHTING_ENABLED)&&(c+="#define SHADING\n");0!==(a&H3DU.Scene3D.SPECULAR_ENABLED)&&(c+="#define SPECULAR\n");0!==(a&H3DU.Scene3D.NORMAL_MAP_ENABLED)&&(c+="#define NORMAL_MAP\n");0!==(a&H3DU.Scene3D.TEXTURE_ENABLED)&&(c+="#define TEXTURE\n");0!==(a&H3DU.Scene3D.COLORATTR_ENABLED)&&(c+=
"#define COLORATTR\n");0!==(a&H3DU.Scene3D.SPECULAR_MAP_ENABLED)&&(c+="#define SPECULAR_MAP\n#define SPECULAR\n");c=new H3DU.ShaderProgram(b,c+H3DU.ShaderProgram.getDefaultVertex(),c+H3DU.ShaderProgram.getDefaultFragment());this._programs[a].push([b,c]);return c};H3DU.Scene3D.prototype.getContext=function(){return this.context};H3DU.Scene3D.NONE=0;H3DU.Scene3D.BACK=1;H3DU.Scene3D.FRONT=2;H3DU.Scene3D.FRONT_AND_BACK=3;H3DU.Scene3D.CCW=0;H3DU.Scene3D.CW=1;
H3DU.Scene3D.prototype.cullFace=function(a){this._cullFace=a===H3DU.Scene3D.BACK||a===H3DU.Scene3D.FRONT||a===H3DU.Scene3D.FRONT_AND_BACK?a:0;return this};
H3DU.Scene3D.prototype._setFace=function(){if(this._is3d)return this._cullFace===H3DU.Scene3D.BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.BACK)):this._cullFace===H3DU.Scene3D.FRONT?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT)):this._cullFace===H3DU.Scene3D.FRONT_AND_BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT_AND_BACK)):this.context.disable(this.context.CULL_FACE),this._frontFace===
H3DU.Scene3D.CW?this.context.frontFace(this.context.CW):this.context.frontFace(this.context.CCW),this};H3DU.Scene3D.prototype.frontFace=function(a){this._frontFace=a===H3DU.Scene3D.CW?a:0;return this};H3DU.Scene3D.prototype.setAutoResize=function(a){this.autoResize=!!a;return this};
H3DU.Scene3D.prototype.setUseDevicePixelRatio=function(a){var b=!!this.useDevicePixelRatio;this._pixelRatio=(this.useDevicePixelRatio=!!a)&&window.devicePixelRatio?window.devicePixelRatio:1;b!==this.useDevicePixelRatio&&this.setDimensions(this.width,this.height);return this};H3DU.Scene3D.prototype.getClearColor=function(){return this.clearColor.slice(0,4)};H3DU.Scene3D.prototype.useProgram=function(){console.warn("The 'useProgram' method is obsolete.  Instead of this method, use the 'setShader' program of individual shapes to set the shader programs they use.")};
H3DU.Scene3D.prototype.setDimensions=function(a,b){if(0>a||0>b)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(b);this.context.canvas.width=this.width*this._pixelRatio;this.context.canvas.height=this.height*this._pixelRatio;this._is3d&&this.context.viewport(0,0,this.width*this._pixelRatio,this.height*this._pixelRatio);"undefined"!==typeof this.fbo&&this.fbo&&(this.fbo.dispose(),this.fbo=this.createBuffer(),this.fboQuad&&this.fboQuad.setMaterial(this.fbo))};
H3DU.Scene3D.prototype.getWidth=function(){return this.width};H3DU.Scene3D.prototype.getHeight=function(){return this.height};H3DU.Scene3D.prototype.getAspect=function(){var a=this.getHeight();return 0>=a?1:this.getWidth()/a};H3DU.Scene3D.prototype.getClientWidth=function(){return this.context.canvas.clientWidth};H3DU.Scene3D.prototype.getClientHeight=function(){return this.context.canvas.clientHeight};
H3DU.Scene3D.prototype.getClientAspect=function(){var a=this.getClientHeight();return 0>=a?1:this.getClientWidth()/a};H3DU.Scene3D.prototype.createBuffer=function(){return new H3DU.FrameBuffer(this.context,this.getWidth(),this.getHeight())};H3DU.Scene3D.prototype.getProjectionMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene._projectionMatrix.slice(0,16)};
H3DU.Scene3D.prototype.getViewMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._viewMatrix.slice(0,16)};H3DU.Scene3D.prototype.setPerspective=function(a,b,c,d){return this.setProjectionMatrix(H3DU.Math.mat4perspective(a,b,c,d))};
H3DU.Scene3D.prototype.setOrthoAspect=function(a,b,c,d,e,f,g){if(null===g||"undefined"===typeof g)g=this.getClientAspect();0===g&&(g=1);return this.setProjectionMatrix(H3DU.Math.mat4orthoAspect(a,b,c,d,e,f,g))};H3DU.Scene3D.prototype.setOrtho2DAspect=function(a,b,c,d,e){return this.setOrthoAspect(a,b,c,d,-1,1,e)};H3DU.Scene3D.prototype.setFrustum=function(a,b,c,d,e,f){return this.setProjectionMatrix(H3DU.Math.mat4frustum(a,b,d,c,e,f))};
H3DU.Scene3D.prototype.setOrtho=function(a,b,c,d,e,f){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,b,c,d,e,f))};H3DU.Scene3D.prototype.setOrtho2D=function(a,b,c,d){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,b,c,d,-1,1))};H3DU.Scene3D.prototype._setClearColor=function(){this._is3d&&this.context.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);return this};
H3DU.Scene3D.prototype.dispose=function(){this.context=null;this._programs&&this._programs.dispose();this._textureLoader&&this._textureLoader.dispose();this._meshLoader&&this._meshLoader.dispose();this._meshLoader=this._textureLoader=this._programs=null};H3DU.Scene3D.prototype.setClearColor=function(a,b,c,d){this.clearColor=H3DU.toGLColor(a,b,c,d);return this._setClearColor()};H3DU.Scene3D.prototype.loadTexture=function(a){return this._textureLoader.loadTexture(a)};
H3DU.Scene3D.prototype.loadAndMapTexture=function(a){var b=null;if(a.constructor===H3DU.Texture)return this.loadAndMapTexture(a.name);var b=this.loadTexture(a),c=this;return b.then(function(a){c._textureLoader.mapTexture(a,c);return a})};H3DU.Scene3D.prototype.loadAndMapTextures=function(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(this.loadAndMapTexture(a[e]));return H3DU.getPromiseResults(d,b,c)};
H3DU.Scene3D.prototype.clear=function(){this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT|this.context.STENCIL_BUFFER_BIT);return this};H3DU.Scene3D.prototype.clearDepth=function(){this._is3d&&this.context.clear(this.context.DEPTH_BUFFER_BIT);return this};H3DU.Scene3D.prototype.vertexCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.vertexCount()};
H3DU.Scene3D.prototype.primitiveCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.primitiveCount()};H3DU.Scene3D.prototype.setProjectionMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setProjectionMatrix(a);return this};
H3DU.Scene3D.prototype.setViewMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setViewMatrix(a);return this};H3DU.Scene3D.prototype.setLookAt=function(a,b,c){return this.setViewMatrix(H3DU.Math.mat4lookat(a,b,c))};
H3DU.Scene3D.prototype.addShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.addShape(a);return this};H3DU.Scene3D.prototype.makeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return new H3DU.Shape(a)};
H3DU.Scene3D.prototype.removeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.removeShape(a);return this};H3DU.Scene3D.prototype.getLights=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.getLights()};
H3DU.Scene3D.prototype.setDirectionalLight=function(a,b,c,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setDirectionalLight(a,b,c,d);return this};H3DU.Scene3D.prototype.setLightParams=function(a,b){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setParams(a,b);return this};
H3DU.Scene3D.prototype.setAmbient=function(a,b,c,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setAmbient(a,b,c,d);return this};H3DU.Scene3D.prototype.setPointLight=function(a,b,c,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setPointLight(a,b,c,d);return this};
H3DU.Scene3D.prototype._clearForPass=function(a){var b=0;a.clearColor&&(b|=this.context.COLOR_BUFFER_BIT);a.clearDepth&&(b|=this.context.DEPTH_BUFFER_BIT);a.clearStencil&&(b|=this.context.STENCIL_BUFFER_BIT);this._is3d&&0!==b&&this.context.clear(b)};
H3DU.Scene3D.prototype.render=function(a){if(a instanceof H3DU.Batch3D)return this.render([new H3DU.RenderPass3D(a)]);if(this.autoResize){var b=this.context.canvas;b.height===Math.ceil(b.clientHeight)*this._pixelRatio&&b.width===Math.ceil(b.clientWidth)*this._pixelRatio||this.setDimensions(b.clientWidth,b.clientHeight)}this._setFace();var b=this.getClientWidth(),c=this.getClientHeight();if(null===a||"undefined"===typeof a)this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT),
this._subScene.resize(b,c),this._subScene.render(this);else{this._renderedOutsideScene=!0;for(var d=0;d<a.length;d++){var e=a[d];this._textureLoader.bindFrameBuffer(e.frameBuffer,this.context);this._clearForPass(e);a[d].subScene.resize(b,c);a[d].subScene.render(this);this._textureLoader.unbindFrameBuffer(e.frameBuffer,this.context)}}this._is3d&&this.context.flush();return this};
H3DU.Scene3D.prototype.useFilter=function(){console.warn("The useFilter method has no effect. Use the {@link H3DU.Batch3D.forFilter} method to create a batch for rendering filter effects from a frame buffer.");return this};H3DU.Scene3D.supportsDerivatives=function(a){a=a.getContext?a.getContext():a;return a.getExtension("OES_standard_derivatives")?!0:!1};H3DU.Lights=function(){this.lights=[];this.sceneAmbient=[.2,.2,.2]};H3DU.Lights.prototype.setDefaults=function(){this.lights=[(new H3DU.LightSource).setParams({ambient:[0,0,0,1],position:[0,0,1,0],diffuse:[1,1,1,1],specular:[1,1,1],radius:0})];this.sceneAmbient=[.2,.2,.2];return this};H3DU.Lights.MAX_LIGHTS=3;H3DU.Lights._createNewLight=function(a){var b=new H3DU.LightSource;0!==a&&(b.diffuse=[0,0,0,0],b.specular=[0,0,0]);return b};H3DU.Lights.prototype.getCount=function(){return this.lights.length};
H3DU.Lights.prototype.getLight=function(a){var b=this.lights.length;this.lights[a]||(this.lights[a]=H3DU.Lights._createNewLight(a));if(2<=this.lights.length-b)for(;b<this.lights.length;b++)this.lights[b]||(this.lights[b]=H3DU.Lights._createNewLight(b));return this.lights[a]};H3DU.Lights.prototype.setParams=function(a,b){this.getLight(a).setParams(b);return this};
H3DU.Lights.prototype.setDirectionalLight=function(a,b,c,d){b=this.setParams(a,{position:[b[0],b[1],b[2],0]});null!==c&&"undefined"!==typeof c&&(b=b.setParams(a,{diffuse:c}));null!==d&&"undefined"!==typeof d&&(b=b.setParams(a,{specular:d}));return b};H3DU.Lights.prototype.setPointLight=function(a,b,c,d){b=this.setParams(a,{position:[b[0],b[1],b[2],1]});null!==c&&"undefined"!==typeof c&&(b=b.setParams(a,{diffuse:c}));null!==d&&"undefined"!==typeof d&&(b=b.setParams(a,{specular:d}));return b};
H3DU.Lights.prototype.setAmbient=function(a,b,c,d){this.sceneAmbient=H3DU.toGLColor(a,b,c,d);return this};H3DU.Batch3D=function(){this._projectionMatrix=H3DU.Math.mat4identity();this._viewMatrix=H3DU.Math.mat4identity();this.lights=new H3DU.Lights;this._frustum=this._projectionUpdater=null;this.shapes=[]};H3DU.Batch3D._PerspectiveView=function(a,b,c,d){this.fov=b;this.near=c;this.far=d;this.scene=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c!==this.lastAspect&&(this.lastAspect=c,this.scene.setProjectionMatrix(H3DU.Math.mat4perspective(this.fov,c,this.near,this.far)))};this.update()};
H3DU.Batch3D._OrthoView=function(a,b,c,d,e,f,g){this.a=b;this.b=c;this.c=d;this.d=e;this.e=f;this.f=g;this.scene=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c!==this.lastAspect&&(this.lastAspect=c,this.scene.setProjectionMatrix(H3DU.Math.mat4orthoAspect(this.a,this.b,this.c,this.d,this.e,this.f,c)))};this.update()};
H3DU.Batch3D._setupMatrices=function(a,b,c,d,e){var f={};e&&(f.view=c,f.projection=b,f.viewMatrix=c,f.projectionMatrix=b,e=a.get("projView"),null!==e&&"undefined"!==typeof e&&(b=H3DU.Math.mat4multiply(b,c),f.projView=b));b=H3DU.Math.mat4inverseTranspose3(d);f.world=d;f.modelMatrix=d;f.normalMatrix=b;b=a.get("modelViewMatrix");null!==b&&"undefined"!==typeof b&&(H3DU._isIdentityExceptTranslate(c)?(d=d.slice(0,16),d[12]+=c[12],d[13]+=c[13],d[14]+=c[14]):d=H3DU.Math.mat4multiply(c,d),f.modelViewMatrix=
d,b=H3DU.Math.mat4inverseTranspose3(d),f.world=d,f.modelMatrix=d,f.normalMatrix=b);a.setUniforms(f)};H3DU.Batch3D._isSameMatrix=function(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]&&a[6]===b[6]&&a[7]===b[7]&&a[8]===b[8]&&a[9]===b[9]&&a[10]===b[10]&&a[11]===b[11]&&a[12]===b[12]&&a[13]===b[13]&&a[14]===b[14]&&a[15]===b[15]};
H3DU.Batch3D.prototype.setProjectionMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._projectionMatrix,a)||(this._projectionMatrix=a.slice(0,16),this._frustum=null);return this};H3DU.Batch3D.prototype.perspectiveAspect=function(a,b,c){this._projectionUpdater=new H3DU.Batch3D._PerspectiveView(this,a,b,c);return this};H3DU.Batch3D.prototype.setLookAt=function(a,b,c){return this.setViewMatrix(H3DU.Math.mat4lookat(a,b,c))};
H3DU.Batch3D.prototype.orthoAspect=function(a,b,c,d,e,f){this._projectionUpdater=new H3DU.Batch3D._OrthoView(this,a,b,c,d,e,f);return this};H3DU.Batch3D.prototype.ortho2DAspect=function(a,b,c,d){return this.orthoAspect(a,b,c,d,-1,1)};H3DU.Batch3D.prototype.setViewMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._viewMatrix,a)||(this._viewMatrix=a.slice(0,16),this._frustum=null);return this};H3DU.Batch3D.prototype.getProjectionMatrix=function(){return this._projectionMatrix.slice(0,16)};
H3DU.Batch3D.prototype.getViewMatrix=function(){return this._viewMatrix.slice(0,16)};H3DU.Batch3D.prototype._getFrustum=function(){if("undefined"===typeof this._frustum||null===this._frustum){var a=H3DU.Math.mat4multiply(this._projectionMatrix,this._viewMatrix);this._frustum=H3DU.Math.mat4toFrustumPlanes(a)}return this._frustum};H3DU.Batch3D.prototype.getLights=function(){return this.lights};H3DU.Batch3D.prototype.addShape=function(a){a.parent=null;this.shapes.push(a);return this};
H3DU.Batch3D.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};H3DU.Batch3D.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};H3DU.Batch3D.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};
H3DU.Batch3D.prototype._renderShape=function(a,b){if(a.constructor===H3DU.ShapeGroup){if(a.visible)for(var c=0;c<a.shapes.length;c++)this._renderShape(a.shapes[c],b)}else if(a.visible&&!a.isCulled(this._getFrustum())){var c=null,d=0;a.material instanceof H3DU.Material&&(a.material.shader&&(c=b.scene._programs.getCustomProgram(a.material.shader,b.context)),d=H3DU.Scene3D._materialToFlags(a.material));a._hasColorAttr()&&(d|=H3DU.Scene3D.COLORATTR_ENABLED);if(null===c||"undefined"===typeof c)c=b.scene._programs.getProgram(d,
b.context);d=!1;b.prog!==c&&(c.use(),d=!0,(new H3DU._LightsBinder(this.lights)).bind(c,this._viewMatrix),b.prog=c);H3DU.Batch3D._setupMatrices(c,this._projectionMatrix,this._viewMatrix,a.getMatrix(),d);H3DU.Batch3D._getMaterialBinder(a.material).bind(c,b.context,b.scene._textureLoader);b.scene._meshLoader.draw(a.meshBuffer,c)}};H3DU.Batch3D.prototype.resize=function(a,b){this._projectionUpdater&&this._projectionUpdater.update(a,b)};
H3DU.Batch3D.prototype.render=function(a){var b={};b.scene=a;b.context=a.getContext();for(a=0;a<this.shapes.length;a++)this._renderShape(this.shapes[a],b);return this};H3DU.Batch3D.forFilter=function(a,b,c){if(null===c||"undefined"===typeof c)c=H3DU.ShaderProgram.makeCopyEffect(a);a=new H3DU.Batch3D(a);var d=new H3DU.Mesh([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0],[0,1,2,2,1,3],H3DU.Mesh.TEXCOORDS_BIT),d=new H3DU.Shape(d);d.setTexture(b);d.setShader(c);a.addShape(d);return a};
H3DU.Batch3D._getMaterialBinder=function(a){return a&&a instanceof H3DU.Material?new H3DU._MaterialBinder(a):{}};H3DU.Material=function(a,b,c,d,e){null!==a&&"undefined"!==typeof a&&(a=H3DU.toGLColor(a));null!==b&&"undefined"!==typeof b&&(b=H3DU.toGLColor(b));null!==c&&"undefined"!==typeof c&&(c=H3DU.toGLColor(c));null!==e&&"undefined"!==typeof e&&(e=H3DU.toGLColor(e));this.shininess=null===d||"undefined"===typeof d?0:Math.min(Math.max(0,d),128);this.ambient=a?a.slice(0,3):[.2,.2,.2];this.diffuse=b?b.slice(0,b.length):[.8,.8,.8,1];this.specular=c?c.slice(0,3):[0,0,0];this.emission=e?e.slice(0,3):[0,0,0];this.normalMap=
this.specularMap=this.texture=null;this.basic=!1;this.shader=null};H3DU.Material.prototype.copy=function(){return(new H3DU.Material(this.ambient.slice(0,this.ambient.length),this.diffuse.slice(0,this.diffuse.length),this.specular.slice(0,this.specular.length),this.shininess,this.emission.slice(0,this.emission.length))).setParams({texture:this.texture,specularMap:this.specularMap,normalMap:this.normalMap,basic:this.basic,shader:this.shader})};
H3DU.Material.prototype.setParams=function(a){var b;"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),3<this.ambient.length&&(this.ambient=this.ambient.slice(0,3)));"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse),4<this.diffuse.length&&(this.diffuse=this.diffuse.slice(0,4)));"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular),3<this.specular.length&&(this.specular=this.specular.slice(0,
3)));"undefined"!==typeof a.emission&&null!==a.emission&&(this.emission=H3DU.toGLColor(a.emission),3<this.emission.length&&(this.emission=this.emission.slice(0,3)));"undefined"!==typeof a.shininess&&null!==a.shininess&&(this.shininess=a.shininess);"undefined"!==typeof a.texture&&null!==a.texture&&(b=a.texture,this.texture="string"===typeof b?new H3DU.Texture(b):b);"undefined"!==typeof a.specularMap&&null!==a.specularMap&&(b=a.specularMap,this.specularMap="string"===typeof b?new H3DU.Texture(b):b);
"undefined"!==typeof a.normalMap&&null!==a.normalMap&&(b=a.normalMap,this.normalMap="string"===typeof b?new H3DU.Texture(b):b);"undefined"!==typeof a.basic&&null!==a.basic&&(this.basic=a.basic);"undefined"!==typeof a.shader&&null!==a.shader&&(this.shader=a.shader);return this};H3DU.Material.fromColor=function(a,b,c,d){a=H3DU.toGLColor(a,b,c,d);return new H3DU.Material(a,a)};H3DU.Material.fromTexture=function(a){return(new H3DU.Material).setParams({texture:a})};H3DU.Material.forShader=function(a){return(new H3DU.Material).setParams({shader:a})};H3DU.FrameBufferInfo=function(a,b){if(0>a||0>b)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(b)};H3DU.FrameBufferInfo.prototype.resize=function(a,b){if(0>a||0>b)throw Error("width or height negative");a=Math.ceil(a);b=Math.ceil(b);this.width=a;this.height=b};H3DU.FrameBufferInfo.prototype.getWidth=function(){return this.width};H3DU.FrameBufferInfo.prototype.getHeight=function(){return this.height};H3DU._MaterialBinder=function(a){this.mshade=a};H3DU._MaterialBinder._textureSizeZeroZero=[0,0];
H3DU._MaterialBinder.prototype.bind=function(a,b,c){if(!this.mshade)return this;var d={textureSize:H3DU._MaterialBinder._textureSizeZeroZero,md:4===this.mshade.diffuse.length?this.mshade.diffuse:[this.mshade.diffuse[0],this.mshade.diffuse[1],this.mshade.diffuse[2],4>this.mshade.diffuse.length?1:this.mshade.diffuse[3]]};this.mshade.basic||(d.mshin=this.mshade.shininess,d.ma=3===this.mshade.ambient.length?this.mshade.ambient:[this.mshade.ambient[0],this.mshade.ambient[1],this.mshade.ambient[2]],d.ms=
3===this.mshade.specular.length?this.mshade.specular:[this.mshade.specular[0],this.mshade.specular[1],this.mshade.specular[2]],d.me=3===this.mshade.emission.length?this.mshade.emission:[this.mshade.emission[0],this.mshade.emission[1],this.mshade.emission[2]]);a.setUniforms(d);H3DU._MaterialBinder.bindTexture(this.mshade.texture,b,a,0,c);H3DU._MaterialBinder.bindTexture(this.mshade.specularMap,b,a,1,c);H3DU._MaterialBinder.bindTexture(this.mshade.normalMap,b,a,2,c);return this};
H3DU._LoadedTexture=function(a,b){this.context=b=H3DU._toContext(b);this.loadedTexture=b.createTexture();b.activeTexture(b.TEXTURE0);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,1);b.bindTexture(b.TEXTURE_2D,this.loadedTexture);"src"in a.image?b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a.image):b.texImage2D(b.TEXTURE_2D,0,b.RGBA,a.getWidth(),a.getHeight(),0,b.RGBA,b.UNSIGNED_BYTE,a.image);H3DU._isPowerOfTwo(a.getWidth())&&H3DU._isPowerOfTwo(a.getHeight())?b.generateMipmap(b.TEXTURE_2D):(b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE))};H3DU._LoadedTexture.prototype.dispose=function(){this.loadedTexture&&this.context.deleteTexture(this.loadedTexture)};
H3DU._MaterialBinder.bindTexture=function(a,b,c,d,e){if(null!==a&&"undefined"!==typeof a){var f=a instanceof H3DU.FrameBufferInfo;if(!(f||a instanceof H3DU.Texture))throw Error("unsupported texture type");var g=null;if(f)a=e.mapFrameBuffer(a,b);else if("undefined"!==typeof a.image&&null!==a.image||0!==a.loadStatus)g=e.mapTexture(a,b);else{var h=this;a.loadImage().then(function(){h.bind(c)});return}if(null!==g&&"undefined"!==typeof g||f){var k={};0===d&&(k.sampler=d,k.textureSize=[a.getWidth(),a.getHeight()]);
1===d&&(k.specularMap=d);2===d&&(k.normalMap=d);c.setUniforms(k);b.activeTexture(b.TEXTURE0+d);f?(b.bindTexture(b.TEXTURE_2D,a.colorTexture),a.colorTexture&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE))):(b.bindTexture(b.TEXTURE_2D,g.loadedTexture),e._setMaxAnisotropy(b),b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MAG_FILTER,b.LINEAR),d=b.CLAMP_TO_EDGE,H3DU._isPowerOfTwo(a.getWidth())&&H3DU._isPowerOfTwo(a.getHeight())?(a.clamp||(d=b.REPEAT),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_LINEAR)):b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,d),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,d))}}};H3DU._LightsBinder=function(a){this.lights=a};H3DU._LightsBinder.emptyW1=[0,0,0,1];H3DU._LightsBinder.emptyW0=[0,0,0,0];
H3DU._LightsBinder.emptyAtten=[1,0,0,0];
H3DU._LightsBinder.prototype.bind=function(a,b){var c,d=this.lights;if(!d||!a)return this;var e={};e.sceneAmbient=3===d.sceneAmbient.length?d.sceneAmbient:d.sceneAmbient.slice(0,3);for(var f=0;f<d.lights.length;f++){var g=d.lights[f];c="lights["+f+"]";e[c+".diffuse"]=4===g.diffuse.length?g.diffuse:[g.diffuse[0],g.diffuse[1],g.diffuse[2],1];e[c+".specular"]=4===g.specular.length?g.specular:[g.specular[0],g.specular[1],g.specular[2],1];var h=H3DU.Math.mat4transform(b,d.lights[f].position);e[c+".position"]=
h;e[c+".radius"]=[Math.max(0,g.radius*g.radius*g.radius*g.radius),0,0,0]}for(f=d.lights.length;f<H3DU.Lights.MAX_LIGHTS;f++)c="lights["+f+"]",e[c+".diffuse"]=H3DU._LightsBinder.emptyW1,e[c+".specular"]=H3DU._LightsBinder.emptyW1,e[c+".position"]=H3DU._LightsBinder.emptyW0,e[c+".radius"]=H3DU._LightsBinder.emptyW0;a.setUniforms(e);return this};H3DU.Shape=function(a){if(null===a||"undefined"===typeof a)throw Error("mesh is null");a instanceof H3DU.Mesh?this.meshBuffer=new H3DU.MeshBuffer(a):a instanceof H3DU.BufferedMesh?(H3DU.Shape._meshBufferWarning||(console.warn("Using an H3DU.BufferedMesh in H3DU.Shape objects is deprecated."),H3DU.Shape._meshBufferWarning=!0),this.meshBuffer=a._toMeshBuffer()):this.meshBuffer=a;if(!(this.meshBuffer instanceof H3DU.MeshBuffer))throw Error("Unsupported data type for mesh parameter (must be MeshBuffer)");
this.transform=new H3DU.Transform;this.material=new H3DU.Material;this.parent=null;this.visible=!0};H3DU.Shape.prototype._hasColorAttr=function(){return!!this.meshBuffer._getAttribute("colorAttr")};H3DU.Shape._meshBufferWarning=!1;H3DU.Shape.prototype.vertexCount=function(){return this.meshBuffer?this.meshBuffer.vertexCount():0};H3DU.Shape.prototype.primitiveCount=function(){return this.meshBuffer?this.meshBuffer.primitiveCount():0};H3DU.Shape.prototype.setVisible=function(a){this.visible=!!a;return this};
H3DU.Shape.prototype.getVisible=function(){return this.visible};H3DU.Shape.prototype.setColor=function(a,b,c,d){a=H3DU.toGLColor(a,b,c,d);return this.setMaterialParams({ambient:a,diffuse:a})};H3DU.Shape.prototype.setTexture=function(a){return this.setMaterialParams({texture:a})};H3DU.Shape.prototype.setShader=function(a){return this.setMaterialParams({shader:a})};
H3DU.Shape.prototype.setMaterialParams=function(a){this.material?this.material.setParams(a):this.material=(new H3DU.Material).setParams(a);return this};H3DU.Shape.prototype.setTextureAndColor=function(a,b,c,d,e){b=H3DU.toGLColor(b,c,d,e);return this.setMaterialParams({texture:a,ambient:b,diffuse:b})};H3DU.Shape.prototype.setMaterial=function(a){this.material=a;return this};
H3DU.Shape.prototype.copy=function(){var a=new H3DU.Shape(this.meshBuffer);a.visible=this.visible;a.parent=null;a.material=this.material.copy();a.transform=this.getTransform().copy();return a};H3DU.Shape.prototype.getTransform=function(){return this.transform};
H3DU.Shape.prototype.getBounds=function(){if(!this.meshBuffer){var a=Number.POSITIVE_INFINITY;return[a,a,a,-a,-a,-a]}var b=this.meshBuffer.getBounds();if(H3DU.Math.boxIsEmpty(b))return b;var c=this.getMatrix();if(H3DU.Math.mat4isIdentity(c))return b.slice(0,6);a=H3DU.Math.mat4projectVec3(c,b[0],b[1],b[2]);b=H3DU.Math.mat4projectVec3(c,b[3],b[4],b[5]);return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2]),Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2])]};
H3DU.Shape.prototype.isCulled=function(a){return this.meshBuffer&&this.visible?!H3DU.Math.frustumHasBox(a,this.getBounds()):!0};H3DU.Shape.prototype.setTransform=function(a){this.transform=a.copy();return this};H3DU.Shape.prototype.setScale=function(a,b,c){this.getTransform().setScale(a,b,c);return this};H3DU.Shape.prototype.setPosition=function(a,b,c){this.getTransform().setPosition(a,b,c);return this};H3DU.Shape.prototype.setQuaternion=function(a){this.getTransform().setQuaternion(a);return this};
H3DU.Shape.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if("undefined"===typeof this.parent||null===this.parent)a=a.getMatrix();else var c=this.parent.getMatrix(),a=b?c:H3DU.Math.mat4isIdentity(c)?a.getMatrix():H3DU.Math.mat4multiply(c,a.getMatrix());return a};H3DU.FrameBufferLoader=function(){this._frameBuffers=[]};H3DU.FrameBufferLoader.prototype.mapFrameBuffer=function(a,b){for(var c,d=0;d<this._frameBuffers.length;d++)if(c=this._frameBuffers[d],c[0]===a&&c[1]===b)return c[2];c=new H3DU.FrameBuffer(b,a.width,a.height);this._frameBuffers.push([a,b,c]);return c};H3DU.FrameBufferLoader.prototype.dispose=function(){for(var a=0;a<this._frameBuffers.length;a++)this._frameBuffers[a][2].dispose();this._frameBuffers=[]};
H3DU.FrameBufferLoader.prototype.bind=function(a,b){if(null!==a&&"undefined"!==typeof a){var c=this.mapFrameBuffer(a,b);b.activeTexture(b.TEXTURE0+c.textureUnit);b.bindFramebuffer(b.FRAMEBUFFER,c.buffer);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,c.colorTexture,0);b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,c.depthbuffer)}};
H3DU.FrameBufferLoader.prototype.unbind=function(a,b){null!==a&&"undefined"!==typeof a&&(b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,null,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null))};H3DU.FrameBuffer=function(a,b,c){if(0>b||0>c)throw Error("width or height negative");this.context=a=a.getContext?a.getContext():a;this.textureUnit=3;this._init(a,b,c)};
H3DU.FrameBuffer.prototype._init=function(a,b,c){this.buffer=a.createFramebuffer();this.colorTexture=a.createTexture();this.width=Math.ceil(b);this.height=Math.ceil(c);this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindTexture(this.context.TEXTURE_2D,this.colorTexture);this.context.pixelStorei(this.context.UNPACK_FLIP_Y_WEBGL,1);this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.width,this.height,0,this.context.RGBA,this.context.UNSIGNED_BYTE,
null);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE);this.depthbuffer=this.context.createRenderbuffer();b=this.context.getParameter(a.FRAMEBUFFER_BINDING);
this.context.bindFramebuffer(a.FRAMEBUFFER,this.buffer);this.context.bindRenderbuffer(a.RENDERBUFFER,this.depthbuffer);this.context.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height);this.context.bindFramebuffer(a.FRAMEBUFFER,b)};H3DU.FrameBuffer.prototype.resize=function(a,b){a=Math.ceil(a);b=Math.ceil(b);if(a!==this.width||b!==this.height)this.dispose(),this._init(this.context,a,b);return this};H3DU.FrameBuffer.prototype.getWidth=function(){return this.width};
H3DU.FrameBuffer.prototype.getHeight=function(){return this.height};H3DU.FrameBuffer.prototype.getContext=function(){return this.context};H3DU.FrameBuffer.prototype.bind=function(){console.log("FrameBuffer bind method has no effect.");return this};H3DU.FrameBuffer.prototype.unbind=function(){console.log("FrameBuffer unbind method has no effect.")};
H3DU.FrameBuffer.prototype.dispose=function(){"undefined"!==typeof this.buffer&&null!==this.buffer&&(this.context.getParameter(this.context.FRAMEBUFFER_BINDING)===this.buffer&&this.unbind(),this.context.deleteFramebuffer(this.buffer));"undefined"!==typeof this.depthbuffer&&null!==this.depthbuffer&&this.context.deleteRenderbuffer(this.depthbuffer);"undefined"!==typeof this.colorTexture&&null!==this.colorTexture&&this.context.deleteTexture(this.colorTexture);this.colorTexture=this.depthbuffer=this.buffer=
null};(function(a){H3DU.BezierCurve=function(a,c,d){if("undefined"===typeof c&&"undefined"===typeof d)this.uoffset=0,this.umul=1;else{if(c===d)throw Error("u1 and u2 can't be equal");this.uoffset=c;this.umul=1/(d-c)}this.evaluator=H3DU.BSplineCurve.clamped(a,a.length-1)};H3DU.BezierCurve.prototype.evaluate=function(a){return this.evaluator.evaluate((a-this.uoffset)*this.umul)};H3DU.BezierSurface=function(a,c,d,e,f){if("undefined"===typeof c&&"undefined"===typeof d&&"undefined"===typeof e&&"undefined"===
typeof f)this.uoffset=0,this.umul=1,this.voffset=0,this.vmul=1;else{if(c===d)throw Error("u1 and u2 can't be equal");if(e===f)throw Error("v1 and v2 can't be equal");this.uoffset=c;this.umul=1/(d-c);this.voffset=e;this.vmul=1/(f-e)}this.evaluator=H3DU.BSplineSurface.clamped(a,a[0].length-1,a.length-1)};H3DU.BezierSurface.prototype.evaluate=function(a,c){return this.evaluator.evaluate((a-this.uoffset)*this.umul,(c-this.voffset)*this.vmul)};H3DU.BSplineCurve=function(a,c,d){if(0>=a.length)throw Error();
if(!c)throw Error();this.bits=d||0;d=c.length-a.length;if(2>d||d>a.length)throw Error();H3DU.BSplineCurve._checkKnots(c);this.cplen=a[0].length;d=1;0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.DIVIDE_BIT))&&(d=2);0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)&&this.cplen--;if(this.cplen<d)throw Error();this.knots=c;this.buffer=[];this.controlPoints=a};H3DU.BSplineCurve.WEIGHTED_BIT=1;H3DU.BSplineCurve.DIVIDE_BIT=2;H3DU.BSplineCurve.HOMOGENEOUS_BIT=4;H3DU.BSplineCurve.WEIGHTED_DIVIDE_BITS=
3;H3DU.BSplineCurve._checkKnots=function(a){for(var b=1;b<a.length;b++)if(a[b]<a[b-1])throw Error();if(a[0]===a[a.length-1])throw Error();};H3DU.BSplineCurve._getFactors=function(a,c,d,e,f){for(var b=0;b<e;b++)f[b]=0;if(c===a[0])f[0]=1;else if(c===a[a.length-1])f[e-1]=1;else{for(var h=-1,b=0;b<=a.length;b++)if(a[b]<=c&&c<a[b+1]){h=b;break}if(!(0>h)){var k=[];e=h-1;k[h]=1;for(var n=2;n<=d;n++,e--){for(b=e;b<=h;b++){var m=0,l,p=b<=e?0:k[b],r=b>=h?0:k[b+1];0!==p&&(l=a[b+n-1]-a[b],m+=0===l?0:p*(c-a[b])/
l);0!==r&&(p=a[b+n],l=p-a[b+1],m+=0===l?0:r*(p-c)/l);f[b]=m}if(n<d)for(b=e;b<=h;b++)k[b]=f[b]}}}};H3DU.BSplineCurve.prototype.evaluate=function(a){var b=this.controlPoints.length,d=this.knots.length-b;a=this.knots[d-1]+a*(this.knots[b]-this.knots[d-1]);H3DU.BSplineCurve._getFactors(this.knots,a,d,b,this.buffer);a=[];var e,f;if(0===(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)){a=[];for(d=0;d<this.cplen;d++){for(e=f=0;e<b;e++)f+=this.controlPoints[e][d]*this.buffer[e];a[d]=f}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(d=
0;d<this.cplen-1;d++)a[d]/=a[this.cplen-1];a=a.slice(0,this.cplen-1)}}else{var g=0;for(e=0;e<b;e++)g+=this.buffer[e]*this.controlPoints[e][this.cplen];for(var h=0!==(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT),d=0;d<this.cplen+1;d++){for(e=f=0;e<b;e++){var k=this.buffer[e];h||(k*=this.controlPoints[e][this.cplen]);f+=this.controlPoints[e][d]*k}a[d]=f/g}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(d=0;d<this.cplen;d++)a[d]/=a[this.cplen];a=a.slice(0,this.cplen)}}return a};H3DU.BSplineSurface=
function(a,c,d,e){var b=a.length;if(0>=b)throw Error();var g=a[0].length;if(0>=g)throw Error();var h=a[0][0].length,k=1;this.bits=e||0;0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.DIVIDE_BIT))&&(k=2);0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.HOMOGENEOUS_BIT))&&h--;if(h<k)throw Error();if(!c||!d)throw Error();this.orderU=c.length-g;this.orderV=d.length-b;this.vcplen=b;this.ucplen=g;this.cplen=h;if(2>this.orderU||this.orderU>g)throw Error();if(2>this.orderV||
this.orderV>b)throw Error();H3DU.BSplineCurve._checkKnots(c);H3DU.BSplineCurve._checkKnots(d);this.knotsU=c;this.knotsV=d;this.bufferU=[];this.bufferV=[];this.controlPoints=a};H3DU.BSplineCurve.clamped=function(a,c,d){return new H3DU.BSplineCurve(a,H3DU.BSplineCurve.clampedKnots(a.length,c),d)};H3DU.BSplineCurve.uniform=function(a,c,d){return new H3DU.BSplineCurve(a,H3DU.BSplineCurve.uniformKnots(a.length,c),d)};H3DU.BSplineSurface.clamped=function(a,c,d,e){return new H3DU.BSplineSurface(a,H3DU.BSplineCurve.clampedKnots(a[0].length,
c),H3DU.BSplineCurve.clampedKnots(a.length,d),e)};H3DU.BSplineSurface.uniform=function(a,c,d,e){return new H3DU.BSplineSurface(a,H3DU.BSplineCurve.uniformKnots(a[0].length,c),H3DU.BSplineCurve.uniformKnots(a.length,d),e)};H3DU.BSplineCurve.uniformKnots=function(a,c){"object"===typeof a&&(a=a.length);if(null===c||"undefined"===typeof c)c=3;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var b=c+1,e=[],f=0;f<a+b;f++)e.push(f);return e};H3DU.BSplineCurve.clampedKnots=function(a,
c){"object"===typeof a&&(a=a.length);if(null===c||"undefined"===typeof c)c=3;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var b=c+1,e=a-b,f=[],g=0;g<b;g++)f.push(0);for(g=0;g<e;g++)f.push(g+1);for(g=0;g<b;g++)f.push(e+1);return f};H3DU.BSplineSurface.prototype.evaluate=function(a,c){a=this.knotsU[this.orderU-1]+a*(this.knotsU[this.ucplen]-this.knotsU[this.orderU-1]);c=this.knotsV[this.orderV-1]+c*(this.knotsV[this.vcplen]-this.knotsV[this.orderV-1]);var b=this.bufferU,
e=this.bufferV,f,g,h,k,n;H3DU.BSplineCurve._getFactors(this.knotsU,a,this.orderU,this.ucplen,this.bufferU);H3DU.BSplineCurve._getFactors(this.knotsV,c,this.orderV,this.vcplen,this.bufferV);var m=[];if(0===(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)){for(k=0;k<this.cplen;k++){for(f=n=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)n+=this.controlPoints[g][f][k]*b[f]*e[g];m[k]=n}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(k=0;k<this.cplen-1;k++)m[k]/=m[this.cplen-1];m=m.slice(0,this.cplen-1)}}else{var l=
0,p=0!==(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT);for(f=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)h=b[f]*e[g]*this.controlPoints[g][f][this.cplen],l+=h;for(k=0;k<this.cplen+1;k++){for(f=l=n=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)h=b[f]*e[g],p||(h*=this.controlPoints[g][f][this.cplen]),n+=this.controlPoints[g][f][k]*h;m[k]=0===l?n:n/l}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(k=0;k<this.cplen;k++)m[k]/=m[this.cplen];m=m.slice(0,this.cplen)}}return m};H3DU.CurveEval=function(){this.vertexCurve=
this.texCoordCurve=this.normalCurve=this.colorCurve=null};H3DU.CurveEval.prototype.vertex=function(a){this.vertexCurve=a;return this};H3DU.CurveEval.prototype.normal=function(a){this.normalCurve=a;return this};H3DU.CurveEval.prototype.color=function(a){this.colorCurve=a;return this};H3DU.CurveEval.prototype.texCoord=function(a){this.texCoordCurve=a;return this};H3DU.CurveEval.prototype.evalOne=function(a,c){var b=null,e=null,f=null;if(!this.texCoordCurve&&!this.normalCurve)return this._evalOneSimplified(a,
c);this.colorCurve&&(b=this.colorCurve.evaluate(c));this.texCoordCurve&&(f=this.texCoordCurve.evaluate(c),1===f.length&&f.push(0));this.normalCurve&&(e=this.normalCurve.evaluate(c));if(this.vertexCurve){var g=b?a.color.slice(0,3):null,h=e?a.normal.slice(0,3):null,k=f?a.texCoord.slice(0,2):null;b&&a.color3(b[0],b[1],b[2]);e&&a.normal3(e[0],e[1],e[2]);f&&a.texCoord2(f[0],f[1]);b=this.vertexCurve.evaluate(c);2===b.length?a.vertex3(b[0],b[1],0):a.vertex3(b[0],b[1],b[2]);g&&a.color3(g[0],g[1],g[2]);h&&
a.normal3(h[0],h[1],h[2]);k&&a.texCoord2(k[0],k[1])}return this};H3DU.CurveEval.prototype._evalOneSimplified=function(a,c){var b=null;this.colorCurve&&(b=this.colorCurve.evaluate(c));if(this.vertexCurve){var e=b?a.color.slice(0,3):null;b&&a.color3(b[0],b[1],b[2]);b=this.vertexCurve.evaluate(c);a.vertex3(b[0],b[1],2===b.length?0:b[2]);e&&a.color3(e[0],e[1],e[2])}return this};H3DU.CurveEval.prototype.evalCurve=function(a,c,d,e,f){"undefined"===typeof d&&(d=24);if(0>=d)throw Error("invalid n");"undefined"===
typeof e&&"undefined"===typeof f&&(e=0,f=1);if(null===c||"undefined"===typeof c)c=H3DU.Mesh.LINES;if(c===H3DU.Mesh.POINTS)a.mode(H3DU.Mesh.POINTS);else if(c===H3DU.Mesh.LINES)a.mode(H3DU.Mesh.LINE_STRIP);else return this;c=(f-e)/d;for(f=0;f<=d;f++)this.evalOne(a,e+f*c);return this};H3DU.SurfaceEval=function(){this.vertexSurface=this.texCoordSurface=this.normalSurface=this.colorSurface=null;this.autoNormal=!1};H3DU.SurfaceEval.prototype.setAutoNormal=function(a){this.autoNormal=!!a;return this};H3DU.SurfaceEval.prototype.vertex=
function(a){this.vertexSurface=a;return this};H3DU.SurfaceEval.prototype.normal=function(a){this.normalSurface=a;return this};H3DU.SurfaceEval.prototype.color=function(a){this.colorSurface=a;return this};H3DU.SurfaceEval.prototype.texCoord=function(a){this.texCoordSurface=a;return this};H3DU._OLD_VALUES_SIZE=8;H3DU._RECORDED_VALUES_SIZE=11;H3DU.SurfaceEval.prototype.evalOne=function(a,c,d){var b=[];this._saveValues(a,b,0);this._record(c,d,b,H3DU._OLD_VALUES_SIZE);this._playBack(a,b,H3DU._OLD_VALUES_SIZE);
this._restoreValues(a,b,0);return this};H3DU.SurfaceEval.prototype._recordAndPlayBack=function(a,c,d,e,f){this._record(c,d,e,f);this._playBack(a,e,f)};H3DU.SurfaceEval.prototype._saveValues=function(a,c,d){this.colorSurface&&(c[d+3]=a.color[0],c[d+4]=a.color[1],c[d+5]=a.color[2]);if(this.normalSurface||this.autoNormal)c[d+0]=a.normal[0],c[d+1]=a.normal[1],c[d+2]=a.normal[2];this.texCoordSurface&&(c[d+6]=a.texCoord[0],c[d+7]=a.texCoord[1])};H3DU.SurfaceEval.prototype._restoreValues=function(a,c,d){this.colorSurface&&
a.color3(c[d+3],c[d+4],c[d+5]);(this.normalSurface||this.autoNormal)&&a.normal3(c[d+0],c[d+1],c[d+2]);this.texCoordSurface&&a.texCoord2(c[d+6],c[d+7])};H3DU.SurfaceEval.prototype._record=function(a,c,d,e){var b;this.colorSurface&&(b=this.colorSurface.evaluate(a,c),d[e+6]=b[0],d[e+7]=b[1],d[e+8]=b[2]);this.texCoordSurface&&(b=this.texCoordSurface.evaluate(a,c),d[e+9]=b[0],d[e+10]=1>=b.length?0:b[1]);this.normalSurface&&!this.autoNormal&&(b=this.normalSurface.evaluate(a,c),d[e+3]=b[0],d[e+4]=b[1],d[e+
5]=b[2]);if(this.vertexSurface&&(b=this.vertexSurface.evaluate(a,c),d[e]=b[0],d[e+1]=b[1],d[e+2]=b[2],this.autoNormal)){var g=1E-5,h=1E-5,k=this.vertexSurface.evaluate(a+g,c);0===k[0]&&0===k[1]&&0===k[2]&&(g=-g,k=this.vertexSurface.evaluate(a+g,c));var n=this.vertexSurface.evaluate(a,c+h);0===n[0]&&0===n[1]&&0===n[2]&&(h=-h,n=this.vertexSurface.evaluate(a,c+h));H3DU.Math.vec3subInPlace(n,b);H3DU.Math.vec3subInPlace(k,b);H3DU.Math.vec3scaleInPlace(k,1/g);H3DU.Math.vec3scaleInPlace(n,1/h);H3DU.Math.vec3normInPlace(k);
H3DU.Math.vec3normInPlace(n);0===H3DU.Math.vec3length(k)?k=n:0===H3DU.Math.vec3length(n)&&k[2]===b[2]?k=[0,0,1]:0!==H3DU.Math.vec3length(n)&&(k=H3DU.Math.vec3cross(k,n),H3DU.Math.vec3normInPlace(k));d[e+3]=k[0];d[e+4]=k[1];d[e+5]=k[2]}};H3DU.SurfaceEval.prototype._playBack=function(a,c,d){this.vertexSurface&&(this.colorSurface&&a.color3(c[d+6],c[d+7],c[d+8]),(this.normalSurface||this.autoNormal)&&a.normal3(c[d+3],c[d+4],c[d+5]),this.texCoordSurface&&a.texCoord2(c[d+9],c[d+10]),a.vertex3(c[d+0],c[d+
1],c[d+2]))};H3DU.SurfaceEval.prototype.evalSurface=function(a,c,d,e,f,g,h,k){"undefined"===typeof d&&(d=24);"undefined"===typeof e&&(e=24);if(0>=d)throw Error("invalid un");if(0>=e)throw Error("invalid vn");if(null===c||"undefined"===typeof c)c=H3DU.Mesh.TRIANGLES;"undefined"===typeof h&&"undefined"===typeof k&&(h=0,k=1);"undefined"===typeof f&&"undefined"===typeof g&&(f=0,g=1);g=(g-f)/d;k=(k-h)/e;var b,m,l;if(c===H3DU.Mesh.TRIANGLES){var p=[],r=[];this._saveValues(a,p,0);for(c=0;c<e;c++)for(a.mode(H3DU.Mesh.TRIANGLE_STRIP),
l=b=0;b<=d;b++,l+=H3DU._RECORDED_VALUES_SIZE)m=b*g+f,0===c?this._recordAndPlayBack(a,m,c*k+h,p,H3DU._OLD_VALUES_SIZE):this._playBack(a,r,l),c===e-1?this._recordAndPlayBack(a,m,(c+1)*k+h,p,H3DU._OLD_VALUES_SIZE):this._recordAndPlayBack(a,m,(c+1)*k+h,r,l);this._restoreValues(a,p,0)}else if(c===H3DU.Mesh.POINTS)for(a.mode(H3DU.Mesh.POINTS),c=0;c<=e;c++)for(b=0;b<=d;b++)m=b*g+f,this.evalOne(a,m,c*k+h);else if(c===H3DU.Mesh.LINES){for(c=0;c<=e;c++)for(a.mode(H3DU.Mesh.LINE_STRIP),b=0;b<=d;b++)m=b*g+f,
this.evalOne(a,m,c*k+h);for(c=0;c<=d;c++)for(a.mode(H3DU.Mesh.LINE_STRIP),b=0;b<=e;b++)this.evalOne(a,c*g+f,b*k+h)}return this};a.H3DU.SurfaceEval=H3DU.SurfaceEval;a.H3DU.CurveEval=H3DU.CurveEval;a.H3DU.BezierCurve=H3DU.BezierCurve;a.H3DU.BezierSurface=H3DU.BezierSurface;a.H3DU.BSplineCurve=H3DU.BSplineCurve;a.H3DU.BSplineSurface=H3DU.BSplineSurface})(this);H3DU.Texture=function(a){this.image=null;this.loadStatus=0;this.name=a;this.width=0;this.clamp=!1;this.height=0};H3DU.Texture.prototype.getWidth=function(){return this.width};H3DU.Texture.prototype.getHeight=function(){return this.height};H3DU.Texture.prototype.setClamp=function(a){this.clamp=a;return this};H3DU.Texture.loadTexture=function(a,b){if(b&&b[a])return Promise.resolve(b[a]);var c=new H3DU.Texture(a);b&&(b[a]=c);return c.loadImage().then(function(a){return a},function(a){return Promise.reject(a.name)})};
H3DU.Texture.fromUint8Array=function(a,b,c){if(0>b)throw Error("width less than 0");if(0>c)throw Error("height less than 0");if(a.length<b*c*4)throw Error("array too short for texture");var d=new H3DU.Texture("");d.image=a;d.width=Math.ceil(b);d.height=Math.ceil(c);d.loadStatus=2;return d};
H3DU.Texture.loadTga=function(a){return H3DU.loadFileFromUrl(a,"arraybuffer").then(function(a){var b=new DataView(a.data),d=b.getUint8(2);if(2!==d&&3!==d)return Promise.reject(Error("unsupported image type"));var e=b.getUint16(8,!0),f=b.getUint16(10,!0);if(0!==e||0!==f)return Promise.reject(Error("unsupported origins"));e=b.getUint16(12,!0);f=b.getUint16(14,!0);if(0===e||0===f)return Promise.reject(Error("invalid width or height"));var g=b.getUint8(16);if(!(32===g&&2===d||24===g&&2===d||8===g&&3===
d))return Promise.reject(Error("unsupported pixelsize"));var h=e*f;if(h>a.data.length)return Promise.reject(Error("size too big"));var k=new Uint8Array(4*h),n=18;if(32===g&&2===d)for(g=d=0;d<h;d++,g+=4)k[g+2]=b.getUint8(n),k[g+1]=b.getUint8(n+1),k[g]=b.getUint8(n+2),k[g+3]=b.getUint8(n+3),n+=4;else if(24===g&&2===d)for(g=d=0;d<h;d++,g+=4)k[g+2]=b.getUint8(n),k[g+1]=b.getUint8(n+1),k[g]=b.getUint8(n+2),k[g+3]=255,n+=3;else if(8===g&&3===d)for(g=d=0;d<h;d++,g+=4){var m=b.getUint8(n);k[g]=m;k[g+1]=m;
k[g+2]=m;k[g+3]=255;n++}a.data=null;return{width:e,height:f,image:k}})};
H3DU.Texture.prototype.loadImage=function(){if("undefined"!==typeof this.image&&null!==this.image)return Promise.resolve(this);var a=this,b=this.name;a.loadStatus=1;return/\.tga$/i.test(b)?H3DU.Texture.loadTga(b).then(function(b){a.image=b.image;a.width=b.width;a.height=b.height;a.loadStatus=2;return a},function(c){a.loadStatus=-1;return Promise.reject({name:b,error:c})}):new Promise(function(c,d){var e=new Image;e.onload=function(b){b=b.target;a.image=b;a.width=b.width;a.height=b.height;a.loadStatus=
2;e.onload=null;e.onerror=null;c(a)};e.onerror=function(c){a.loadStatus=-1;e.onload=null;e.onerror=null;d({name:b,error:c})};e.src=b})};H3DU.Texture.prototype.dispose=function(){this.height=this.width=0;this.name="";this.image&&("undefined"!==typeof this.image.onload&&null!==this.image.onload&&(this.image.onload=null),"undefined"!==typeof this.image.onerror&&null!==this.image.onerror&&(this.image.onerror=null));this.image=null;this.clamp=!1;this.loadStatus=0};H3DU.Texture.prototype.getName=function(){return name};H3DU.BufferedMesh=function(a,b){b=H3DU._toContext(b);this._bounds=a instanceof H3DU.MeshBuffer?a._bounds:a.getBoundingBox();this._initialize(a,b)};
H3DU.BufferedMesh.prototype._initialize=function(a,b){if(null===a||"undefined"===typeof a)throw Error("mesh is null");var c=a instanceof H3DU.MeshBuffer?a:new H3DU.MeshBuffer(a);this.arrayObjectExt=b.getExtension("OES_vertex_array_object");this.arrayObjectExtContext=b;this.smb=c;this.vertsMap=new H3DU.BufferedMesh._Map;this.indices=b.createBuffer();if("undefined"===typeof this.indices||null===this.indices)throw Error("can't create face buffer");this.vao=null;this.arrayObjectExt&&(this.vao=this.arrayObjectExt.createVertexArrayOES());
for(var d=c._getAttributes(),e=0;e<d.length;e++){var f=d[e][2];if(f&&!this.vertsMap.get(f)){var g=b.createBuffer();if(null===g||"undefined"===typeof g)throw Error("can't create buffer");b.bindBuffer(b.ARRAY_BUFFER,g);b.bufferData(b.ARRAY_BUFFER,f,b.STATIC_DRAW);this.vertsMap.put(f,g)}}b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indices);b.bufferData(b.ELEMENT_ARRAY_BUFFER,c.indices,b.STATIC_DRAW);d=b.UNSIGNED_SHORT;4===c.indexBufferSize?d=b.UNSIGNED_INT:1===c.indexBufferSize&&(d=b.UNSIGNED_BYTE);this.type=
d;this.context=b;this._lastKnownProgram=null;this._attribLocations=[]};H3DU.BufferedMesh.prototype._toMeshBuffer=function(){return this.smb};H3DU.BufferedMesh.prototype._getVaoExtension=function(a){return this.arrayObjectExtContext===a?this.arrayObjectExt:a.getExtension("OES_vertex_array_object")};H3DU.BufferedMesh.prototype._getBounds=function(){return this._bounds};H3DU.BufferedMesh.prototype.getContext=function(){return this.context};H3DU.BufferedMesh.prototype.getFormat=function(){return this.smb.format};
H3DU.BufferedMesh.prototype.dispose=function(){if("undefined"!==typeof this.vertsMap&&null!==this.vertsMap)for(var a=this.vertsMap.values(),b=0;b<a.length;b++)a[b].dispose();"undefined"!==typeof this.indices&&null!==this.indices&&this.context.deleteBuffer(this.indices);"undefined"!==typeof this.vao&&null!==this.vao&&this.arrayObjectExt.deleteVertexArrayOES(this.vao);this._lastKnownProgram=this.vao=this.smb=this.indices=this.vertsMap=null;this._attribLocations=[]};
H3DU.BufferedMesh.prototype._getAttribLocations=function(a){if(this._lastKnownProgram!==a){this._lastKnownProgram=a;var b=this.smb._getAttributes();this._attribLocations=[];for(var c=0;c<b.length;c++){var d=a.get(b[c][0]);if(null===d||"undefined"===typeof d)d=-1;this._attribLocations[c]=d}return!0}return!1};
H3DU.BufferedMesh.prototype._prepareDraw=function(a,b){var c=this._getAttribLocations(a,b),d=this._getVaoExtension(b);this.vao?d.bindVertexArrayOES(this.vao):c=!0;if(c){b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indices);c=this.smb._getAttributes();for(d=0;d<this._attribLocations.length;d++){var e=this._attribLocations[d];if(0<=e){var f=this.vertsMap.get(c[d][2]);b.bindBuffer(b.ARRAY_BUFFER,f);b.enableVertexAttribArray(e);b.vertexAttribPointer(e,c[d][3],b.FLOAT,!1,4*c[d][4],4*c[d][1])}}a._disableOthers(c)}};
H3DU.BufferedMesh.prototype.draw=function(a){var b=a.getContext();if(null===this.vertsMap||null===this.face)throw Error("mesh buffer disposed");if(b!==this.context)throw Error("can't bind mesh: context mismatch");this._prepareDraw(a,b);a=b.TRIANGLES;0!==(this.smb.format&H3DU.Mesh.LINES_BIT)&&(a=b.LINES);0!==(this.smb.format&H3DU.Mesh.POINTS_BIT)&&(a=b.POINTS);b.drawElements(a,this.smb.facesLength,this.type,0);b=this._getVaoExtension(b);this.vao&&b.bindVertexArrayOES(null)};
H3DU.BufferedMesh.prototype.vertexCount=function(){return this.smb.numVertices};H3DU.BufferedMesh.prototype.primitiveCount=function(){return this.smb.primitiveCount()};H3DU.BufferedMesh._Map=function(){this.map=[]};H3DU.BufferedMesh._Map.prototype.get=function(a){for(var b=0;b<this.map.length;b++)if(this.map[b][0]===a)return this.map[b][1];return null};
H3DU.BufferedMesh._Map.prototype.put=function(a,b){for(var c=0;c<this.map.length;c++)if(this.map[c][0]===a){this.map[c][1]=b;return}this.map.push([a,b])};H3DU.BufferedMesh._Map.prototype.values=function(){for(var a=[],b=0;b<this.map.length;b++)a.push(this.map[b][1]);return a};H3DU.BufferedMesh._MeshLoader=function(){this.meshes=[]};
H3DU.BufferedMesh._MeshLoader.prototype.draw=function(a,b){if(!(a instanceof H3DU.MeshBuffer))throw Error("Expected H3DU.MeshBuffer");for(var c=b.getContext(),d=0;d<this.meshes.length;d++){var e=this.meshes[d];if(e[0]===a&&e[1]===c){e[2].draw(b);return}}d=new H3DU.BufferedMesh(a,b);this.meshes.push([a,c,d]);d.draw(b)};H3DU.BufferedMesh._MeshLoader.prototype.dispose=function(){for(var a=0;a<this.meshes.length;a++)this.meshes[a][2].dispose();this.meshes=[]};H3DU.Math={vec3cross:function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},vec3dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},vec3sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},vec3negate:function(a){return[-a[0],-a[1],-a[2]]},vec3negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},vec3mul:function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]},vec3addInPlace:function(a,b){var c=
b[1],d=b[2];a[0]+=b[0];a[1]+=c;a[2]+=d;return a},vec3subInPlace:function(a,b){var c=b[1],d=b[2];a[0]-=b[0];a[1]-=c;a[2]-=d;return a},vec3mulInPlace:function(a,b){var c=b[1],d=b[2];a[0]*=b[0];a[1]*=c;a[2]*=d;return a},vec3scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},vec3scale:function(a,b){return H3DU.Math.vec3scaleInPlace([a[0],a[1],a[2]],b)},vec3lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c]},vec4dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+
a[2]*b[2]+a[3]*b[3]},vec4scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},vec4lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c,a[3]+(b[3]-a[3])*c]},vec3normInPlace:function(a){var b=a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b);return a},vec4normInPlace:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],b=Math.sqrt(b*b+c*c+d*d+e*e);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},vec3norm:function(a){return H3DU.Math.vec3normInPlace([a[0],
a[1],a[2]])},vec4norm:function(a){return H3DU.Math.vec4normInPlace([a[0],a[1],a[2],a[3]])},vec3length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)},vec4length:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},mat3identity:function(){return[1,0,0,0,1,0,0,0,1]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},quatIdentity:function(){return[0,0,0,1]},mat4copy:function(a){return a.slice(0,16)},vec3copy:function(a){return a.slice(0,3)},
vec4copy:function(a){return a.slice(0,4)},vec3assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},vec4assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},mat4isIdentity:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mat4invert:function(a){var b=a[0]*a[10],c=a[0]*a[11],d=a[0]*a[5],e=a[0]*a[6],f=a[0]*a[7],g=a[0]*a[9],h=a[10]*a[12],k=a[10]*
a[13],n=a[10]*a[15],m=a[11]*a[12],l=a[11]*a[13],p=a[11]*a[14],r=a[1]*a[4],q=a[1]*a[6],t=a[1]*a[7],w=a[1]*a[8],x=a[2]*a[4],A=a[2]*a[5],z=a[2]*a[7],v=a[2]*a[8],D=a[2]*a[9],u=a[3]*a[4],I=a[3]*a[5],B=a[3]*a[6],y=a[3]*a[8],C=a[3]*a[9],J=a[4]*a[9],G=a[5]*a[8],L=a[6]*a[8],M=a[6]*a[9],K=a[7]*a[8],N=a[7]*a[9],F=r-d,E=q-A,H=t-I,O=x-e,d=d-r,q=A-q,A=z-B,r=u-f,t=I-t,z=B-z,e=e-x,x=f-u,f=a[9]*a[12]*z+h*H+m*q+a[8]*a[13]*A+k*r+l*e+a[8]*a[14]*t+a[9]*a[14]*x+p*F+a[8]*a[15]*E+a[9]*a[15]*O+n*d;if(0===f)return H3DU.Math.mat4identity();
f=1/f;u=[];u[0]=a[6]*l-a[7]*k+N*a[14]-a[5]*p-M*a[15]+a[5]*n;u[1]=a[3]*k-a[2]*l-C*a[14]+a[1]*p+D*a[15]-a[1]*n;u[2]=a[13]*A+a[14]*t+a[15]*E;u[3]=a[9]*z+a[10]*H+a[11]*q;u[4]=a[7]*h-a[6]*m-K*a[14]+a[4]*p+L*a[15]-a[4]*n;u[5]=a[2]*m-a[3]*h+a[14]*(y-c)+a[15]*(b-v);u[6]=a[12]*z+a[14]*x+a[15]*O;u[7]=a[8]*A+a[10]*r+a[11]*e;u[8]=a[5]*m-N*a[12]+K*a[13]-a[4]*l+a[15]*(J-G);u[9]=C*a[12]-a[1]*m+a[13]*(c-y)+a[15]*(w-g);u[10]=a[12]*H+a[13]*r+a[15]*d;u[11]=a[8]*t+a[9]*x+a[11]*F;u[12]=M*a[12]-a[5]*h-L*a[13]+a[4]*k+a[14]*
(G-J);u[13]=a[1]*h-D*a[12]+a[13]*(v-b)+a[14]*(g-w);u[14]=a[12]*q+a[13]*e+a[14]*F;u[15]=a[8]*E+a[9]*O+a[10]*d;for(a=0;16>a;a++)u[a]*=f;return u},quatConjugate:function(a){return[-a[0],-a[1],-a[2],a[3]]},quatInvert:function(a){var b=1/H3DU.Math.quatDot(a,a);return H3DU.Math.vec4scaleInPlace(H3DU.Math.quatConjugate(a),b)},quatIsIdentity:function(a){return 0===a[0]&&0===a[1]&&0===a[2]&&1===a[3]},quatToMat4:function(a){var b,c,d,e,f,g,h,k,n;b=2*a[0];c=2*a[1];d=2*a[2];e=b*a[0];f=b*a[1];g=b*a[2];h=c*a[1];
k=d*a[1];n=d*a[2];b*=a[3];c*=a[3];a=d*a[3];return[1-(h+n),f+a,g-c,0,f-a,1-(e+n),k+b,0,g+c,k-b,1-(e+h),0,0,0,0,1]},quatToAxisAngle:function(a){var b=a[3],c=1-b*b;return 0<c?(c=1/Math.sqrt(c),[a[0]*c,a[1]*c,a[2]*c,Math.acos(b)*H3DU.Math.Num360DividedByPi]):[0,1,0,0]},quatFromVectors:function(a,b){var c=H3DU.Math.vec3cross(a,b),d=Math.sqrt(H3DU.Math.vec3dot(a,a))*Math.sqrt(H3DU.Math.vec3dot(b,b));0===d&&(d=1);c[3]=d+H3DU.Math.vec3dot(a,b);return H3DU.Math.quatNormInPlace(c)},quatFromAxisAngle:function(a,
b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2]):(e=b[0],c=b[1],b=b[2]);d=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360;a=Math.cos(d);d=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);e=H3DU.Math.vec3normInPlace([e,c,b]);e=[e[0],e[1],e[2],a];e[0]*=d;e[1]*=d;e[2]*=d;return e},quatFromTaitBryan:function(a,b,c,d){var e,f;if(null===d||"undefined"===typeof d)d=H3DU.Math.RollPitchYaw;
if(0>d||6<=d)throw Error("invalid mode");a.constructor===Array?(c=(0<=a[2]&&360>a[2]?a[2]:a[2]%360+(0>a[2]?360:0))*H3DU.Math.PiDividedBy360,e=(0<=a[0]&&360>a[0]?a[0]:a[0]%360+(0>a[0]?360:0))*H3DU.Math.PiDividedBy360,f=(0<=a[1]&&360>a[1]?a[1]:a[1]%360+(0>a[1]?360:0))*H3DU.Math.PiDividedBy360):(c=(0<=c&&360>c?c:c%360+(0>c?360:0))*H3DU.Math.PiDividedBy360,e=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360,f=(0<=b&&360>b?b:b%360+(0>b?360:0))*H3DU.Math.PiDividedBy360);a=Math.cos(e);e=0<=e&&6.283185307179586>
e?3.141592653589793>=e?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(e);b=Math.cos(f);f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(f);var g=Math.cos(c);c=0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-g*g):-Math.sqrt(1-g*g):Math.sin(c);var h;d===H3DU.Math.PitchYawRoll||d===H3DU.Math.PitchRollYaw?(h=[c*f,g*f,c*b,g*b],d===H3DU.Math.PitchYawRoll&&(h[0]=-h[0]),d=[h[3]*e+h[0]*a,h[1]*a+h[2]*e,h[2]*a-h[1]*e,h[3]*a-h[0]*e]):d===H3DU.Math.YawPitchRoll||
d===H3DU.Math.YawRollPitch?(h=[g*e,c*e,c*a,g*a],d===H3DU.Math.YawRollPitch&&(h[1]=-h[1]),d=[h[0]*b-h[2]*f,h[3]*f+h[1]*b,h[2]*b+h[0]*f,h[3]*b-h[1]*f]):(h=[b*e,f*a,f*e,b*a],d===H3DU.Math.RollPitchYaw&&(h[2]=-h[2]),d=[h[0]*g+h[1]*c,h[1]*g-h[0]*c,h[3]*c+h[2]*g,h[3]*g-h[2]*c]);return d},quatToTaitBryan:function(a,b){var c=a[3],d,e,f,g=1;if(null===b||"undefined"===typeof b)b=H3DU.Math.RollPitchYaw;if(0>b||6<=b)throw Error("invalid mode");b===H3DU.Math.RollPitchYaw?(d=a[1],e=a[0],f=a[2],g=-1):b===H3DU.Math.PitchYawRoll?
(d=a[2],e=a[1],f=a[0],g=-1):b===H3DU.Math.PitchRollYaw?(d=a[1],e=a[2],f=a[0]):b===H3DU.Math.YawPitchRoll?(d=a[2],e=a[0],f=a[1]):b===H3DU.Math.YawRollPitch?(d=a[0],e=a[2],f=a[1],g=-1):(d=a[0],e=a[1],f=a[2]);var h=e*e,k=Math.atan2(2*(c*d-g*e*f),1-2*(d*d+h)),n=2*(c*e+g*d*f);1<n&&(n=1);-1>n&&(n=-1);n=Math.asin(n);e=Math.atan2(2*(c*f-g*d*e),1-2*(h+f*f));k*=H3DU.Math.Num180DividedByPi;n*=H3DU.Math.Num180DividedByPi;e*=H3DU.Math.Num180DividedByPi;if(1E-6>Math.abs(n-90)||1E-6>Math.abs(n+90))e=0,k=Math.atan2(d,
c)*H3DU.Math.Num180DividedByPi,isNaN(k)&&(k=0);c=[];b===H3DU.Math.RollPitchYaw?(c[0]=n,c[1]=k,c[2]=e):b===H3DU.Math.PitchYawRoll?(c[0]=e,c[1]=n,c[2]=k):b===H3DU.Math.PitchRollYaw?(c[0]=e,c[1]=k,c[2]=n):b===H3DU.Math.YawPitchRoll?(c[0]=n,c[1]=e,c[2]=k):b===H3DU.Math.YawRollPitch?(c[0]=k,c[1]=e,c[2]=n):(c[0]=k,c[1]=n,c[2]=e);return c},quatNlerp:function(a,b,c){var d=1-c,e=a[0]*d,f=a[1]*d,g=a[2]*d,d=a[3]*d,h=b[0]*c,k=b[1]*c,n=b[2]*c;c*=b[3];return 0>a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]?H3DU.Math.quatNormInPlace([e-
h,f-k,g-n,d-c]):H3DU.Math.quatNormInPlace([e+h,f+k,g+n,d+c])},quatSlerp:function(a,b,c){var d=H3DU.Math.quatDot(a,b),e=b;0>d&&(e=[-b[0],-b[1],-b[2],-b[3]],d=H3DU.Math.quatDot(a,e));if(-1<d)if(1>d){if(d=Math.acos(d),0===d)return e.slice(0,4)}else return e.slice(0,4);else d=Math.PI;var f=1/Math.sin(d);b=Math.sin((1-c)*d)*f;c=Math.sin(c*d)*f;return[a[0]*b+e[0]*c,a[1]*b+e[1]*c,a[2]*b+e[2]*c,a[3]*b+e[3]*c]},quatRotate:function(a,b,c,d,e){return H3DU.Math.quatMultiply(a,H3DU.Math.quatFromAxisAngle(b,c,
d,e))},quatTransform:function(a,b){var c=a[1]*b[2]-a[2]*b[1]+b[0]*a[3],d=a[2]*b[0]-a[0]*b[2]+b[1]*a[3],e=a[0]*b[1]-a[1]*b[0]+b[2]*a[3],f=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];return[c*a[3]-(d*a[2]-e*a[1])+a[0]*f,d*a[3]-(e*a[0]-c*a[2])+a[1]*f,e*a[3]-(c*a[1]-d*a[0])+a[2]*f,1]},quatFromMat4:function(a){var b=[],c=a[1],d=a[2],e=a[4],f=a[6],g=a[8],h=a[9],k=a[0]+a[5]+a[10];0<=k?(a=.5*Math.sqrt(k+1),k=.25/a,b[0]=(f-h)*k,b[1]=(g-d)*k,b[2]=(c-e)*k,b[3]=a):a[0]>a[5]&&a[0]>a[10]?(a=.5*Math.sqrt(1+a[0]-a[5]-a[10]),k=
.25/a,b[0]=a,b[1]=(e+c)*k,b[2]=(d+g)*k,b[3]=(f-h)*k):a[5]>a[10]?(a=.5*Math.sqrt(1+a[5]-a[0]-a[10]),k=.25/a,b[0]=(e+c)*k,b[1]=a,b[2]=(h+f)*k,b[3]=(g-d)*k):(a=.5*Math.sqrt(1+a[10]-a[0]-a[5]),k=.25/a,b[0]=(g+d)*k,b[1]=(h+f)*k,b[2]=a,b[3]=(c-e)*k);return b},mat4toMat3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},mat4transpose:function(a){return H3DU.Math.mat4transposeInPlace(a.slice(0,16))},mat4transposeInPlace:function(a){var b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];
a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return a},mat4inverseTranspose3:function(a){if(0===a[1]&&0===a[2]&&0===a[4]&&0===a[6]&&0===a[8]&&0===a[9])return 1===a[0]&&1===a[5]&&1===a[10]?[1,0,0,0,1,0,0,0,1]:0!==a[0]*a[5]*a[10]?[1/a[0],0,0,0,1/a[5],0,0,0,1/a[10]]:[1,0,0,0,1,0,0,0,1];a=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];var b=a[0]*a[4]*a[8]+a[3]*a[7]*a[2]+a[6]*a[1]*a[5]-a[6]*a[4]*a[2]-a[3]*a[1]*a[8]-a[0]*a[7]*a[5];if(0===b)return[1,0,
0,0,1,0,0,0,1];b=1/b;return[(-a[5]*a[7]+a[4]*a[8])*b,(a[5]*a[6]-a[3]*a[8])*b,(-a[4]*a[6]+a[3]*a[7])*b,(a[2]*a[7]-a[1]*a[8])*b,(-a[2]*a[6]+a[0]*a[8])*b,(a[1]*a[6]-a[0]*a[7])*b,(-a[2]*a[4]+a[1]*a[5])*b,(a[2]*a[3]-a[0]*a[5])*b,(-a[1]*a[3]+a[0]*a[4])*b]},mat4scale:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0]*e,a[1]*e,a[2]*e,a[3]*e,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],a[15]]},mat4scaled:function(a,
b,c){return"undefined"!==typeof b&&"undefined"!==typeof c?[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]:[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},mat4transform:function(a,b,c,d,e){var f;"undefined"!==typeof c&&"undefined"!==typeof d&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],d=b[2],b=b[3]);return[f*a[0]+c*a[4]+d*a[8]+b*a[12],f*a[1]+c*a[5]+d*a[9]+b*a[13],f*a[2]+c*a[6]+d*a[10]+b*a[14],f*a[3]+c*a[7]+d*a[11]+b*a[15]]},mat4transformVec3:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?
(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[4]+b*a[8]+a[12],e*a[1]+c*a[5]+b*a[9]+a[13],e*a[2]+c*a[6]+b*a[10]+a[14]]},mat4projectVec3:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);d=1/(e*a[3]+c*a[7]+b*a[11]+a[15]);return[(e*a[0]+c*a[4]+b*a[8]+a[12])*d,(e*a[1]+c*a[5]+b*a[9]+a[13])*d,(e*a[2]+c*a[6]+b*a[10]+a[14])*d]},mat3transform:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*
a[0]+c*a[3]+b*a[6],e*a[1]+c*a[4]+b*a[7],e*a[2]+c*a[5]+b*a[8]]},mat4translated:function(a,b,c){var d;"undefined"!==typeof b&&"undefined"!==typeof c?(d=a,a=c):(d=a[0],b=a[1],a=a[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,d,b,a,1]},mat4translate:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*e+a[4]*c+a[8]*b+a[12],a[1]*e+a[5]*c+a[9]*b+a[13],a[2]*e+a[6]*c+a[10]*b+a[14],a[3]*e+a[7]*
c+a[11]*b+a[15]]},mat4perspective:function(a,b,c,d){a=1/Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360);var e;e=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,e*(c+d),-1,0,0,e*c*d*2,0]},mat4lookat:function(a,b,c){if(null===c||"undefined"===typeof c)c=[0,1,0];if(null===b||"undefined"===typeof b)b=[0,0,0];b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];var d=H3DU.Math.vec3length(b);if(1E-6>d)return H3DU.Math.mat4identity();d=1/d;b[0]*=d;b[1]*=d;b[2]*=d;c=H3DU.Math.vec3norm(c);c=H3DU.Math.vec3cross(b,c);
H3DU.Math.vec3normInPlace(c);d=H3DU.Math.vec3cross(c,b);H3DU.Math.vec3normInPlace(d);b[0]=-b[0];b[1]=-b[1];b[2]=-b[2];return[c[0],d[0],b[0],0,c[1],d[1],b[1],0,c[2],d[2],b[2],0,-H3DU.Math.vec3dot(a,c),-H3DU.Math.vec3dot(a,d),-H3DU.Math.vec3dot(a,b),1]},mat4ortho:function(a,b,c,d,e,f){var g=1/(b-a),h=1/(d-c),k=1/(f-e);return[2*g,0,0,0,0,2*h,0,0,0,0,-2*k,0,-(a+b)*g,-(d+c)*h,-(e+f)*k,1]},mat4perspectiveHorizontal:function(a,b,c,d){return H3DU.Math.mat4perspective(H3DU.Math.Num360DividedByPi*Math.atan2(Math.tan((0<=
a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360),b),b,c,d)},mat4ortho2d:function(a,b,c,d){return H3DU.Math.mat4ortho2d(a,b,c,d,-1,1)},mat4ortho2dAspect:function(a,b,c,d,e){return H3DU.Math.mat4orthoAspect(a,b,c,d,-1,1,e)},mat4orthoAspect:function(a,b,c,d,e,f,g){g/=Math.abs((b-a)/(d-c));var h=Math.abs(b-a),k=Math.abs(d-c);1>g?(g=k/g,d>c?(c-=.5*(g-k),d+=.5*(g-k)):(d-=.5*(g-k),c+=.5*(g-k))):(g*=h,b>a?(a-=.5*(g-h),b+=.5*(g-h)):(b-=.5*(g-h),a+=.5*(g-h)));return H3DU.Math.mat4ortho(a,b,c,d,e,f)},
mat4frustum:function(a,b,c,d,e,f){var g=2*e,h=1/(b-a),k=1/(d-c),n=1/(f-e);return[g*h,0,0,0,0,g*k,0,0,(a+b)*h,(d+c)*k,-(f+e)*n,-1,0,0,-(g*f)*n,0]},mat4scaleInPlace:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);a[0]*=e;a[1]*=e;a[2]*=e;a[3]*=e;a[4]*=c;a[5]*=c;a[6]*=c;a[7]*=c;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a},mat4multiply:function(a,b){for(var c=[],d=0;16>d;d+=4)for(var e=0;4>e;e++)c[d+e]=b[d]*a[e]+b[d+1]*a[e+4]+b[d+2]*a[e+8]+b[d+3]*
a[e+12];return c},quatMultiply:function(a,b){return[a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]+a[1]*b[3]+a[2]*b[0]-a[0]*b[2],a[3]*b[2]+a[2]*b[3]+a[0]*b[1]-a[1]*b[0],a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]]},mat4rotate:function(a,b,c,d,e){var f,g;"undefined"!==typeof d&&"undefined"!==typeof e?(f=c,g=d,c=e,e=(0<=b&&360>b?b:b%360+(0>b?360:0))*H3DU.Math.PiDividedBy180):"undefined"===typeof c?(f=b[0],g=b[1],c=b[2],e=b[3],e=(0<=e&&360>e?e:e%360+(0>e?360:0))*H3DU.Math.PiDividedBy180):(f=c[0],g=c[1],
c=c[2],e=(0<=b&&360>b?b:b%360+(0>b?360:0))*H3DU.Math.PiDividedBy180);b=Math.cos(e);var h=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(e);if(1===f&&0===g&&0===c)return[a[0],a[1],a[2],a[3],b*a[4]+a[8]*h,b*a[5]+a[9]*h,b*a[6]+a[10]*h,b*a[7]+a[11]*h,b*a[8]-h*a[4],b*a[9]-h*a[5],b*a[10]-h*a[6],b*a[11]-h*a[7],a[12],a[13],a[14],a[15]];if(0===f&&1===g&&0===c)return[b*a[0]-h*a[8],b*a[1]-h*a[9],b*a[2]-h*a[10],b*a[3]-h*a[11],a[4],a[5],a[6],a[7],b*a[8]+a[0]*h,b*a[9]+
a[1]*h,b*a[10]+a[2]*h,b*a[11]+a[3]*h,a[12],a[13],a[14],a[15]];if(0===f&&0===g&&1===c)return[b*a[0]+a[4]*h,b*a[1]+a[5]*h,b*a[2]+a[6]*h,b*a[3]+a[7]*h,b*a[4]-h*a[0],b*a[5]-h*a[1],b*a[6]-h*a[2],b*a[7]-h*a[3],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]];if(0===f&&0===g&&0===c)return a.slice(0,16);e=1/Math.sqrt(f*f+g*g+c*c);f*=e;g*=e;c*=e;var k=g*g;d=1-b;var n=f*g,m=g*c;e=f*h;g*=h;var l=c*h,h=d*m,p=d*n,r=d*f*c;f=b+d*f*f;n=p+l;m=r-g;k=b+d*k;l=p-l;p=h+e;c=b+d*c*c;b=r+g;e=h-e;return[a[0]*f+a[4]*n+a[8]*m,
a[1]*f+a[5]*n+a[9]*m,a[10]*m+a[2]*f+a[6]*n,a[11]*m+a[3]*f+a[7]*n,a[0]*l+a[4]*k+a[8]*p,a[1]*l+a[5]*k+a[9]*p,a[10]*p+a[2]*l+a[6]*k,a[11]*p+a[3]*l+a[7]*k,a[0]*b+a[4]*e+a[8]*c,a[1]*b+a[5]*e+a[9]*c,a[10]*c+a[2]*b+a[6]*e,a[11]*c+a[3]*b+a[7]*e,a[12],a[13],a[14],a[15]]},mat4rotated:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d,d=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy180):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2],d=a[3],d=(0<=d&&360>d?d:d%360+(0>d?360:
0))*H3DU.Math.PiDividedBy180):(e=b[0],c=b[1],b=b[2],d=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy180);a=Math.cos(d);var f=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);if(1===e&&0===c&&0===b)return[1,0,0,0,0,a,f,0,0,-f,a,0,0,0,0,1];if(0===e&&1===c&&0===b)return[a,0,-f,0,0,1,0,0,f,0,a,0,0,0,0,1];if(0===e&&0===c&&1===b)return[a,f,0,0,-f,a,0,0,0,0,1,0,0,0,0,1];if(0===e&&0===c&&0===b)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];d=1/Math.sqrt(e*e+
c*c+b*b);e*=d;c*=d;b*=d;d=e*e;var g=c*c,h=b*b,k=e*b,n=c*b,m=e*f,l=c*f,f=b*f,p=1-a;e=p*e*c;c=p*k;b=p*n;return[a+p*d,e+f,c-l,0,e-f,a+p*g,b+m,0,c+l,b-m,a+p*h,0,0,0,0,1]},planeNormInPlace:function(a){var b=a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},planeNorm:function(a){return H3DU.Math.planeNormInPlace(a.slice(0,4))},mat4toFrustumPlanes:function(a){var b=[[],[],[],[],[],[]];b[0]=H3DU.Math.planeNormInPlace([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+
a[12]]);b[1]=H3DU.Math.planeNormInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);b[2]=H3DU.Math.planeNormInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);b[3]=H3DU.Math.planeNormInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]);b[4]=H3DU.Math.planeNormInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);b[5]=H3DU.Math.planeNormInPlace([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);return b},frustumHasSphere:function(a,b,c,d,e){if(0>e)throw Error("radius is negative");for(var f=0;6>
f;f++){var g=a[f];if(g[3]+g[0]*b+g[1]*c+g[2]*d<-e)return!1}return!0},boxIsEmpty:function(a){return!(a[0]<=a[3]&&a[1]<=a[4]&&a[2]<=a[5])},frustumHasBox:function(a,b){if(H3DU.Math.boxIsEmpty(b))return!1;for(var c=0;6>c;c++){var d=a[c],e=d[3],f=d[0]*b[0],g=d[2]*b[2],h=d[1]*b[1];if(0>=f+h+g+e&&0>=d[0]*b[3]+d[1]*b[4]+d[2]*b[5]+e&&0>=f+d[1]*b[4]+g+e&&0>=f+d[1]*b[4]+d[2]*b[5]+e&&0>=f+h+d[2]*b[5]+e&&0>=d[0]*b[3]+d[1]*b[4]+g+e&&0>=d[0]*b[3]+h+g+e&&0>=d[0]*b[3]+h+d[2]*b[5]+e)return!1}return!0},frustumHasPoint:function(a,
b,c,d){for(var e=0;6>e;e++)if(0>=a[e][0]*b+a[e][1]*c+a[e][2]*d+a[e][3])return!1;return!0}};H3DU.Math.quatDot=H3DU.Math.vec4dot;H3DU.Math.quatNormInPlace=H3DU.Math.vec4normInPlace;H3DU.Math.quatNorm=H3DU.Math.vec4norm;H3DU.Math.quatLength=H3DU.Math.vec4length;H3DU.Math.quatScaleInPlace=H3DU.Math.vec4scaleInPlace;H3DU.Math.quatCopy=H3DU.Math.vec4copy;H3DU.Math.PiTimes2=6.283185307179586;H3DU.Math.HalfPi=1.5707963267948966;H3DU.Math.PiDividedBy180=.017453292519943295;H3DU.Math.PiDividedBy360=.008726646259971648;
H3DU.Math.Num360DividedByPi=114.59155902616465;H3DU.Math.Num180DividedByPi=57.29577951308232;H3DU.Math.PitchYawRoll=0;H3DU.Math.PitchRollYaw=1;H3DU.Math.YawPitchRoll=2;H3DU.Math.YawRollPitch=3;H3DU.Math.RollPitchYaw=4;H3DU.Math.RollYawPitch=5;H3DU.Math.quatInverse=H3DU.Math.quatInvert;H3DU.ShaderInfo=function(a,b){if(null===a||"undefined"===typeof a)a=H3DU.ShaderInfo.getDefaultVertex();if(null===b||"undefined"===typeof b)b=H3DU.ShaderInfo.getDefaultFragment();this.vertexShader=a;this.fragmentShader=b;this.uniformValues={}};H3DU.ShaderInfo.prototype.getVertexShader=function(){return this.vertexShader};H3DU.ShaderInfo.prototype.getFragmentShader=function(){return this.fragmentShader};
H3DU.ShaderInfo.prototype.copy=function(){var a=new H3DU.ShaderInfo(this.vertexShader,this.fragmentShader);a.setUniforms(this.uniformValues);return a};H3DU.ShaderInfo.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,null);return this};
H3DU.ShaderInfo._setUniformInternal=function(a,b,c,d){a=a[c];var e=b[c];if("number"===typeof a){var f=!1;null===e||"undefined"===typeof e?(b[c]=e=a,f=!0):e!==a&&(e=a,b[c]=a,f=!0);f&&d&&(d[c]=e)}else if(3===a.length)if(!e)b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2])e[0]=a[0],e[1]=a[1],e[2]=a[2],d&&(d[c]=e.slice(0,e.length))}else if(2===a.length)if(!e)b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1])e[0]=
a[0],e[1]=a[1],d&&(d[c]=e.slice(0,e.length))}else if(4===a.length)if(!e)b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3])e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3],d&&(d[c]=e.slice(0,e.length))}else 16===a.length?e?H3DU.ShaderInfo._copyIfDifferent(a,e,16)&&d&&(d[c]=e.slice(0,e.length)):(b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length))):9===a.length&&(e?H3DU.ShaderInfo._copyIfDifferent(a,e,9)&&d&&(d[c]=e.slice(0,e.length)):(b[c]=a.slice(0,
a.length),d&&(d[c]=a.slice(0,a.length))))};H3DU.ShaderInfo._copyIfDifferent=function(a,b,c){for(var d=0;d<c;d++)if(a[d]!==b[d]){b[d]=a[d];for(d+=1;d<c;d++)b[d]=a[d];return!0}return!1};H3DU.ShaderInfo._setUniformsInternal=function(a,b,c){var d;if("undefined"===typeof Object.keys)for(d in a)Object.prototype.hasOwnProperty.call(a,d)&&H3DU.ShaderInfo._setUniformInternal(a,b,d,c);else for(var e=Object.keys(a),f=0;f<e.length;f++)d=e[f],H3DU.ShaderInfo._setUniformInternal(a,b,d,c)};
H3DU.ShaderInfo.fragmentShaderHeader=function(){return"#ifdef GL_ES\n#ifndef GL_FRAGMENT_PRECISION_HIGH\nprecision mediump float;\n#else\nprecision highp float;\n#endif\n#endif\n"};H3DU.ShaderInfo.makeEffectFragment=function(a){var b=H3DU.ShaderInfo.fragmentShaderHeader();return b+"uniform sampler2D sampler;\nuniform vec2 textureSize;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n"+a+"\n\nvoid main() {\n // normalize coordinates to 0..1\n vec2 uv=gl_FragCoord.xy/textureSize.xy;\n gl_FragColor=textureEffect(sampler,uv,textureSize);\n}"};
H3DU.ShaderInfo.makeCopyEffect=function(){var a=H3DU.ShaderInfo.fragmentShaderHeader(),a=a+"uniform sampler2D sampler;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n\n\nvoid main() {\n gl_FragColor=texture2D(sampler,uvVar);\n}";return new H3DU.ShaderInfo(H3DU.ShaderInfo.getBasicVertex(),a)};H3DU.ShaderInfo.makeEffect=function(a){return new H3DU.ShaderInfo(H3DU.ShaderInfo.getBasicVertex(),H3DU.ShaderInfo.makeEffectFragment(a))};H3DU.ShaderInfo.makeInvertEffect=function(){return H3DU.ShaderInfo.makeEffect("vec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize) {\n vec4 color=texture2D(sampler,uvCoord);\n vec4 ret; ret.xyz=vec3(1.0,1.0,1.0)-color.xyz; ret.w=color.w; return ret;\n}")};
H3DU.ShaderInfo.makeEdgeDetectEffect=function(){return H3DU.ShaderInfo.makeEffect("float luma(vec3 color) {\n return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}\nconst vec4 edge_color=vec4(0.,0,0,1);\nconst vec4 back_color=vec4(1.,1,1,1);\nvec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize) {\nfloat dx = 1.0 / float(textureSize.x);\nfloat dy = 1.0 / float(textureSize.y);\nfloat s00 = luma(texture2D(sampler, uvCoord + vec2(-dx,dy)).rgb);\nfloat s10 = luma(texture2D(sampler, uvCoord + vec2(-dx,0.0)).rgb);\nfloat s20 = luma(texture2D(sampler, uvCoord + vec2(-dx,-dy)).rgb);\nfloat s01 = luma(texture2D(sampler, uvCoord + vec2(0.0,dy)).rgb);\nfloat s21 = luma(texture2D(sampler, uvCoord + vec2(0.0,-dy)).rgb);\nfloat s02 = luma(texture2D(sampler, uvCoord + vec2(dx, dy)).rgb);\nfloat s12 = luma(texture2D(sampler, uvCoord + vec2(dx, 0.0)).rgb);\nfloat s22 = luma(texture2D(sampler, uvCoord + vec2(dx, -dy)).rgb);\nfloat sx = s00 + 2.0 * s10 + s20 - (s02 + 2.0 * s12 + s22);\nfloat sy = s00 + 2.0 * s01 + s02 - (s20 + 2.0 * s21 + s22);\nfloat dist = sx * sx + sy * sy;\nif(dist > 0.4) {\nreturn edge_color;\n} else {\nreturn back_color;\n}}")};
H3DU.ShaderInfo.getBasicVertex=function(){return"attribute vec3 position;\nattribute vec2 uv;\nvarying vec2 uvVar;\n#ifdef COLORATTR\nattribute vec3 colorAttr;\nvarying vec3 colorAttrVar;\n#endif\nvoid main() {\nvec4 positionVec4;\npositionVec4.w=1.0;\npositionVec4.xyz=position;\ngl_PointSize=1.0;\nuvVar=uv;\n#ifdef COLORATTR\ncolorAttrVar=colorAttr;\n#endif\ngl_Position=positionVec4;\n}\n"};H3DU.ShaderInfo.getDefaultVertex=function(){return"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\n#ifdef COLORATTR\nattribute vec3 colorAttr;\nvarying vec3 colorAttrVar;\n#endif\nattribute vec3 tangent;\nattribute vec3 bitangent;\nuniform mat4 projection;\nuniform mat4 modelViewMatrix;\n#ifdef SHADING\nuniform mat3 normalMatrix; /* internal */\n#ifdef NORMAL_MAP\nuniform mat4 world;\nvarying mat3 tbnMatrixVar;\n#endif\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#endif\nvarying vec2 uvVar;\nvoid main() {\nvec4 positionVec4;\npositionVec4.w=1.0;\npositionVec4.xyz=position;\ngl_PointSize=1.0;\ngl_Position=(projection*modelViewMatrix)*positionVec4;\n#ifdef COLORATTR\ncolorAttrVar=colorAttr;\n#endif\nuvVar=uv;\n#ifdef SHADING\ntransformedNormalVar=normalize(normalMatrix*normal);\n#ifdef NORMAL_MAP\ntbnMatrixVar=mat3(normalize(vec3(world*vec4(tangent,0.0))),\n   normalize(bitangent),transformedNormalVar);\n#endif\nviewPositionVar=modelViewMatrix*positionVec4;\n#endif\n}"};
H3DU.ShaderInfo.getDefaultFragment=function(){var a,b=H3DU.ShaderInfo.fragmentShaderHeader()+"uniform vec4 md;\n#ifdef SHADING\nstruct light {\n vec4 position; /* source light direction/position, in camera/eye space */\n vec4 diffuse; /* source light diffuse color */\n#ifdef SPECULAR\n vec4 specular; /* source light specular color */\n#endif\n vec4 radius; /* light radius */\n};\nuniform vec3 sceneAmbient;\nuniform light lights["+H3DU.Lights.MAX_LIGHTS+"];\nuniform vec3 ma;\nuniform vec3 me;\n#ifdef SPECULAR\nuniform vec3 ms;\nuniform float mshin;\n#ifdef SPECULAR_MAP\nuniform sampler2D specularMap;\n#endif\n#ifdef NORMAL_MAP\nuniform sampler2D normalMap;\n#endif\n#endif\n#endif\n#ifdef TEXTURE\nuniform sampler2D sampler;\n#endif\nvarying vec2 uvVar;\n#ifdef COLORATTR\nvarying vec3 colorAttrVar;\n#endif\n#ifdef SHADING\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\nvec4 calcLightPower(light lt, vec4 vertexPosition) {\n vec3 sdir;\n float attenuation;\n if(lt.position.w == 0.0) { /* directional light */\n  sdir=normalize((lt.position).xyz);\n  attenuation=1.0;\n } else { /* point light */\n  vec3 vertexToLight=(lt.position-vertexPosition).xyz;\n  float dsSquared=dot(vertexToLight,vertexToLight);\n  sdir=inversesqrt(dsSquared)*vertexToLight;\n  if(lt.radius.x == 0.0) {\n    attenuation=1.0; /* Unlimited extent */\n  } else {\n   float radiusPow4=lt.radius.x; /* Radius is light's radius to power of 4 */\n   float distPow4=dsSquared*dsSquared;\n   float attenDivisor=max(0.0001,dsSquared);\n   float cut=clamp(1.0-distPow4/radiusPow4,0.0,1.0);\n   attenuation=(cut*cut)/attenDivisor;\n  }\n }\n return vec4(sdir,attenuation);\n}\n#endif\nvoid main() {\n vec3 normal;\n#ifdef TEXTURE\n   vec4 baseColor=texture2D(sampler,uvVar);\n#else\n#ifdef COLORATTR\n   vec4 baseColor;\n   baseColor.w=1.0;\n   baseColor.xyz=colorAttrVar;\n#else\n   vec4 baseColor=md;\n#endif\n#endif\n#ifdef SHADING\n#ifdef NORMAL_MAP\nnormal = normalize(tbnMatrixVar*(2.0*texture2D(normalMap,uvVar).rgb - vec3(1.0)));\n#else\nnormal = normalize(transformedNormalVar);\n#endif\nvec4 lightPower["+
H3DU.Lights.MAX_LIGHTS+"];\nfloat lightCosines["+H3DU.Lights.MAX_LIGHTS+"];\n",b=b+"if(baseColor.a == 0.0)discard;\nvec3 materialAmbient=ma; /* ambient*/\nvec3 lightedColor=sceneAmbient*materialAmbient; /* ambient*/\n // diffuse\n vec3 materialDiffuse=baseColor.rgb;\n";for(a=0;a<H3DU.Lights.MAX_LIGHTS;a++)b+="lightPower["+a+"]=calcLightPower(lights["+a+"],viewPositionVar);\n",b+=" /* Lambert diffusion term */\n",b+="lightCosines["+a+"]=clamp(dot(normal,lightPower["+a+"].xyz),0.0,1.0);\n",b+="lightedColor+=lights["+
a+"].diffuse.xyz*lightCosines["+a+"]*\n",b+="   lightPower["+a+"].w*materialDiffuse;\n";b+="#ifdef SPECULAR\nbool spectmp;\nvec3 materialSpecular=ms;\n#ifdef SPECULAR_MAP\nmaterialSpecular*=texture2D(specularMap,uvVar).rgb;\n#endif\n// specular reflection\nif(materialSpecular.x!=0. || materialSpecular.y!=0. || materialSpecular.z!=0.) {\nvec3 viewDirection=normalize((-viewPositionVar).xyz);\n";for(a=0;a<H3DU.Lights.MAX_LIGHTS;a++)b+="  spectmp = lightCosines["+a+"] > 0.0;\n  if (spectmp) {\n    /* Blinn-Phong specular term */\n    float specular=clamp(dot(normalize(viewDirection+lightPower["+
a+"].xyz),normal),0.0,1.0);\n    specular=pow(specular,mshin);\n    lightedColor+=materialSpecular*specular*lightPower["+a+"].w*lights["+a+"].specular.xyz;\n  }\n";return b+"}\n#endif\n // emission\n lightedColor+=me;\n baseColor=vec4(lightedColor,baseColor.a);\n#endif\n gl_FragColor=baseColor;\n}"};H3DU.RenderPass3D=function(a,b){this.subScene=a;this.clearStencil=this.clearDepth=this.clearColor=!0;this.frameBuffer=null;this.setParams(b)};
H3DU.RenderPass3D.prototype.setParams=function(a){if(a){"undefined"!==typeof a.clearColor&&(this.clearColor=a.clearColor);"undefined"!==typeof a.clearDepth&&(this.clearDepth=a.clearDepth);"undefined"!==typeof a.clearStencil&&(this.clearStencil=a.clearStencil);if("undefined"!==typeof a.frameBuffer){if(a.frameBuffer instanceof H3DU.FrameBuffer)throw Error("FrameBuffer not supported");this.frameBuffer=a.frameBuffer}return this}};H3DU.ShapeGroup=function(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new H3DU.Transform};H3DU.ShapeGroup.prototype.addShape=function(a){a.parent=this;this.shapes.push(a);return this};H3DU.ShapeGroup.prototype.setVisible=function(a){this.visible=!!a;return this};H3DU.ShapeGroup.prototype.getVisible=function(){return this.visible};H3DU.ShapeGroup.prototype.getTransform=function(){return this.transform};
H3DU.ShapeGroup.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if("undefined"!==typeof this.parent&&null!==this.parent)var c=this.parent.getMatrix(),a=b?H3DU.Math.mat4multiply(c,a.getMatrix()):H3DU.Math.mat4isIdentity(c)?a.getMatrix():c;else a=a.getMatrix();return a};H3DU.ShapeGroup.prototype.setTransform=function(a){this.transform=a.copy();return this};H3DU.ShapeGroup.prototype.setMaterial=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterial(a);return this};
H3DU.ShapeGroup.prototype.setTexture=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setTexture(a);return this};H3DU.ShapeGroup.prototype.setShader=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setShader(a);return this};H3DU.ShapeGroup.prototype.setMaterialParams=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterialParams(a);return this};
H3DU.ShapeGroup.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};
H3DU.ShapeGroup.prototype.getBounds=function(){for(var a=Number.POSITIVE_INFINITY,a=[a,a,a,-a,-a,-a],b=!0,c=0;c<this.shapes.length;c++){var d=this.shapes[c].getBounds();H3DU.Math.boxIsEmpty(d)||(b?(a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=d[3],a[4]=d[4],a[5]=d[5],b=!1):(a[0]=Math.min(d[0],a[0]),a[1]=Math.min(d[1],a[1]),a[2]=Math.min(d[2],a[2]),a[3]=Math.max(d[3],a[3]),a[4]=Math.max(d[4],a[4]),a[5]=Math.max(d[5],a[5])))}return b?[0,0,0,-1,-1,-1]:a};
H3DU.ShapeGroup.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};H3DU.ShapeGroup.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};H3DU.ShapeGroup.prototype.setPosition=function(a,b,c){this.transform.setPosition(a,b,c);return this};H3DU.ShapeGroup.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};
H3DU.ShapeGroup.prototype.setScale=function(a,b,c){this.transform.setScale(a,b,c);return this};H3DU.Mesh=function(a,b,c){this._initialize(a,b,c);this._elementsDefined=0;this.currentMode=-1;this.normal=[0,0,0];this.color=[0,0,0];this.tangent=[0,0,0];this.bitangent=[0,0,0];this.texCoord=[0,0]};H3DU.Mesh._primitiveType=function(a){return a===H3DU.Mesh.LINES||a===H3DU.Mesh.LINE_STRIP?H3DU.Mesh.LINES:a===H3DU.Mesh.POINTS?H3DU.Mesh.POINTS:H3DU.Mesh.TRIANGLES};H3DU.Mesh._isCompatibleMode=function(a,b){return a===b||H3DU.Mesh._primitiveType(a)===H3DU.Mesh._primitiveType(b)?!0:!1};
H3DU.Mesh._recalcNormalsStart=function(a,b,c,d,e,f){for(c=0;c<a.length;c+=d)if(a[c+e]=0,a[c+e+1]=0,a[c+e+2]=0,!f){var g=[a[c],a[c+1],a[c+2]];b[g]?b[g].push(c+e):b[g]=[c+e]}};
H3DU.Mesh._recalcNormalsFinish=function(a,b,c,d,e,f){c=[];var g;if(!f)for(var h in b)if(Object.prototype.hasOwnProperty.call(b,h)){var k=b[h];if(k&&k.constructor===Array&&2<=k.length){f=k[0];var n=a[f],m=a[f+1],l=a[f+2];c[0]=n;c[1]=m;c[2]=l;g=3;for(f=1;f<k.length;f++){for(var p=!1,r=a[k[f]],q=a[k[f]+1],t=a[k[f]+2],w=0;w<g;w+=3)if(r===c[w]&&q===c[w+1]&&t===c[w+2]){p=!0;break}p||(c[g++]=r,c[g++]=q,c[g++]=t,n+=r,m+=q,l+=t)}for(f=0;f<k.length;f++)a[k[f]]=n,a[k[f]+1]=m,a[k[f]+2]=l}}for(f=0;f<a.length;f+=
d)if(h=a[f+e],c=a[f+e+1],k=a[f+e+2],b=Math.sqrt(h*h+c*c+k*k))b=1/b,a[f+e]=h*b,a[f+e+1]=c*b,a[f+e+2]=k*b};
H3DU.Mesh._recalcNormals=function(a,b,c,d,e,f){f=f?-1:1;var g={},h;H3DU.Mesh._recalcNormalsStart(a,g,b,c,d,e);for(var k=0;k<b.length;k+=3){var n=b[k]*c,m=b[k+1]*c,l=b[k+2]*c;h=[a[n]-a[l],a[n+1]-a[l+1],a[n+2]-a[l+2]];var p=[a[m]-a[l],a[m+1]-a[l+1],a[m+2]-a[l+2]],r=h[1]*p[2]-h[2]*p[1],q=h[2]*p[0]-h[0]*p[2],p=h[0]*p[1]-h[1]*p[0];h=Math.sqrt(r*r+q*q+p*p);0!==h&&(h=1/h,h*=f,r*=h,q*=h,p*=h,a[n+d]+=r,a[n+d+1]+=q,a[n+d+2]+=p,a[m+d]+=r,a[m+d+1]+=q,a[m+d+2]+=p,a[l+d]+=r,a[l+d+1]+=q,a[l+d+2]+=p)}H3DU.Mesh._recalcNormalsFinish(a,
g,b,c,d,e)};H3DU.Mesh.prototype.mode=function(a){if(0>a)throw Error("invalid mode");if(-1===this.currentMode){var b=0,c=H3DU.Mesh._primitiveType(a);c===H3DU.Mesh.LINES?b|=H3DU.Mesh.LINES_BIT:c===H3DU.Mesh.POINTS&&(b|=H3DU.Mesh.POINTS_BIT);this._initialize([],[],b);this.currentMode=a}else if(H3DU.Mesh._isCompatibleMode(this.currentMode,a))this.newPrimitive(),this.currentMode=a;else throw Error("Storing a different primitive mode in this mesh is no longer supported");return this};
H3DU.Mesh.prototype.merge=function(a){if(!H3DU.Mesh._isCompatibleMode(this.currentMode,a.currentMode))throw Error("Meshes have incompatible types");var b=this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS,c=a.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS;b!==c&&(b|=c,b===c?this._rebuildVertices(b):(b=new H3DU.Mesh,b.currentMode=a.currentMode,b._rebuildVertices(c),b.merge(a),a=b));c=this.vertexCount();b=this.indices.length;this.vertices.push.apply(this.vertices,a.vertices);this.indices.push.apply(this.indices,
a.indices);for(a=b;a<this.indices.length;a++)this.indices[a]+=c;this.newPrimitive();return this};H3DU.Mesh.prototype.normal3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.normal[0]=a,this.normal[1]=b,this.normal[2]=c):(this.normal[0]=a[0],this.normal[1]=a[1],this.normal[2]=a[2]);this._elementsDefined|=H3DU.Mesh.NORMALS_BIT;return this};
H3DU.Mesh.prototype.tangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.tangent[0]=a,this.tangent[1]=b,this.tangent[2]=c):(this.tangent[0]=a[0],this.tangent[1]=a[1],this.tangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.TANGENTS_BIT;return this};
H3DU.Mesh.prototype.bitangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.bitangent[0]=a,this.bitangent[1]=b,this.bitangent[2]=c):(this.bitangent[0]=a[0],this.bitangent[1]=a[1],this.bitangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.BITANGENTS_BIT;return this};
H3DU.Mesh.prototype.color3=function(a,b,c){"string"===typeof a?(a=H3DU.toGLColor(a),this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]):"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.color[0]=a,this.color[1]=b,this.color[2]=c):(this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]);this._elementsDefined|=H3DU.Mesh.COLORS_BIT;return this};
H3DU.Mesh.prototype.texCoord2=function(a,b){"number"===typeof a&&"number"===typeof b?(this.texCoord[0]=a,this.texCoord[1]=b):(this.texCoord[0]=a[0],this.texCoord[1]=a[1]);this._elementsDefined|=H3DU.Mesh.TEXCOORDS_BIT;return this};H3DU.Mesh.prototype.vertex3=function(a,b,c){null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?this._vertex3(a,b,c,this):"number"!==typeof a?this._vertex3(a[0],a[1],a[2],this):this._vertex3(a,a,a,this);return this};
H3DU.Mesh.prototype.vertex2=function(a,b){return null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b?this.vertex3(a,b,0):"number"!==typeof a?this.vertex3(a[0],a[1],0):this.vertex3(a,a,0)};
H3DU.Mesh.prototype.setColor3=function(a,b,c){var d=a;"string"===typeof a&&(a=H3DU.toGLColor(a),d=a[0],b=a[1],c=a[2]);this._rebuildVertices(H3DU.Mesh.COLORS_BIT);a=this.getStride();for(var e=H3DU.Mesh._colorOffset(this.attributeBits);e<this.vertices.length;e+=a)this.vertices[e]=d,this.vertices[e+1]=b,this.vertices[e+2]=c;return this};
H3DU.Mesh.prototype.normalizeNormals=function(){var a,b=this.getStride(),c=this.vertices,d=H3DU.Mesh._normalOffset(this.attributeBits);if(0>d)return this;for(a=0;a<c.length;a+=b){var e=c[a+d],f=c[a+d+1],g=c[a+d+2],e=Math.sqrt(e*e+f*f+g*g);0!==e&&(e=1/e,c[a+d]*=e,c[a+d+1]*=e,c[a+d+2]*=e)}return this};
H3DU.Mesh.prototype.setVertex=function(a,b,c,d){if(0>a)return this;"undefined"===typeof c&&"undefined"===typeof d&&(c=b[1],d=b[2],b=b[0]);var e=this.vertexCount();a<e&&(a*=this.getStride(),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=d);return this};
H3DU.Mesh.prototype.setVertexNormal=function(a,b,c,d){if(0>a)return this;"undefined"===typeof c&&"undefined"===typeof d&&(c=b[1],d=b[2],b=b[0]);var e=this.vertexCount();a<e&&(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),a+=H3DU.Mesh._normalOffset(this.attributeBits),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=d);return this};
H3DU.Mesh.prototype.getVertex=function(a){if(0>a)return null;var b=this.vertexCount();return a<b?(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),this.vertices.slice(a,a+3)):null};H3DU.Mesh.prototype.getVertexNormal=function(a){var b=this.vertexCount();return a<b?(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),a+=H3DU.Mesh._normalOffset(this.attributeBits),this.vertices.slice(a,a+3)):null};
H3DU.Mesh.prototype._initialize=function(a,b,c){this.vertices=a||[];this.indices=b||[];this.startIndex=0;a=c&H3DU.Mesh.PRIMITIVES_BITS;if(0!==a&&a!==H3DU.Mesh.LINES_BIT&&a!==H3DU.Mesh.POINTS_BIT)throw Error("invalid format");this.attributeBits=null===c||"undefined"===typeof c?0:c;this.vertexCount=function(){return this.vertices.length/this.getStride()};this.getStride=function(){return H3DU.Mesh._getStride(this.attributeBits)};this.newPrimitive=function(){this.startIndex=this.vertices.length;return this};
this.primitiveType=function(){var a=H3DU.Mesh.TRIANGLES;0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)&&(a=H3DU.Mesh.LINES);0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)&&(a=H3DU.Mesh.POINTS);return a};this._rebuildVertices=function(a){var b=this.attributeBits;a=b|a&H3DU.Mesh.ATTRIBUTES_BITS;if(a!==b){for(var c=this.getStride(),d,h,k,n=[],m=0;m<this.vertices.length;m+=c){var l=m+3;n.push(this.vertices[m],this.vertices[m+1],this.vertices[m+2]);0!==(a&H3DU.Mesh.NORMALS_BIT)&&(0!==(b&H3DU.Mesh.NORMALS_BIT)?
(d=this.vertices[l],h=this.vertices[l+1],k=this.vertices[l+2],l+=3,n.push(d,h,k)):n.push(0,0,0));0!==(a&H3DU.Mesh.COLORS_BIT)&&(0===(b&H3DU.Mesh.COLORS_BIT)?n.push(0,0,0):(d=this.vertices[l],h=this.vertices[l+1],k=this.vertices[l+2],l+=3,n.push(d,h,k)));0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(0===(b&H3DU.Mesh.TEXCOORDS_BIT)?n.push(0,0):(d=this.vertices[l],h=this.vertices[l+1],l+=2,n.push(d,h)));0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(0===(b&H3DU.Mesh.TANGENTS_BIT)?n.push(0,0,0):(d=this.vertices[l],h=this.vertices[l+
1],k=this.vertices[l+2],l+=3,n.push(d,h,k)));0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(0===(b&H3DU.Mesh.BITANGENTS_BIT)?n.push(0,0,0):(d=this.vertices[l],h=this.vertices[l+1],k=this.vertices[l+2],n.push(d,h,k)))}this.vertices=n;this.attributeBits=a}};this._setTriangle=function(a,b,c,g,h){var d=c*b,e=g*b,f=h*b,l=0,p=this.vertices;for(a-=b;0<=a&&16>l;a-=b,l++){for(var r=7,q=0;q<b&&0!==r;q++)0!==(r&1)&&p[d+q]!==p[a+q]&&(r&=-2),0!==(r&2)&&p[e+q]!==p[a+q]&&(r&=-3),0!==(r&4)&&p[f+q]!==p[a+q]&&(r&=-5);if(0!==(r&
1)){c=a/b;d=c*b;break}if(0!==(r&2)){g=a/b;e=g*b;break}if(0!==(r&4)){h=a/b;f=h*b;break}}p[d]===p[e]&&p[d+1]===p[e+1]&&p[d+2]===p[e+2]||p[d]===p[f]&&p[d+1]===p[f+1]&&p[d+2]===p[f+2]||p[e]===p[f]&&p[e+1]===p[f+1]&&p[e+2]===p[f+2]||this.indices.push(c,g,h)};this._vertex3=function(a,b,c){var d=this.currentMode;if(-1===d)throw Error("mode() not called");this._rebuildVertices(this._elementsDefined);var e=this.vertices.length;this.vertices.push(a,b,c);0!==(this.attributeBits&H3DU.Mesh.NORMALS_BIT)&&this.vertices.push(this.normal[0],
this.normal[1],this.normal[2]);0!==(this.attributeBits&H3DU.Mesh.COLORS_BIT)&&this.vertices.push(this.color[0],this.color[1],this.color[2]);0!==(this.attributeBits&H3DU.Mesh.TEXCOORDS_BIT)&&this.vertices.push(this.texCoord[0],this.texCoord[1]);0!==(this.attributeBits&H3DU.Mesh.TANGENTS_BIT)&&this.vertices.push(this.tangent[0],this.tangent[1],this.tangent[2]);0!==(this.attributeBits&H3DU.Mesh.BITANGENTS_BIT)&&this.vertices.push(this.bitangent[0],this.bitangent[1],this.bitangent[2]);a=this.getStride();
d===H3DU.Mesh.QUAD_STRIP&&this.vertices.length-this.startIndex>=4*a&&0===(this.vertices.length-this.startIndex)%(2*a)?(d=this.vertices.length/a-4,this._setTriangle(e,a,d,d+1,d+2),this._setTriangle(e,a,d+2,d+1,d+3)):d===H3DU.Mesh.QUADS&&0===(this.vertices.length-this.startIndex)%(4*a)?(d=this.vertices.length/a-4,this._setTriangle(e,a,d,d+1,d+2),this._setTriangle(e,a,d,d+2,d+3)):d===H3DU.Mesh.TRIANGLES&&0===(this.vertices.length-this.startIndex)%(3*a)?(d=this.vertices.length/a-3,this._setTriangle(e,
a,d,d+1,d+2)):d===H3DU.Mesh.LINES&&0===(this.vertices.length-this.startIndex)%(2*a)?(d=this.vertices.length/a-2,this.indices.push(d,d+1)):d===H3DU.Mesh.TRIANGLE_FAN&&this.vertices.length-this.startIndex>=3*a?(d=this.vertices.length/a-2,b=this.startIndex/a,this._setTriangle(e,a,b,d,d+1)):d===H3DU.Mesh.LINE_STRIP&&this.vertices.length-this.startIndex>=2*a?(d=this.vertices.length/a-2,this.indices.push(d,d+1)):d===H3DU.Mesh.POINTS?(d=this.vertices.length/a-1,this.indices.push(d)):d===H3DU.Mesh.TRIANGLE_STRIP&&
this.vertices.length-this.startIndex>=3*a&&(d=this.vertices.length/a-3,b=this.startIndex/a,0===(d-b&1)?this._setTriangle(e,a,d,d+1,d+2):this._setTriangle(e,a,d+1,d,d+2));return this}};H3DU.Mesh.prototype._makeRedundant=function(){for(var a=[],b=this.getStride(),c=this.indices.length,d=0;d<c;d++){var e=this.indices[d];if(a[e]){for(var f=e*b,g=this.vertices.length/b,h=0;h<b;h++)this.vertices.push(this.vertices[f+h]);this.indices[d]=g}a[e]=!0}return this};
H3DU.Mesh.prototype.primitiveCount=function(){return 0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};H3DU.Mesh._addLine=function(a,b,c,d){if(c<d){var e=c;c=d;d=e}(e=b[c])?0>e.indexOf(d)&&(e.push(d),a.push(c,d)):(b[c]=[d],a.push(c,d))};
H3DU.Mesh.prototype.toWireFrame=function(){if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var a=[],b={},c=0;c<this.indices.length;c+=3){var d=this.indices[c],e=this.indices[c+1],f=this.indices[c+2];H3DU.Mesh._addLine(a,b,d,e);H3DU.Mesh._addLine(a,b,e,f);H3DU.Mesh._addLine(a,b,f,d)}return new H3DU.Mesh(this.vertices,a,this.attributeBits|H3DU.Mesh.LINES_BIT)};
H3DU.Mesh._isIdentityInUpperLeft=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[8]&&0===a[9]&&1===a[10]};
H3DU.Mesh.prototype.transform=function(a){var b=this.getStride(),c=this.vertices,d=!H3DU.Mesh._isIdentityInUpperLeft(a),e=H3DU.Mesh._normalOffset(this.attributeBits),f=null;0<=e&&d&&(f=H3DU.Math.mat4inverseTranspose3(a));for(var g=0;g<c.length;g+=b){var h=H3DU.Math.mat4transform(a,c[g],c[g+1],c[g+2],1);c[g]=h[0];c[g+1]=h[1];c[g+2]=h[2];0<=e&&d&&(h=H3DU.Math.mat3transform(f,c[g+e],c[g+e+1],c[g+e+2]),H3DU.Math.vec3normInPlace(h),c[g+e]=h[0],c[g+e+1]=h[1],c[g+e+2]=h[2])}this.newPrimitive();return this};
H3DU.Mesh.prototype.enumPrimitives=function(a){var b=this.primitiveType(),c=H3DU.Mesh._normalOffset(this.attributeBits),d=H3DU.Mesh._colorOffset(this.attributeBits),e=H3DU.Mesh._texCoordOffset(this.attributeBits),f=this.getStride(),g=this.vertices,h=3;b===H3DU.Mesh.LINES&&(h=2);b===H3DU.Mesh.POINTS&&(h=1);for(b=0;b<this.indices.length;b+=h){for(var k=[],n=0;n<h;n++){var m=this.indices[b+n]*f,l={};l.position=[g[m],g[m+1],g[m+2]];0<=c&&(l.normal=[g[m+c],g[m+c+1],g[m+c+2]]);0<=d&&(l.color=[g[m+d],g[m+
d+1],g[m+d+2]]);0<=e&&(l.uv=[g[m+e],g[m+e+1]]);k.push(l)}a(k)}return this};H3DU.Mesh.prototype.getBoundingBox=function(){for(var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this.getStride(),d=this.vertices,e=0;e<this.indices.length;e++){var f=this.indices[e]*c;a?(a=!1,b[0]=b[3]=d[f],b[1]=b[4]=d[f+1],b[2]=b[5]=d[f+2]):(b[0]=Math.min(b[0],d[f]),b[3]=Math.max(b[3],d[f]),b[1]=Math.min(b[1],d[f+1]),b[4]=Math.max(b[4],d[f+1]),b[2]=Math.min(b[2],d[f+2]),b[5]=Math.max(b[5],d[f+2]))}return b};
H3DU.Mesh._findTangentAndBitangent=function(a,b,c,d,e){var f=a[c]-a[b],g=a[c+1]-a[b+1],h=a[c+2]-a[b+2],k=a[d]-a[b],n=a[d+1]-a[b+1],m=a[d+2]-a[b+2],l=a[c+e]-a[b+e],p=a[c+e+1]-a[b+e+1];c=a[d+e]-a[b+e];a=a[d+e+1]-a[b+e+1];b=l*a-p*c;if(0===b)return[0,0,0,0,0,0];b=1/b;p=-p;c=-c;return[(a*f+p*k)*b,(a*g+p*n)*b,(a*h+p*m)*b,(c*f+l*k)*b,(c*g+l*n)*b,(c*h+l*m)*b]};
H3DU.Mesh._recalcTangentsInternal=function(a,b,c,d,e,f){for(var g=[0,0,0],h=0;h<b.length;h+=3){g[0]=b[h]*c;g[1]=b[h+1]*c;g[2]=b[h+2]*c;for(var k=H3DU.Mesh._findTangentAndBitangent(a,g[0],g[1],g[2],d),n=0;3>n;n++){var m=k,l=g[n],p=a[l+e],r=a[l+e+1],q=a[l+e+2],t=m[0]*p+m[1]*r+m[2]*q,t=H3DU.Math.vec3normInPlace([m[0]-t*p,m[1]-t*r,m[2]-t*q]),w=m[3]*p+m[4]*r+m[5]*q,x=m[3]*t[0]+m[4]*t[1]+m[5]*t[2],m=H3DU.Math.vec3normInPlace([m[3]-w*p-x*t[0],m[4]-w*r-x*t[1],m[5]-w*q-x*t[2]]);a[l+f]=t[0];a[l+f+1]=t[1];a[l+
f+2]=t[2];a[l+f+3]=m[0];a[l+f+4]=m[1];a[l+f+5]=m[2]}}};
H3DU.Mesh.prototype.recalcTangents=function(){if(this.primitiveType()!==H3DU.Mesh.TRIANGLES)return this;var a=H3DU.Mesh.TANGENTS_BIT|H3DU.Mesh.BITANGENTS_BIT,b=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~a),c=H3DU.Mesh._texCoordOffset(this.attributeBits),d=H3DU.Mesh._normalOffset(this.attributeBits);if(0>c||0>d)return this;this._rebuildVertices(a);b&&this._makeRedundant();this.primitiveType()===H3DU.Mesh.TRIANGLES&&(a=H3DU.Mesh._tangentOffset(this.attributeBits),H3DU.Mesh._recalcTangentsInternal(this.vertices,
this.indices,this.getStride(),c,d,a));return this};H3DU.Mesh.prototype.reverseNormals=function(){var a,b=this.getStride(),c=this.vertices,d=H3DU.Mesh._normalOffset(this.attributeBits);if(0>d)return this;for(a=0;a<c.length;a+=b){var e=c[a+d+1],f=c[a+d+2];c[a+d]=-c[a+d];c[a+d+1]=-e;c[a+d+2]=-f}return this};
H3DU.Mesh.prototype.reverseWinding=function(){if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var a=0;a<this.indices.length;a+=3){var b=this.indices[a+2];this.indices[a+2]=this.indices[a+1];this.indices[a+1]=b}return this};
H3DU.Mesh.prototype.recalcNormals=function(a,b){var c=this.primitiveType();c!==H3DU.Mesh.LINES&&c!==H3DU.Mesh.POINTS&&(c=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~H3DU.Mesh.NORMALS_BIT),this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),(c||a)&&this._makeRedundant(),H3DU.Mesh._recalcNormals(this.vertices,this.indices,this.getStride(),3,a,b));return this};
H3DU.Mesh._getStride=function(a){var b=[3,6,6,9,5,8,8,11][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)];0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(b+=3);return b};H3DU.Mesh._normalOffset=function(a){return[-1,3,-1,3,-1,3,-1,3][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};
H3DU.Mesh._tangentOffset=function(a){var b=3;if(0===(a&H3DU.Mesh.TANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(b+=2);return b};H3DU.Mesh._bitangentOffset=function(a){var b=3;if(0===(a&H3DU.Mesh.BITANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(b+=2);0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(b+=3);return b};
H3DU.Mesh._colorOffset=function(a){return[-1,-1,3,6,-1,-1,3,6][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh._texCoordOffset=function(a){return[-1,-1,-1,-1,3,6,6,9][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh.ATTRIBUTES_BITS=255;H3DU.Mesh.PRIMITIVES_BITS=768;H3DU.Mesh.NORMALS_BIT=1;H3DU.Mesh.COLORS_BIT=2;H3DU.Mesh.TEXCOORDS_BIT=4;H3DU.Mesh.TANGENTS_BIT=8;H3DU.Mesh.BITANGENTS_BIT=16;H3DU.Mesh.LINES_BIT=256;
H3DU.Mesh.POINTS_BIT=512;H3DU.Mesh.TRIANGLES=4;H3DU.Mesh.QUAD_STRIP=8;H3DU.Mesh.QUADS=7;H3DU.Mesh.LINES=1;H3DU.Mesh.TRIANGLE_FAN=6;H3DU.Mesh.TRIANGLE_STRIP=5;H3DU.Mesh.LINE_STRIP=3;H3DU.Mesh.POINTS=0;this.H3DU.Mesh=H3DU.Mesh;H3DU.TextureLoader=function(){this.loadedTextures=[];this.textureImages={};this.maxAnisotropy=[];this.fbLoader=new H3DU.FrameBufferLoader};H3DU.TextureLoader.prototype.getTexture=function(a){return this.textureImages[a]||null};H3DU.TextureLoader.prototype.loadTexture=function(a){return H3DU.Texture.loadTexture(a,this.textureImages)};
H3DU.TextureLoader.prototype._setMaxAnisotropy=function(a){a=a.getContext?a.getContext():a;for(var b=this.maxAnisotropy,c=0;c<b.length;c++)if(b[c][0]===a)if(0<=b[c][2])a.texParameteri(a.TEXTURE_2D,b[c][2],b[c][1]);else return;var d=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic");if(d)return c=d.TEXTURE_MAX_ANISOTROPY_EXT,d=a.getParameter(d.MAX_TEXTURE_MAX_ANISOTROPY_EXT),b.push([a,d,c]),
a.texParameteri(a.TEXTURE_2D,c,d),d;b.push([a,1,-1,null]);return 1};H3DU.TextureLoader.prototype.loadTexturesAll=function(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(this.loadTexture(a[e]));return H3DU.getPromiseResultsAll(d,b,c)};H3DU.TextureLoader.prototype.loadAndMapTexture=function(a,b){b=b.getContext?b.getContext():b;var c=this;return this.loadTexture(a).then(function(a){c.mapTexture(a,b);return Promise.resolve(a)})};
H3DU.TextureLoader.prototype.loadAndMapTexturesAll=function(a,b,c,d){b=b.getContext?b.getContext():b;for(var e=[],f=0;f<a.length;f++)e.push(this.loadAndMapTexture(a[f],b));return H3DU.getPromiseResultsAll(e,c,d)};H3DU.TextureLoader.prototype.mapTextures=function(a,b){b=b.getContext?b.getContext():b;for(var c=0;c<a.length;c++)this.mapTexture(a[c],b);return this};
H3DU.TextureLoader.prototype.mapTexture=function(a,b){b=b.getContext?b.getContext():b;for(var c=this.loadedTextures,d=0;d<c.length;d++)if(c[d][0]===a&&c[d][1]===b)return c[d][2];d=new H3DU._LoadedTexture(a,b);c.push([a,b,d]);return d};H3DU.TextureLoader.prototype.mapFrameBuffer=function(a,b){b=b.getContext?b.getContext():b;return this.fbLoader.mapFrameBuffer(a,b)};H3DU.TextureLoader.prototype.bindFrameBuffer=function(a,b){b=b.getContext?b.getContext():b;this.fbLoader.bind(a,b)};
H3DU.TextureLoader.prototype.unbindFrameBuffer=function(a,b){b=b.getContext?b.getContext():b;this.fbLoader.unbind(a,b)};
H3DU.TextureLoader.prototype.dispose=function(){for(var a in this.textureImages)Object.prototype.hasOwnProperty.call(this.textureImages,a)&&this.textureImages[a].dispose();a=this.loadedTextures;for(var b=0;b<a.length;b++)this.loadedTextures[b][2].dispose();"undefined"!==typeof this.fbLoader&&null!==this.fbLoader||this.fbLoader.dispose();this.fbLoader=null;this.textureImages={};this.loadedTextures=[];this.maxAnisotropy=[]};H3DU.LightSource=function(a,b,c,d){this.ambient=b||[0,0,0,1];this.position=a?[a[0],a[1],a[2],1]:[0,0,1,0];this.diffuse=c||[1,1,1,1];this.specular=d||[1,1,1];this.radius=0};
H3DU.LightSource.prototype.setParams=function(a){"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),this.ambient=this.ambient.slice(0,4));if("undefined"!==typeof a.position&&null!==a.position){var b=a.position;this.position=[b[0],b[1],b[2],null===b[3]?0:b[3]]}"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular));"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse));"undefined"!==typeof a.radius&&
null!==a.radius&&(this.radius=a.radius);return this};H3DU.MeshBuffer=function(a){this._bounds=a.getBoundingBox();var b=new Float32Array(a.vertices);65536<=a.vertices.length||65536<=a.indices.length?(this.indexBufferSize=4,this.indices=new Uint32Array(a.indices)):256>=a.vertices.length&&256>=a.indices.length?(this.indexBufferSize=1,this.indices=new Uint8Array(a.indices)):(this.indexBufferSize=2,this.indices=new Uint16Array(a.indices));this.format=a.attributeBits;var c=H3DU.Mesh._getStride(this.format);this.numVertices=a.vertices.length/c;this.facesLength=
a.indices.length;this.attributes=[];this.attributes.push(["position",0,b,3,c]);a=H3DU.Mesh._normalOffset(this.format);0<=a&&this.attributes.push(["normal",a,b,3,c]);a=H3DU.Mesh._colorOffset(this.format);0<=a&&this.attributes.push(["colorAttr",a,b,3,c]);a=H3DU.Mesh._texCoordOffset(this.format);0<=a&&this.attributes.push(["uv",a,b,2,c]);a=H3DU.Mesh._tangentOffset(this.format);0<=a&&this.attributes.push(["tangent",a,b,3,c]);a=H3DU.Mesh._bitangentOffset(this.format);0<=a&&this.attributes.push(["bitangent",
a,b,3,c])};H3DU.MeshBuffer.prototype.setAttribute=function(a,b,c,d,e){b.constructor===Array&&(b=new Float32Array(b));var f=this._getAttribute(a);f?(f[1]=c,f[2]=b,f[3]=d,f[4]=e):this.attributes.push([a,c,b,d,e]);return this};H3DU.MeshBuffer.prototype._getAttributes=function(){return this.attributes};H3DU.MeshBuffer.prototype._getAttribute=function(a){for(var b=0;b<this.attributes.length;b++)if(this.attributes[b][0]===a)return this.attributes[b];return null};
H3DU.MeshBuffer.prototype.primitiveCount=function(){return 0!==(this.format&H3DU.Mesh.LINES_BIT)?Math.floor(this.facesLength/2):0!==(this.format&H3DU.Mesh.POINTS_BIT)?this.facesLength:Math.floor(this.facesLength/3)};
H3DU.MeshBuffer.prototype.getBounds=function(){if(!this._bounds){var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this._getAttribute("position");if(!c||3>c[3])return b;for(var d=c[4],e=c[2],c=c[1],f=0;f<this.indices.length;f++){var g=this.indices[f]*d+c;a?(a=!1,b[0]=b[3]=e[g],b[1]=b[4]=e[g+1],b[2]=b[5]=e[g+2]):(b[0]=Math.min(b[0],e[g]),b[3]=Math.max(b[3],e[g]),b[1]=Math.min(b[1],e[g+1]),b[4]=Math.max(b[4],e[g+1]),b[2]=Math.min(b[2],e[g+2]),b[5]=Math.max(b[5],e[g+2]))}}return this._bounds};
H3DU.MeshBuffer.prototype.primitiveType=function(){return 0!==(this.format&H3DU.Mesh.LINES_BIT)?H3DU.Mesh.LINES:0!==(this.format&H3DU.Mesh.POINTS_BIT)?H3DU.Mesh.POINTS:H3DU.Mesh.TRIANGLES};H3DU.MeshBuffer.prototype.getFormat=function(){return this.format};H3DU.MeshBuffer.prototype.vertexCount=function(){return this.numVertices};var BezierCurve=H3DU.BezierCurve,BezierSurface=H3DU.BezierSurface,BSplineCurve=H3DU.BezierCurve,BSplineSurface=H3DU.BezierSurface,GLUtil=H3DU,GLMath=H3DU.Math,CurveEval=H3DU.CurveEval,SurfaceEval=H3DU.SurfaceEval,Lights=H3DU.Lights,LightSource=H3DU.LightSource,Material=H3DU.Material,Mesh=H3DU.Mesh,Meshes=H3DU.Meshes,Scene3D=H3DU.Scene3D,ShaderProgram=H3DU.ShaderProgram,Shape=H3DU.Shape,ShapeGroup=H3DU.ShapeGroup,Texture=H3DU.Texture,TextureLoader=H3DU.TextureLoader,Transform=H3DU.Transform,ShaderInfo=
H3DU.ShaderInfo,RenderPass3D=H3DU.RenderPass3D;
