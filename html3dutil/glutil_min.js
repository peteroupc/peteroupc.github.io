(function(a,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(a)})(this,function(a){if(!a.Promise){var c=function(b){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];b&&this._invokeResolver(b)};c.resolve=function(b){return new this(function(a,c){a(b)})};c.reject=function(b){return new this(function(a,c){c(b)})};c.all=c.when=function(b){return new this(function(a,c){var d=0,g=[];b.forEach(function(b,
k){d++;b.then(function(b){g[k]=b;d--;d||a(g)},function(b){d=1/0;c(b)})})})};c.race=function(b){return new this(function(a,c){b.forEach(function(b){b.then(a,c)})})};c.prototype.then=function(b,a){this._cb.fulfilled.push(b);this._cb.rejected.push(a);var f=new c;this._thenPromises.push(f);0<this._state&&this._schedule();return f};c.prototype.fulfill=function(b){if(0!==this._state)return this;this._state=1;this._value=b;this._thenPromises.length&&this._schedule();return this};c.prototype.reject=function(b){if(0!==
this._state)return this;this._state=2;this._value=b;this._thenPromises.length&&this._schedule();return this};c.prototype.resolve=function(b){if(b===this)this.reject(new TypeError("Promise resolved by its own instance"));else if(b instanceof this.constructor)b.chain(this);else{var a;if(null===b||"undefined"===typeof b||"object"!==typeof b&&"function"!==typeof b)this.fulfill(b);else{try{a=b.then}catch(c){this.reject(c);return}if("function"===typeof a){var f=!1,d=function(b){f||(f=!0,this.resolve(b))},
g=function(b){f||(f=!0,this.reject(b))};try{a.call(b,d.bind(this),g.bind(this))}catch(c){f||this.reject(c)}}else this.fulfill(b)}}};c.prototype.chain=function(b){return this.then(function(a){b.resolve(a)},function(a){b.reject(a)})};c.prototype["catch"]=function(b){return this.then(null,b)};c.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};c.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var b=this._cb.fulfilled.shift(),
a=this._cb.rejected.shift();this._executeCallback(1===this._state?b:a)}};c.prototype._executeCallback=function(b){var a=this._thenPromises.shift();if("function"!==typeof b)1===this._state?a.fulfill(this._value):a.reject(this._value);else try{var c=b(this._value);a.resolve(c)}catch(d){a.reject(d)}};c.prototype._invokeResolver=function(b){try{b(this.resolve.bind(this),this.reject.bind(this))}catch(a){this.reject(a)}};a.Promise=c}});/*
 CC0-1.0
*/
(function(a,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(a)})(this,function(a){if(!a.H3DU){window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimationFrame||(window.requestAnimationFrame=function(b){window.setTimeout(function(){b(window.performance.now())},17)}));window.performance||(window.performance={});window.performance.now||
(window.performance.now=function(){return 1E3*(new Date).getTime()-window.performance._startTime},window.performance._startTime=1E3*(new Date).getTime());var c={renderLoop:function(b){b(window.performance.now());var a=function(c){window.requestAnimationFrame(a);b(c)};window.requestAnimationFrame(a)},createCanvasElement:function(b,a,c){var d=document.createElement("canvas");b&&b.appendChild(d);if(null===a||"undefined"===typeof a)d.width=Math.ceil(d.clientWidth)+"";else{if(0>a)throw Error("width negative");
d.width=Math.ceil(a)+""}if(null===c||"undefined"===typeof c)d.height=Math.ceil(d.clientHeight)+"";else{if(0>c)throw Error("height negative");d.height=Math.ceil(c)+""}return d},get3DOr2DContext:function(b){if(!b||!b.getContext)return null;var a=null,f={preserveDrawingBuffer:!0,alpha:!1};f.antialias=window.devicePixelRatio&&1<window.devicePixelRatio?!1:!0;try{a=b.getContext("webgl",f)}catch(d){a=null}if(!a)try{a=b.getContext("experimental-webgl",f)}catch(d){a=null}if(!a)try{a=b.getContext("moz-webgl",
f)}catch(d){a=null}if(!a)try{a=b.getContext("webkit-3d",f)}catch(d){a=null}if(!a)try{a=b.getContext("2d",f)}catch(d){a=null}c.is3DContext(a)&&(a.getExtension("OES_element_index_uint"),a.getExtension("OES_standard_derivatives"));return a},get3DContext:function(b,a){var f=c.get3DOr2DContext(b),d=null;!f&&window.WebGLShader?d="Failed to initialize graphics support required by this page.":window.WebGLShader&&!c.is3DContext(f)?d="This page requires WebGL, but it failed to start. Your computer might not support WebGL.":
f&&c.is3DContext(f)||(d="This page requires a WebGL-supporting browser.");return d?((a||window.alert)(d),null):f},is3DContext:function(b){return b&&"compileShader"in b},getPromiseResultsAll:function(b,a,f){return c.getPromiseResults(b,a,f).then(function(b){return 0<b.failures.length?Promise.reject(b):Promise.resolve(b.successes)})},getPromiseResults:function(b,a,c){function d(b,a,e){return function(c){b&&b(c);a.successes[e]=c;return!0}}function g(b,a,e){return function(c){b&&b(c);a.failures[e]=c;
return!0}}if(!b||0===b.length)return Promise.resolve({successes:[],failures:[],results:[]});for(var h={successes:[],failures:[],results:[]},k=[],l=0;l<b.length;l++){var m=l;k.push(b[l].then(d(a,h,m),g(c,h,m)))}return Promise.all(k).then(function(b){for(var a=0;a<h.successes.length;a++)"undefined"===typeof h.successes[a]&&(h.successes.splice(a,1),--a);for(a=0;a<h.failures.length;a++)"undefined"===typeof h.failures[a]&&(h.failures.splice(a,1),--a);h.results=b;return Promise.resolve(h)})},loadFileFromUrl:function(b,
a){var c=a||"text";return new Promise(function(a,e){var h=new XMLHttpRequest;h.onreadystatechange=function(h){h=h.target;if(4===h.readyState)if(200<=h.status&&300>h.status){var l="",l="xml"===c?h.responseXML:"json"===c?"response"in h?h.response:JSON.parse(h.responseText):"arraybuffer"===c?h.response:h.responseText+"";a({url:b,data:l})}else e({url:b})};h.onerror=function(a){e({url:b,error:a})};h.open("get",b,!0);h.responseType=c;h.send()})},getTimePosition:function(b,a,c){if("undefined"===typeof b.time||
null===b.time)return b.time=a,b.lastTime=a,0;if("undefined"===typeof b.lastTime||null===b.lastTime)b.lastTime=a;return 1*(a-b.time)%c/c},newFrames:function(b,a){if("undefined"===typeof b.time||null===b.time)return b.time=a,b.lastTime=a,0;if("undefined"===typeof b.lastTime||null===b.lastTime)return b.lastTime=a,0;var c=a-b.lastTime;b.lastTime=a;return 60*c/1E3}};(function(b){var a=function(b){var a=1*b[0],e=1*b[1],c=1*b[2],e=0>e?0:255<e?255:e,c=0>c?0:255<c?255:c;if(0===c)return[e,e,e];b=0;b=127.5>=
e?e*(255+c)/255:e+c-e*c/255;var f=2*e-b;if(0>a||360<=a)a=(a%360+360)%360;var d=a+120;360<=d&&(d-=360);e=60>d?f+(b-f)*d/60:180>d?b:240>d?f+(b-f)*(240-d)/60:f;d=a;c=60>d?f+(b-f)*d/60:180>d?b:240>d?f+(b-f)*(240-d)/60:f;d=a-120;0>d&&(d+=360);a=60>d?f+(b-f)*d/60:180>d?b:240>d?f+(b-f)*(240-d)/60:f;return[0>e?0:255<e?255:e,0>c?0:255<c?255:c,0>a?0:255<a?255:a]},c=function(b){function d(b){var a;return 255*(0>(a=parseFloat(b))?0:100<a?100:a)/100}function m(b){var a;return 255*(0>(a=parseFloat(b))?0:1<a?1:
a)}function n(b){var a;return 0>(a=parseInt(b,10))?0:255<a?255:a}function p(b){b=parseFloat(q[1]);if(0>b||360<=b)b=(b%360+360)%360;return b}var q=null;if(!b)return null;var r;if(null!==(q=/^#([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})$/.exec(b)))return[parseInt(q[1],16),parseInt(q[2],16),parseInt(q[3],16),255];if(null!==(q=/^rgb\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*\)$/.exec(b)))return[d(q[1]),d(q[2]),d(q[3]),255];if(null!==(q=/^rgb\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*\)$/.exec(b)))return[n(q[1]),
n(q[2]),n(q[3]),255];if(null!==(q=/^rgba\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(b)))return[d(q[1]),d(q[2]),d(q[3]),m(q[4])];if(null!==(q=/^rgba\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(b)))return[n(q[1]),n(q[2]),n(q[3]),m(q[4])];if(null!==(q=/^#([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})$/.exec(b))){var t=parseInt(q[1],16);b=parseInt(q[2],16);r=parseInt(q[3],
16);return[t+(t<<4),b+(b<<4),r+(r<<4),255]}if(null!==(q=/^hsl\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*\)$/.exec(b)))return b=a([p(q[1]),d(q[3]),d(q[2])]),[b[0],b[1],b[2],255];if(null!==(q=/^hsla\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(b)))return b=a([p(q[1]),d(q[3]),d(q[2])]),[b[0],b[1],b[2],m(q[4])];h();b=b.toLowerCase();0<=b.indexOf("grey")&&(b=b.replace("grey",
"gray"));r=g[b];return"string"===typeof r?c(r):"transparent"===b?[0,0,0,0]:null},d=function(b){b[0]=0>b[0]?0:Math.min(b[0],1);b[1]=0>b[1]?0:Math.min(b[1],1);b[2]=0>b[2]?0:Math.min(b[2],1);b[3]=0>b[3]?0:Math.min(b[3],1);return b};b.toGLColor=function(b,a,e,g){return null===b||"undefined"===typeof b?[0,0,0,0]:"string"===typeof b?(b=c(b)||[0,0,0,0],a=1/255,b[0]*=a,b[1]*=a,b[2]*=a,b[3]*=a,d(b)):"number"===typeof b&&"number"===typeof a&&"number"===typeof e?[b,a,e,"number"!==typeof g?1:g]:b.constructor===
Array?d([b[0]||0,b[1]||0,b[2]||0,"number"!==typeof b[3]?1:b[3]]):d(b||[0,0,0,0])};var g=null,h=function(){if(!g){var b="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
g={};for(var a=0;a<b.length;a+=2)g[b[a]]="#"+b[a+1]}}})(c);c._toContext=function(b){return b&&b.getContext?b.getContext():b};c._isPowerOfTwo=function(b){if(Math.floor(b)!==b||0>=b)return!1;for(;1<b&&0===(b&1);)b>>=1;return 1===b};c._isIdentityExceptTranslate=function(b){return 1===b[0]&&0===b[1]&&0===b[2]&&0===b[3]&&0===b[4]&&1===b[5]&&0===b[6]&&0===b[7]&&0===b[8]&&0===b[9]&&1===b[10]&&0===b[11]&&1===b[15]};a.H3DU=c}});H3DU.Batch3D=function(){this._projectionMatrix=H3DU.Math.mat4identity();this._viewMatrix=H3DU.Math.mat4identity();this.lights=new H3DU.Lights;this._frustum=this._projectionUpdater=null;this.shapes=[]};H3DU.Batch3D._PerspectiveView=function(a,c,b,e){this.fov=c;this.near=b;this.far=e;this.scene=a;this.lastAspect=null;this.update=function(b,a){var e=1*b/a;e!=this.lastAspect&&(this.lastAspect=e,this.scene.setProjectionMatrix(H3DU.Math.mat4perspective(this.fov,e,this.near,this.far)))};this.update()};
H3DU.Batch3D._OrthoView=function(a,c,b,e,f,d,g){this.a=c;this.b=b;this.c=e;this.d=f;this.e=d;this.f=g;this.scene=a;this.lastAspect=null;this.update=function(b,a){var e=1*b/a;e!=this.lastAspect&&(this.lastAspect=e,this.scene.setProjectionMatrix(H3DU.Math.mat4orthoAspect(this.a,this.b,this.c,this.d,this.e,this.f,e)))};this.update()};
H3DU.Batch3D._setupMatrices=function(a,c,b,e,f){var d={};f&&(d.view=b,d.projection=c,d.viewMatrix=b,d.projectionMatrix=c,viewInvW=a.get("projView"),null!==viewInvW&&"undefined"!==typeof viewInvW&&(c=H3DU.Math.mat4multiply(c,b),d.projView=c));c=H3DU.Math.mat4inverseTranspose3(e);d.world=e;d.modelMatrix=e;d.normalMatrix=c;c=a.get("modelViewMatrix");null!==c&&"undefined"!==typeof c&&(H3DU._isIdentityExceptTranslate(b)?(e=e.slice(0,16),e[12]+=b[12],e[13]+=b[13],e[14]+=b[14]):e=H3DU.Math.mat4multiply(b,
e),d.modelViewMatrix=e,c=H3DU.Math.mat4inverseTranspose3(e),d.world=e,d.modelMatrix=e,d.normalMatrix=c);a.setUniforms(d)};H3DU.Batch3D._isSameMatrix=function(a,c){return a[0]==c[0]&&a[1]==c[1]&&a[2]==c[2]&&a[3]==c[3]&&a[4]==c[4]&&a[5]==c[5]&&a[6]==c[6]&&a[7]==c[7]&&a[8]==c[8]&&a[9]==c[9]&&a[10]==c[10]&&a[11]==c[11]&&a[12]==c[12]&&a[13]==c[13]&&a[14]==c[14]&&a[15]==c[15]};
H3DU.Batch3D.prototype.setProjectionMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._projectionMatrix,a)||(this._projectionMatrix=a.slice(0,16),this._frustum=null);return this};H3DU.Batch3D.prototype.perspectiveAspect=function(a,c,b){this._projectionUpdater=new H3DU.Batch3D._PerspectiveView(this,a,c,b);return this};H3DU.Batch3D.prototype.setLookAt=function(a,c,b){return this.setViewMatrix(H3DU.Math.mat4lookat(a,c,b))};
H3DU.Batch3D.prototype.orthoAspect=function(a,c,b,e,f,d){this._projectionUpdater=new H3DU.Batch3D._OrthoView(this,a,c,b,e,f,d);return this};H3DU.Batch3D.prototype.ortho2DAspect=function(a,c,b,e){this._projectionUpdater=new H3DU.Batch3D._OrthoView(this,a,c,b,e,-1,1);return this};H3DU.Batch3D.prototype.setViewMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._viewMatrix,a)||(this._viewMatrix=a.slice(0,16),this._frustum=null);return this};
H3DU.Batch3D.prototype.getProjectionMatrix=function(){return this._projectionMatrix.slice(0,16)};H3DU.Batch3D.prototype.getViewMatrix=function(){return this._viewMatrix.slice(0,16)};H3DU.Batch3D.prototype._getFrustum=function(){if(null==this._frustum){var a=H3DU.Math.mat4multiply(this._projectionMatrix,this._viewMatrix);this._frustum=H3DU.Math.mat4toFrustumPlanes(a)}return this._frustum};H3DU.Batch3D.prototype.getLights=function(){return this.lights};
H3DU.Batch3D.prototype.addShape=function(a){a.parent=null;this.shapes.push(a);return this};H3DU.Batch3D.prototype.vertexCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].vertexCount();return a};H3DU.Batch3D.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].primitiveCount();return a};H3DU.Batch3D.prototype.removeShape=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c]===a&&(this.shapes.splice(c,1),c--);return this};
H3DU.Batch3D.prototype._renderShape=function(a,c){if(a.constructor===H3DU.ShapeGroup){if(a.visible)for(var b=0;b<a.shapes.length;b++)this._renderShape(a.shapes[b],c)}else if(a.visible&&!a.isCulled(this._getFrustum())){var b=null,b=a.material instanceof Material?a.material.shader?c.scene._programs.getCustomProgram(a.material.shader,c.context):c.scene._programs.getProgram(H3DU.Scene3D._materialToFlags(a.material),c.context):c.scene._programs.getProgram(0,c.context),e=!1;c.prog!=b&&(b.use(),e=!0,(new H3DU._LightsBinder(this.lights)).bind(b,
this._viewMatrix),c.prog=b);H3DU.Batch3D._setupMatrices(b,this._projectionMatrix,this._viewMatrix,a.getMatrix(),e);H3DU.Batch3D._getMaterialBinder(a.material).bind(b,c.context,c.scene._textureLoader);c.scene._meshLoader.draw(a.bufferedMesh,b)}};H3DU.Batch3D.prototype.resize=function(a,c){this._projectionUpdater&&this._projectionUpdater.update(a,c)};
H3DU.Batch3D.prototype.render=function(a){var c={};c.scene=a;c.context=a.getContext();for(a=0;a<this.shapes.length;a++)this._renderShape(this.shapes[a],c);return this};H3DU.Batch3D.forFilter=function(a,c,b){null==b&&(b=H3DU.ShaderProgram.makeCopyEffect(a));a=new H3DU.Batch3D(a);var e=new H3DU.Mesh([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0],[0,1,2,2,1,3],H3DU.Mesh.TEXCOORDS_BIT),e=new H3DU.Shape(e);e.setTexture(c);e.setShader(b);a.addShape(e);return a};
H3DU.Batch3D._getMaterialBinder=function(a){return a&&a instanceof Material?new H3DU._MaterialBinder(a):{bind:function(a){}}};H3DU._MaterialBinder=function(a){this.mshade=a};H3DU._MaterialBinder._textureSizeZeroZero=[0,0];
H3DU._MaterialBinder.prototype.bind=function(a,c,b){if(!this.mshade)return this;4!==this.mshade.diffuse.length&&console.warn("creating new diffuse array");3!==this.mshade.ambient.length&&console.warn("creating new ambient array");3!==this.mshade.specular.length&&console.warn("creating new specular array");3!==this.mshade.emission.length&&console.warn("creating new emission array");var e={textureSize:H3DU._MaterialBinder._textureSizeZeroZero,md:4===this.mshade.diffuse.length?this.mshade.diffuse:[this.mshade.diffuse[0],
this.mshade.diffuse[1],this.mshade.diffuse[2],4>this.mshade.diffuse.length?1:this.mshade.diffuse[3]]};this.mshade.basic||(e.mshin=this.mshade.shininess,e.ma=3===this.mshade.ambient.length?this.mshade.ambient:[this.mshade.ambient[0],this.mshade.ambient[1],this.mshade.ambient[2]],e.ms=3===this.mshade.specular.length?this.mshade.specular:[this.mshade.specular[0],this.mshade.specular[1],this.mshade.specular[2]],e.me=3===this.mshade.emission.length?this.mshade.emission:[this.mshade.emission[0],this.mshade.emission[1],
this.mshade.emission[2]]);a.setUniforms(e);H3DU._MaterialBinder.bindTexture(this.mshade.texture,c,a,0,b);H3DU._MaterialBinder.bindTexture(this.mshade.specularMap,c,a,1,b);H3DU._MaterialBinder.bindTexture(this.mshade.normalMap,c,a,2,b);return this};
H3DU._LoadedTexture=function(a,c){this.context=c=H3DU._toContext(c);this.loadedTexture=c.createTexture();c.activeTexture(c.TEXTURE0);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,1);c.bindTexture(c.TEXTURE_2D,this.loadedTexture);"src"in a.image?c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a.image):c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a.width,a.height,0,c.RGBA,c.UNSIGNED_BYTE,a.image);H3DU._isPowerOfTwo(a.width)&&H3DU._isPowerOfTwo(a.height)?c.generateMipmap(c.TEXTURE_2D):(c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE))};H3DU._LoadedTexture.prototype.dispose=function(){this.loadedTexture&&this.context.deleteTexture(this.loadedTexture)};
H3DU._MaterialBinder.bindTexture=function(a,c,b,e,f){if(a){var d=a instanceof H3DU.FrameBuffer,g=null;if(!d)if("undefined"!==typeof a.image&&null!==a.image||0!==a.loadStatus)g=f.mapTexture(a,c);else{var h=this;a.loadImage().then(function(a){h.bind(b)});return}if(null!=g||d){var k={};0===e&&(k.sampler=e,k.textureSize=[a.width,a.height]);1===e&&(k.specularMap=e);2===e&&(k.normalMap=e);b.setUniforms(k);c.activeTexture(c.TEXTURE0+e);d?(c.bindTexture(c.TEXTURE_2D,a.colorTexture),a.colorTexture&&(c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE))):(c.bindTexture(c.TEXTURE_2D,g.loadedTexture),f._setMaxAnisotropy(c),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),e=c.CLAMP_TO_EDGE,H3DU._isPowerOfTwo(a.width)&&H3DU._isPowerOfTwo(a.height)?(a.clamp||(e=c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_LINEAR)):
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,e))}}};H3DU._LightsBinder=function(a){this.lights=a};H3DU._LightsBinder.emptyW1=[0,0,0,1];H3DU._LightsBinder.emptyW0=[0,0,0,0];H3DU._LightsBinder.emptyAtten=[1,0,0,0];
H3DU._LightsBinder.prototype.bind=function(a,c){var b=this.lights;if(!b||!a)return this;var e={};e.sceneAmbient=3===b.sceneAmbient.length?b.sceneAmbient:b.sceneAmbient.slice(0,3);for(var f=0;f<b.lights.length;f++){var d=b.lights[f],g="lights["+f+"]";e[g+".diffuse"]=4===d.diffuse.length?d.diffuse:[d.diffuse[0],d.diffuse[1],d.diffuse[2],1];e[g+".specular"]=4===d.specular.length?d.specular:[d.specular[0],d.specular[1],d.specular[2],1];var h=H3DU.Math.mat4transform(c,b.lights[f].position);e[g+".position"]=
h;e[g+".radius"]=[Math.max(0,d.radius*d.radius*d.radius*d.radius),0,0,0]}for(f=b.lights.length;f<Lights.MAX_LIGHTS;f++)g="lights["+f+"]",e[g+".diffuse"]=H3DU._LightsBinder.emptyW1,e[g+".specular"]=H3DU._LightsBinder.emptyW1,e[g+".position"]=H3DU._LightsBinder.emptyW0,e[g+".radius"]=H3DU._LightsBinder.emptyW0;a.setUniforms(e);return this};H3DU.BufferedSubMesh=function(a,c){var b=a instanceof H3DU.SubMeshBuffer?a:new H3DU.SubMeshBuffer(a);this.smb=b;this.verts=c.createBuffer();if(!this.verts)throw Error("can't create buffer");this.indices=c.createBuffer();if(!this.indices)throw Error("can't create face buffer");this.arrayObjectExt=c.getExtension("OES_vertex_array_object");this.arrayObjectExtContext=c;this.vao=null;this.arrayObjectExt&&(this.vao=this.arrayObjectExt.createVertexArrayOES());c.bindBuffer(c.ARRAY_BUFFER,this.verts);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
this.indices);c.bufferData(c.ARRAY_BUFFER,b.vertices,c.STATIC_DRAW);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b.indices,c.STATIC_DRAW);var e=c.UNSIGNED_SHORT;4===b.indexBufferSize?e=c.UNSIGNED_INT:1===b.indexBufferSize&&(e=c.UNSIGNED_BYTE);this.type=e;this.context=c;this._lastKnownProgram=null;this._attribLocations=[]};H3DU.BufferedSubMesh.prototype._getVaoExtension=function(a){return this.arrayObjectExtContext==a?this.arrayObjectExt:a.getExtension("OES_vertex_array_object")};
H3DU.BufferedMesh=function(a,c){this.subMeshes=[];this.context=H3DU._toContext(c);if(a instanceof H3DU.MeshBuffer){this._bounds=a._bounds;for(var b=0;b<a.subMeshes.length;b++)this.subMeshes.push(new H3DU.BufferedSubMesh(a.subMeshes[b],this.context))}else for(this._bounds=a.getBoundingBox(),b=0;b<a.subMeshes.length;b++){var e=a.subMeshes[b];0!==e.indices.length&&this.subMeshes.push(new H3DU.BufferedSubMesh(e,this.context))}};H3DU.BufferedMesh.prototype._getBounds=function(){return this._bounds};
H3DU.BufferedMesh.prototype.getContext=function(){return this.context};H3DU.BufferedMesh.prototype.getFormat=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a|=this.subMeshes[c].smb.format;return a};H3DU.BufferedMesh.prototype.draw=function(a){for(var c=0;c<this.subMeshes.length;c++)this.subMeshes[c].draw(a)};H3DU.BufferedMesh.prototype.dispose=function(){for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].dispose();this.subMeshes=[]};
H3DU.BufferedSubMesh.prototype.dispose=function(){null!==this.verts&&this.context.deleteBuffer(this.verts);null!==this.indices&&this.context.deleteBuffer(this.indices);null!==this.vao&&this.arrayObjectExt.deleteVertexArrayOES(this.vao);this._lastKnownProgram=this.vao=this.smb=this.indices=this.verts=null;this._attribLocations=[]};
H3DU.BufferedSubMesh.prototype._getAttribLocations=function(a,c){if(this._lastKnownProgram!=a){this._lastKnownProgram=a;this._attribLocations=[a.get("position"),a.get("normal"),a.get("colorAttr"),a.get("uv"),a.get("tangent"),a.get("bitangent")];for(var b=0;6>b;b++)null==this._attribLocations[b]&&(this._attribLocations[b]=-1);return!0}return!1};
H3DU.BufferedSubMesh.prototype._prepareDraw=function(a,c){var b=this._getAttribLocations(a,c),e=this._getVaoExtension(c);this.vao?e.bindVertexArrayOES(this.vao):b=!0;if(b)for(c.bindBuffer(c.ARRAY_BUFFER,this.verts),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this.indices),b=0;b<this._attribLocations.length;b++)e=this._attribLocations[b],0<=e&&(0<=this.smb._attribsUsed[b]?(c.enableVertexAttribArray(e),c.vertexAttribPointer(e,this.smb._sizes[b],c.FLOAT,!1,4*this.smb._stride,4*this.smb._attribsUsed[b])):c.disableVertexAttribArray(e));
a.setUniforms({useColorAttr:0<=this.smb._attribsUsed[2]?1:0})};
H3DU.BufferedSubMesh.prototype.draw=function(a){var c=a.getContext();if(null===this.verts||null===this.face)throw Error("mesh buffer disposed");if(c!==this.context)throw Error("can't bind mesh: context mismatch");this._prepareDraw(a,c);a=c.TRIANGLES;0!==(this.smb.format&H3DU.Mesh.LINES_BIT)&&(a=c.LINES);0!==(this.smb.format&H3DU.Mesh.POINTS_BIT)&&(a=c.POINTS);c.drawElements(a,this.smb.facesLength,this.type,0);c=this._getVaoExtension(c);this.vao&&c.bindVertexArrayOES(null)};
H3DU.BufferedMesh.prototype.vertexCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].smb.numVertices;return a};H3DU.BufferedMesh.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].smb.primitiveCount();return a};H3DU.BufferedMesh._MeshLoader=function(){this.meshes=[]};
H3DU.BufferedMesh._MeshLoader.prototype.draw=function(a,c){if(a instanceof H3DU.BufferedMesh)a.draw(c);else{for(var b=c.getContext(),e=0;e<this.meshes.length;e++){var f=this.meshes[e];if(f[0]==a&&f[1]==b){f[2].draw(c);return}}e=new H3DU.BufferedMesh(a,c);this.meshes.push([a,b,e]);e.draw(c)}};H3DU.BufferedMesh._MeshLoader.prototype.dispose=function(){for(var a=0;a<this.meshes.length;a++)this.meshes[a][2].dispose();this.meshes=[]};(function(a){H3DU.BezierCurve=function(b,a,c){if("undefined"===typeof a&&"undefined"===typeof c)this.uoffset=0,this.umul=1;else{if(a===c)throw Error("u1 and u2 can't be equal");this.uoffset=a;this.umul=1/(c-a)}this.evaluator=H3DU.BSplineCurve.clamped(b,b.length-1)};H3DU.BezierCurve.prototype.evaluate=function(b){return this.evaluator.evaluate((b-this.uoffset)*this.umul)};H3DU.BezierSurface=function(b,a,f,d,g){if("undefined"===typeof a&&"undefined"===typeof f&&"undefined"===typeof d&&"undefined"===
typeof g)this.uoffset=0,this.umul=1,this.voffset=0,this.vmul=1;else{if(a===f)throw Error("u1 and u2 can't be equal");if(d===g)throw Error("v1 and v2 can't be equal");this.uoffset=a;this.umul=1/(f-a);this.voffset=d;this.vmul=1/(g-d)}this.evaluator=c.clamped(b,b[0].length-1,b.length-1)};H3DU.BezierSurface.prototype.evaluate=function(b,a,c){return this.evaluator.evaluate((b-this.uoffset)*this.umul,(a-this.voffset)*this.vmul)};H3DU.BSplineCurve=function(b,a,c){if(0>=b.length)throw Error();if(!a)throw Error();
this.bits=c||0;c=a.length-b.length;if(2>c||c>b.length)throw Error();H3DU.BSplineCurve._checkKnots(a);this.cplen=b[0].length;c=1;0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.DIVIDE_BIT))&&(c=2);0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)&&this.cplen--;if(this.cplen<c)throw Error();this.knots=a;this.buffer=[];this.controlPoints=b};H3DU.BSplineCurve.WEIGHTED_BIT=1;H3DU.BSplineCurve.DIVIDE_BIT=2;H3DU.BSplineCurve.HOMOGENEOUS_BIT=4;H3DU.BSplineCurve.WEIGHTED_DIVIDE_BITS=3;H3DU.BSplineCurve._checkKnots=
function(b){for(var a=1;a<b.length;a++)if(b[a]<b[a-1])throw Error();if(b[0]===b[b.length-1])throw Error();};H3DU.BSplineCurve._getFactors=function(b,a,c,d,g){for(var h=1,k=0;k<d;k++)g[k]=0;if(a===b[0])g[0]=1;else if(a===b[b.length-1])g[d-1]=1;else{d=-1;for(k=0;k<=b.length;k++)if(b[k]<=a&&a<b[k+1]){d=k;break}if(!(0>d)){var l=[],h=d-1;l[d]=1;for(var m=2;m<=c;m++,h--){for(k=h;k<=d;k++){var n=0,p=0,q=k<=h?0:l[k],r=k>=d?0:l[k+1];0!==q&&(p=b[k+m-1]-b[k],n+=0===p?0:q*(a-b[k])/p);0!==r&&(q=b[k+m],p=q-b[k+
1],n+=0===p?0:r*(q-a)/p);g[k]=n}if(m<c)for(k=h;k<=d;k++)l[k]=g[k]}}}};H3DU.BSplineCurve.prototype.evaluate=function(b){var a=this.controlPoints.length,c=this.knots.length-a;b=this.knots[c-1]+b*(this.knots[a]-this.knots[c-1]);H3DU.BSplineCurve._getFactors(this.knots,b,c,a,this.buffer);b=[];var d,g;if(0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)){var h=0;for(d=0;d<a;d++)h+=this.buffer[d]*this.controlPoints[d][this.cplen];for(var k=0!==(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT),c=0;c<this.cplen+
1;c++){for(d=g=0;d<a;d++){var l=this.buffer[d];k||(l*=this.controlPoints[d][this.cplen]);g+=this.controlPoints[d][c]*l}b[c]=g/h}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(c=0;c<this.cplen;c++)b[c]/=b[this.cplen];b=b.slice(0,this.cplen)}}else{b=[];for(c=0;c<this.cplen;c++){for(d=g=0;d<a;d++)g+=this.controlPoints[d][c]*this.buffer[d];b[c]=g}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(c=0;c<this.cplen-1;c++)b[c]/=b[this.cplen-1];b=b.slice(0,this.cplen-1)}}return b};var c=function(b,
a,c,d){var g=b.length;if(0>=g)throw Error();var h=b[0].length;if(0>=h)throw Error();var k=b[0][0].length,l=1;this.bits=d||0;0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.DIVIDE_BIT))&&(l=2);0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.HOMOGENEOUS_BIT))&&k--;if(k<l)throw Error();if(!a||!c)throw Error();this.orderU=a.length-h;this.orderV=c.length-g;this.vcplen=g;this.ucplen=h;this.cplen=k;if(2>this.orderU||this.orderU>h)throw Error();if(2>this.orderV||this.orderV>
g)throw Error();H3DU.BSplineCurve._checkKnots(a);H3DU.BSplineCurve._checkKnots(c);this.knotsU=a;this.knotsV=c;this.bufferU=[];this.bufferV=[];this.controlPoints=b};H3DU.BSplineCurve.clamped=function(b,a,c){return new H3DU.BSplineCurve(b,H3DU.BSplineCurve.clampedKnots(b.length,a),c)};H3DU.BSplineCurve.uniform=function(b,a,c){return new H3DU.BSplineCurve(b,H3DU.BSplineCurve.uniformKnots(b.length,a),c)};c.clamped=function(b,a,f,d){return new c(b,H3DU.BSplineCurve.clampedKnots(b[0].length,a),H3DU.BSplineCurve.clampedKnots(b.length,
f),d)};c.uniform=function(b,a,f,d){return new c(b,H3DU.BSplineCurve.uniformKnots(b[0].length,a),H3DU.BSplineCurve.uniformKnots(b.length,f),d)};H3DU.BSplineCurve.uniformKnots=function(b,a){"object"===typeof b&&(b=b.length);if(null===a||"undefined"===typeof a)a=3;if(b<a+1)throw Error("too few control points for degree "+a+" curve");for(var c=a+1,d=[],g=0;g<b+c;g++)d.push(g);return d};H3DU.BSplineCurve.clampedKnots=function(b,a){"object"===typeof b&&(b=b.length);if(null===a||"undefined"===typeof a)a=
3;if(b<a+1)throw Error("too few control points for degree "+a+" curve");for(var c=a+1,d=b-c,g=[],h=0;h<c;h++)g.push(0);for(h=0;h<d;h++)g.push(h+1);for(h=0;h<c;h++)g.push(d+1);return g};c.prototype.evaluate=function(b,a){b=this.knotsU[this.orderU-1]+b*(this.knotsU[this.ucplen]-this.knotsU[this.orderU-1]);a=this.knotsV[this.orderV-1]+a*(this.knotsV[this.vcplen]-this.knotsV[this.orderV-1]);var c=this.bufferU,d=this.bufferV,g,h,k,l,m;H3DU.BSplineCurve._getFactors(this.knotsU,b,this.orderU,this.ucplen,
this.bufferU);H3DU.BSplineCurve._getFactors(this.knotsV,a,this.orderV,this.vcplen,this.bufferV);var n=[];if(0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)){var p=0,q=0!==(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT);for(g=0;g<this.ucplen;g++)for(h=0;h<this.vcplen;h++)k=c[g]*d[h]*this.controlPoints[h][g][this.cplen],p+=k;for(l=0;l<this.cplen+1;l++){for(g=p=m=0;g<this.ucplen;g++)for(h=0;h<this.vcplen;h++)k=c[g]*d[h],q||(k*=this.controlPoints[h][g][this.cplen]),m+=this.controlPoints[h][g][l]*k;n[l]=
0===p?m:m/p}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(l=0;l<this.cplen;l++)n[l]/=n[this.cplen];n=n.slice(0,this.cplen)}}else{for(l=0;l<this.cplen;l++){for(g=m=0;g<this.ucplen;g++)for(h=0;h<this.vcplen;h++)m+=this.controlPoints[h][g][l]*c[g]*d[h];n[l]=m}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(l=0;l<this.cplen-1;l++)n[l]/=n[this.cplen-1];n=n.slice(0,this.cplen-1)}}return n};H3DU.CurveEval=function(){this.vertexCurve=this.texCoordCurve=this.normalCurve=this.colorCurve=null};H3DU.CurveEval.prototype.vertex=
function(b){this.vertexCurve=b;return this};H3DU.CurveEval.prototype.normal=function(b){this.normalCurve=b;return this};H3DU.CurveEval.prototype.color=function(b){this.colorCurve=b;return this};H3DU.CurveEval.prototype.texCoord=function(b){this.texCoordCurve=b;return this};H3DU.CurveEval.prototype.evalOne=function(b,a){var c=null,d=null,g=null;this.colorCurve&&(c=this.colorCurve.evaluate(a));this.texCoordCurve&&(g=this.texCoordCurve.evaluate(a),1===g.length&&g.push(0));this.normalCurve&&(d=this.normalCurve.evaluate(a));
if(this.vertexCurve){var h=c?b.color.slice(0,3):null,k=d?b.normal.slice(0,3):null,l=g?b.texCoord.slice(0,2):null;c&&b.color3(c[0],c[1],c[2]);d&&b.normal3(d[0],d[1],d[2]);g&&b.texCoord2(g[0],g[1]);c=this.vertexCurve.evaluate(a);2===c.length?b.vertex3(c[0],c[1],0):b.vertex3(c[0],c[1],c[2]);h&&b.color3(h[0],h[1],h[2]);k&&b.normal3(k[0],k[1],k[2]);l&&b.texCoord2(l[0],l[1])}return this};H3DU.CurveEval.prototype.evalCurve=function(b,a,c,d,g){"undefined"===typeof c&&(c=24);if(0>=c)throw Error("invalid n");
"undefined"===typeof d&&"undefined"===typeof g&&(d=0,g=1);if(null===a||"undefined"===typeof a)a=H3DU.Mesh.LINES;if(a===H3DU.Mesh.POINTS)b.mode(H3DU.Mesh.POINTS);else if(a===H3DU.Mesh.LINES)b.mode(H3DU.Mesh.LINE_STRIP);else return this;a=(g-d)/c;for(g=0;g<=c;g++)this.evalOne(b,d+g*a);return this};H3DU.SurfaceEval=function(){this.vertexSurface=this.texCoordSurface=this.normalSurface=this.colorSurface=null;this.autoNormal=!1};H3DU.SurfaceEval.prototype.setAutoNormal=function(b){this.autoNormal=!!b;return this};
H3DU.SurfaceEval.prototype.vertex=function(b){this.vertexSurface=b;return this};H3DU.SurfaceEval.prototype.normal=function(b){this.normalSurface=b;return this};H3DU.SurfaceEval.prototype.color=function(b){this.colorSurface=b;return this};H3DU.SurfaceEval.prototype.texCoord=function(b){this.texCoordSurface=b;return this};H3DU.SurfaceEval.prototype.evalOne=function(b,a,c){var d=[];this._saveValues(b,d,0);this._record(a,c,d,8);this._playBack(b,d,8);this._restoreValues(b,d,0);return this};H3DU.SurfaceEval.prototype._recordAndPlayBack=
function(b,a,c,d,g){this._record(a,c,d,g);this._playBack(b,d,g)};H3DU.SurfaceEval.prototype._saveValues=function(b,a,c){this.colorSurface&&(a[c+3]=b.color[0],a[c+4]=b.color[1],a[c+5]=b.color[2]);if(this.normalSurface||this.autoNormal)a[c+0]=b.normal[0],a[c+1]=b.normal[1],a[c+2]=b.normal[2];this.texCoordSurface&&(a[c+6]=b.texCoord[0],a[c+7]=b.texCoord[1])};H3DU.SurfaceEval.prototype._restoreValues=function(b,a,c){this.colorSurface&&b.color3(a[c+3],a[c+4],a[c+5]);(this.normalSurface||this.autoNormal)&&
b.normal3(a[c+0],a[c+1],a[c+2]);this.texCoordSurface&&b.texCoord2(a[c+6],a[c+7])};H3DU.SurfaceEval.prototype._record=function(b,a,c,d){var g=null;this.colorSurface&&(g=this.colorSurface.evaluate(b,a),c[d+6]=g[0],c[d+7]=g[1],c[d+8]=g[2]);this.texCoordSurface&&(g=this.texCoordSurface.evaluate(b,a),c[d+9]=g[0],c[d+10]=1>=g.length?0:g[1]);this.normalSurface&&!this.autoNormal&&(g=this.normalSurface.evaluate(b,a),c[d+3]=g[0],c[d+4]=g[1],c[d+5]=g[2]);if(this.vertexSurface&&(g=this.vertexSurface.evaluate(b,
a),c[d]=g[0],c[d+1]=g[1],c[d+2]=g[2],this.autoNormal)){var h=1E-5,k=1E-5,l=this.vertexSurface.evaluate(b+h,a);0===l[0]&&0===l[1]&&0===l[2]&&(h=-h,l=this.vertexSurface.evaluate(b+h,a));var m=this.vertexSurface.evaluate(b,a+k);0===m[0]&&0===m[1]&&0===m[2]&&(k=-k,m=this.vertexSurface.evaluate(b,a+k));H3DU.Math.vec3subInPlace(m,g);H3DU.Math.vec3subInPlace(l,g);H3DU.Math.vec3scaleInPlace(l,1/h);H3DU.Math.vec3scaleInPlace(m,1/k);H3DU.Math.vec3normInPlace(l);H3DU.Math.vec3normInPlace(m);0===H3DU.Math.vec3length(l)?
l=m:0!==H3DU.Math.vec3length(m)?(l=H3DU.Math.vec3cross(l,m),H3DU.Math.vec3normInPlace(l)):l[2]===g[2]&&(l=[0,0,1]);c[d+3]=l[0];c[d+4]=l[1];c[d+5]=l[2]}};H3DU.SurfaceEval.prototype._playBack=function(b,a,c){this.vertexSurface&&(this.colorSurface&&b.color3(a[c+6],a[c+7],a[c+8]),(this.normalSurface||this.autoNormal)&&b.normal3(a[c+3],a[c+4],a[c+5]),this.texCoordSurface&&b.texCoord2(a[c+9],a[c+10]),b.vertex3(a[c+0],a[c+1],a[c+2]))};H3DU.SurfaceEval.prototype.evalSurface=function(b,a,c,d,g,h,k,l){"undefined"===
typeof c&&(c=24);"undefined"===typeof d&&(d=24);if(0>=c)throw Error("invalid un");if(0>=d)throw Error("invalid vn");if(null===a||"undefined"===typeof a)a=H3DU.Mesh.TRIANGLES;"undefined"===typeof k&&"undefined"===typeof l&&(k=0,l=1);"undefined"===typeof g&&"undefined"===typeof h&&(g=0,h=1);h=(h-g)/c;l=(l-k)/d;var m,n,p;if(a===H3DU.Mesh.TRIANGLES){var q=[],r=[];this._saveValues(b,q,0);for(a=0;a<d;a++)for(b.mode(H3DU.Mesh.TRIANGLE_STRIP),p=m=0;m<=c;m++,p+=11)n=m*h+g,0===a?this._recordAndPlayBack(b,n,
a*l+k,q,8):this._playBack(b,r,p),a===d-1?this._recordAndPlayBack(b,n,(a+1)*l+k,q,8):this._recordAndPlayBack(b,n,(a+1)*l+k,r,p);this._restoreValues(b,q,0)}else if(a===H3DU.Mesh.POINTS)for(b.mode(H3DU.Mesh.POINTS),a=0;a<=d;a++)for(m=0;m<=c;m++)n=m*h+g,this.evalOne(b,n,a*l+k);else if(a===H3DU.Mesh.LINES){for(a=0;a<=d;a++)for(b.mode(H3DU.Mesh.LINE_STRIP),m=0;m<=c;m++)n=m*h+g,this.evalOne(b,n,a*l+k);for(a=0;a<=c;a++)for(b.mode(H3DU.Mesh.LINE_STRIP),m=0;m<=d;m++)this.evalOne(b,a*h+g,m*l+k)}return this};
a.H3DU.SurfaceEval=H3DU.SurfaceEval;a.H3DU.CurveEval=H3DU.CurveEval;a.H3DU.BezierCurve=H3DU.BezierCurve;a.BezierSurface=BezierSurface;a.H3DU.BSplineCurve=H3DU.BSplineCurve;a.BSplineSurface=c})(this);H3DU.FrameBuffer=function(a,c,b){if(0>c||0>b)throw Error("width or height negative");this.context=a=a.getContext?a.getContext():a;this.textureUnit=3;this._init(a,c,b)};
H3DU.FrameBuffer.prototype._init=function(a,c,b){this.buffer=a.createFramebuffer();this.colorTexture=a.createTexture();this.width=Math.ceil(c);this.height=Math.ceil(b);this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindTexture(this.context.TEXTURE_2D,this.colorTexture);this.context.pixelStorei(this.context.UNPACK_FLIP_Y_WEBGL,1);this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.width,this.height,0,this.context.RGBA,this.context.UNSIGNED_BYTE,
null);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE);this.depthbuffer=this.context.createRenderbuffer();c=this.context.getParameter(a.FRAMEBUFFER_BINDING);
this.context.bindFramebuffer(a.FRAMEBUFFER,this.buffer);this.context.bindRenderbuffer(a.RENDERBUFFER,this.depthbuffer);this.context.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height);this.context.bindFramebuffer(a.FRAMEBUFFER,c)};H3DU.FrameBuffer.prototype.resize=function(a,c){a=Math.ceil(a);c=Math.ceil(c);if(a!=this.width||c!=this.height)this.dispose(),this._init(this.context,a,c);return this};H3DU.FrameBuffer.prototype.getContext=function(){return this.context};
H3DU.FrameBuffer.prototype.bind=function(){this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindFramebuffer(this.context.FRAMEBUFFER,this.buffer);this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,this.colorTexture,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,this.depthbuffer);return this};
H3DU.FrameBuffer.prototype.unbind=function(){this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,null,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,null);this.context.bindFramebuffer(this.context.FRAMEBUFFER,null)};
H3DU.FrameBuffer.prototype.dispose=function(){null!==this.buffer&&(this.context.getParameter(this.context.FRAMEBUFFER_BINDING)==this.buffer&&this.unbind(),this.context.deleteFramebuffer(this.buffer));null!==this.depthbuffer&&this.context.deleteRenderbuffer(this.depthbuffer);null!==this.colorTexture&&this.context.deleteTexture(this.colorTexture);this.colorTexture=this.depthbuffer=this.buffer=null};H3DU.Lights=function(){this.lights=[];this.sceneAmbient=[.2,.2,.2]};H3DU.Lights.prototype.setDefaults=function(){this.lights=[(new H3DU.LightSource).setParams({ambient:[0,0,0,1],position:[0,0,1,0],diffuse:[1,1,1,1],specular:[1,1,1],radius:0})];this.sceneAmbient=[.2,.2,.2]};H3DU.Lights.MAX_LIGHTS=3;H3DU.Lights._createNewLight=function(a){var c=new H3DU.LightSource;0!==a&&(c.diffuse=[0,0,0,0],c.specular=[0,0,0]);return c};H3DU.Lights.prototype.getCount=function(){return this.lights.length};
H3DU.Lights.prototype.getLight=function(a){var c=this.lights.length;this.lights[a]||(this.lights[a]=H3DU.Lights._createNewLight(a));if(2<=this.lights.length-c)for(;c<this.lights.length;c++)this.lights[c]||(this.lights[c]=H3DU.Lights._createNewLight(c));return this.lights[a]};H3DU.Lights.prototype.setParams=function(a,c){this.getLight(a).setParams(c);return this};
H3DU.Lights.prototype.setDirectionalLight=function(a,c,b,e){c=this.setParams(a,{position:[c[0],c[1],c[2],0]});null!=b&&(c=c.setParams(a,{diffuse:b}));null!=e&&(c=c.setParams(a,{specular:e}));return c};H3DU.Lights.prototype.setPointLight=function(a,c,b,e){c=this.setParams(a,{position:[c[0],c[1],c[2],1]});null!=b&&(c=c.setParams(a,{diffuse:b}));null!=e&&(c=c.setParams(a,{specular:e}));return c};H3DU.Lights.prototype.setAmbient=function(a,c,b,e){this.sceneAmbient=H3DU.toGLColor(a,c,b,e);return this};H3DU.LightSource=function(a,c,b,e){this.ambient=c||[0,0,0,1];this.position=a?[a[0],a[1],a[2],1]:[0,0,1,0];this.diffuse=b||[1,1,1,1];this.specular=e||[1,1,1];this.radius=0};
H3DU.LightSource.prototype.setParams=function(a){"undefined"!==typeof a.ambient&&"undefined"!==typeof a.ambient&&"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),this.ambient=this.ambient.slice(0,4));if("undefined"!==typeof a.position&&"undefined"!==typeof a.position&&"undefined"!==typeof a.position&&null!==a.position){var c=a.position;this.position=[c[0],c[1],c[2],null===c[3]?0:c[3]]}"undefined"!==typeof a.specular&&"undefined"!==typeof a.specular&&"undefined"!==
typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular));"undefined"!==typeof a.diffuse&&"undefined"!==typeof a.diffuse&&"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse));"undefined"!=typeof a.radius&&(this.radius=a.radius);return this};H3DU.Material=function(a,c,b,e,f){null!==a&&"undefined"!==typeof a&&(a=H3DU.toGLColor(a));null!==c&&"undefined"!==typeof c&&(c=H3DU.toGLColor(c));null!==b&&"undefined"!==typeof b&&(b=H3DU.toGLColor(b));null!==f&&"undefined"!==typeof f&&(f=H3DU.toGLColor(f));this.shininess=null===e||"undefined"===typeof e?0:Math.min(Math.max(0,e),128);this.ambient=a?a.slice(0,3):[.2,.2,.2];this.diffuse=c?c.slice(0,c.length):[.8,.8,.8,1];this.specular=b?b.slice(0,3):[0,0,0];this.emission=f?f.slice(0,3):[0,0,0];this.normalMap=
this.specularMap=this.texture=null;this.basic=!1;this.shader=null};H3DU.Material.prototype.copy=function(){return(new H3DU.Material(this.ambient.slice(0,this.ambient.length),this.diffuse.slice(0,this.diffuse.length),this.specular.slice(0,this.specular.length),this.shininess,this.emission.slice(0,this.emission.length))).setParams({texture:this.texture,specularMap:this.specularMap,normalMap:this.normalMap,basic:this.basic,shader:this.shader})};
H3DU.Material.prototype.setParams=function(a){var c;"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),3<this.ambient.length&&(this.ambient=this.ambient.slice(0,3)));"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse),4<this.diffuse.length&&(this.diffuse=this.diffuse.slice(0,4)));"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular),3<this.specular.length&&(this.specular=this.specular.slice(0,
3)));"undefined"!==typeof a.emission&&null!==a.emission&&(this.emission=H3DU.toGLColor(a.emission),3<this.emission.length&&(this.emission=this.emission.slice(0,3)));"undefined"!==typeof a.shininess&&null!==a.shininess&&(this.shininess=a.shininess);"undefined"!==typeof a.texture&&null!==a.texture&&(c=a.texture,this.texture="string"===typeof c?new H3DU.Texture(c):c);"undefined"!==typeof a.specularMap&&null!==a.specularMap&&(c=a.specularMap,this.specularMap="string"===typeof c?new H3DU.Texture(c):c);
"undefined"!==typeof a.normalMap&&null!==a.normalMap&&(c=a.normalMap,this.normalMap="string"===typeof c?new H3DU.Texture(c):c);"undefined"!=typeof a.basic&&null!==a.basic&&(this.basic=a.basic);"undefined"!=typeof a.shader&&null!==a.shader&&(this.shader=a.shader);return this};H3DU.Material.fromColor=function(a,c,b,e){a=H3DU.toGLColor(a,c,b,e);return new H3DU.Material(a,a)};H3DU.Material.fromTexture=function(a){return(new H3DU.Material).setParams({texture:a})};H3DU.Material.forShader=function(a){return(new H3DU.Material).setParams({shader:a})};(function(a,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(a)})(this,function(a){a.H3DU||(a.H3DU={});if(!a.H3DU.Math){var c=a.H3DU;c.Math={vec3cross:function(b,a){return[b[1]*a[2]-b[2]*a[1],b[2]*a[0]-b[0]*a[2],b[0]*a[1]-b[1]*a[0]]},vec3dot:function(b,a){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},vec3add:function(b,a){return[b[0]+a[0],b[1]+a[1],b[2]+a[2]]},vec3sub:function(b,a){return[b[0]-a[0],b[1]-a[1],b[2]-a[2]]},vec3negate:function(b){return[-b[0],
-b[1],-b[2]]},vec3negateInPlace:function(b){b[0]=-b[0];b[1]=-b[1];b[2]=-b[2];return b},vec3mul:function(b,a){return[b[0]*a[0],b[1]*a[1],b[2]*a[2]]},vec3addInPlace:function(b,a){var c=a[1],d=a[2];b[0]+=a[0];b[1]+=c;b[2]+=d;return b},vec3subInPlace:function(b,a){var c=a[1],d=a[2];b[0]-=a[0];b[1]-=c;b[2]-=d;return b},vec3mulInPlace:function(b,a){var c=a[1],d=a[2];b[0]*=a[0];b[1]*=c;b[2]*=d;return b},vec3scaleInPlace:function(b,a){b[0]*=a;b[1]*=a;b[2]*=a;return b},vec3scale:function(b,a){return c.Math.vec3scaleInPlace([b[0],
b[1],b[2]],a)},vec3lerp:function(b,a,c){return[b[0]+(a[0]-b[0])*c,b[1]+(a[1]-b[1])*c,b[2]+(a[2]-b[2])*c]},vec4dot:function(b,a){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},vec4scaleInPlace:function(b,a){b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return b},vec4lerp:function(b,a,c){return[b[0]+(a[0]-b[0])*c,b[1]+(a[1]-b[1])*c,b[2]+(a[2]-b[2])*c,b[3]+(a[3]-b[3])*c]},vec3normInPlace:function(b){var a=b[0],c=b[1],d=b[2],a=Math.sqrt(a*a+c*c+d*d);0!==a&&(a=1/a,b[0]*=a,b[1]*=a,b[2]*=a);return b},vec4normInPlace:function(b){var a=
b[0],c=b[1],d=b[2],g=b[3],a=Math.sqrt(a*a+c*c+d*d+g*g);0!==a&&(a=1/a,b[0]*=a,b[1]*=a,b[2]*=a,b[3]*=a);return b},vec3norm:function(b){return c.Math.vec3normInPlace([b[0],b[1],b[2]])},vec4norm:function(b){return c.Math.vec4normInPlace([b[0],b[1],b[2],b[3]])},vec3length:function(b){var a=b[0],c=b[1];b=b[2];return Math.sqrt(a*a+c*c+b*b)},vec4length:function(b){var a=b[0],c=b[1],d=b[2];b=b[3];return Math.sqrt(a*a+c*c+d*d+b*b)},mat3identity:function(){return[1,0,0,0,1,0,0,0,1]},mat4identity:function(){return[1,
0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},quatIdentity:function(){return[0,0,0,1]},mat4copy:function(b){return b.slice(0,16)},vec3copy:function(b){return b.slice(0,3)},vec4copy:function(b){return b.slice(0,4)},vec3assign:function(b,a){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b},vec4assign:function(b,a){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},mat4isIdentity:function(b){return 1===b[0]&&0===b[1]&&0===b[2]&&0===b[3]&&0===b[4]&&1===b[5]&&0===b[6]&&0===b[7]&&0===b[8]&&0===b[9]&&1===b[10]&&0===b[11]&&0===b[12]&&
0===b[13]&&0===b[14]&&1===b[15]},mat4invert:function(b){var a=b[0]*b[10],f=b[0]*b[11],d=b[0]*b[5],g=b[0]*b[6],h=b[0]*b[7],k=b[0]*b[9],l=b[10]*b[12],m=b[10]*b[13],n=b[10]*b[15],p=b[11]*b[12],q=b[11]*b[13],r=b[11]*b[14],t=b[1]*b[4],u=b[1]*b[6],x=b[1]*b[7],A=b[1]*b[8],w=b[2]*b[4],B=b[2]*b[5],y=b[2]*b[7],C=b[2]*b[8],I=b[2]*b[9],v=b[3]*b[4],z=b[3]*b[5],D=b[3]*b[6],J=b[3]*b[8],F=b[3]*b[9],L=b[4]*b[9],M=b[5]*b[8],K=b[6]*b[8],N=b[6]*b[9],G=b[7]*b[8],E=b[7]*b[9],H=t-d,O=u-B,P=x-z,Q=w-g,d=d-t,u=B-u,B=y-D,t=
v-h,x=z-x,y=D-y,g=g-w,w=h-v,h=b[9]*b[12]*y+l*P+p*u+b[8]*b[13]*B+m*t+q*g+b[8]*b[14]*x+b[9]*b[14]*w+r*H+b[8]*b[15]*O+b[9]*b[15]*Q+n*d;if(0===h)return c.Math.mat4identity();h=1/h;v=[];v[0]=b[6]*q-b[7]*m+E*b[14]-b[5]*r-N*b[15]+b[5]*n;v[1]=b[3]*m-b[2]*q-F*b[14]+b[1]*r+I*b[15]-b[1]*n;v[2]=b[13]*B+b[14]*x+b[15]*O;v[3]=b[9]*y+b[10]*P+b[11]*u;v[4]=b[7]*l-b[6]*p-G*b[14]+b[4]*r+K*b[15]-b[4]*n;v[5]=b[2]*p-b[3]*l+b[14]*(J-f)+b[15]*(a-C);v[6]=b[12]*y+b[14]*w+b[15]*Q;v[7]=b[8]*B+b[10]*t+b[11]*g;v[8]=b[5]*p-E*b[12]+
G*b[13]-b[4]*q+b[15]*(L-M);v[9]=F*b[12]-b[1]*p+b[13]*(f-J)+b[15]*(A-k);v[10]=b[12]*P+b[13]*t+b[15]*d;v[11]=b[8]*x+b[9]*w+b[11]*H;v[12]=N*b[12]-b[5]*l-K*b[13]+b[4]*m+b[14]*(M-L);v[13]=b[1]*l-I*b[12]+b[13]*(C-a)+b[14]*(k-A);v[14]=b[12]*u+b[13]*g+b[14]*H;v[15]=b[8]*O+b[9]*Q+b[10]*d;for(b=0;16>b;b++)v[b]*=h;return v},quatConjugate:function(b){return[-b[0],-b[1],-b[2],b[3]]},quatInvert:function(b){var a=1/c.Math.quatDot(b,b);return c.Math.vec4scaleInPlace(c.Math.quatConjugate(b),a)},quatIsIdentity:function(b){return 0===
b[0]&&0===b[1]&&0===b[2]&&1===b[3]},quatToMat4:function(b){var a,c,d,g,h,k,l,m,n;a=2*b[0];c=2*b[1];d=2*b[2];g=a*b[0];h=a*b[1];k=a*b[2];l=c*b[1];m=d*b[1];n=d*b[2];a*=b[3];c*=b[3];b=d*b[3];return[1-(l+n),h+b,k-c,0,h-b,1-(g+n),m+a,0,k+c,m-a,1-(g+l),0,0,0,0,1]},quatToAxisAngle:function(b){var a=b[3],f=1-a*a;return 0<f?(f=1/Math.sqrt(f),[b[0]*f,b[1]*f,b[2]*f,Math.acos(a)*c.Math.Num360DividedByPi]):[0,1,0,0]},quatFromVectors:function(b,a){var f=c.Math.vec3cross(b,a),d=Math.sqrt(c.Math.vec3dot(b,b))*Math.sqrt(c.Math.vec3dot(a,
a));0===d&&(d=1);f[3]=d+c.Math.vec3dot(b,a);return c.Math.quatNormInPlace(f)},quatFromAxisAngle:function(b,a,f,d){var g;"undefined"!==typeof f&&"undefined"!==typeof d?(g=a,a=d):"undefined"===typeof a?(g=b[0],f=b[1],a=b[2]):(g=a[0],f=a[1],a=a[2]);d=(0<=b&&360>b?b:b%360+(0>b?360:0))*c.Math.PiDividedBy360;b=Math.cos(d);d=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(d);g=c.Math.vec3normInPlace([g,f,a]);g=[g[0],g[1],g[2],b];g[0]*=d;g[1]*=d;g[2]*=d;return g},
quatFromTaitBryan:function(b,a,f,d){var g,h;if(null===d||"undefined"===typeof d)d=c.Math.RollPitchYaw;if(0>d||6<=d)throw Error("invalid mode");b.constructor===Array?(f=(0<=b[2]&&360>b[2]?b[2]:b[2]%360+(0>b[2]?360:0))*c.Math.PiDividedBy360,g=(0<=b[0]&&360>b[0]?b[0]:b[0]%360+(0>b[0]?360:0))*c.Math.PiDividedBy360,h=(0<=b[1]&&360>b[1]?b[1]:b[1]%360+(0>b[1]?360:0))*c.Math.PiDividedBy360):(f=(0<=f&&360>f?f:f%360+(0>f?360:0))*c.Math.PiDividedBy360,g=(0<=b&&360>b?b:b%360+(0>b?360:0))*c.Math.PiDividedBy360,
h=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.Math.PiDividedBy360);b=Math.cos(g);g=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(g);a=Math.cos(h);h=0<=h&&6.283185307179586>h?3.141592653589793>=h?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(h);var k=Math.cos(f);f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-k*k):-Math.sqrt(1-k*k):Math.sin(f);var l;d===c.Math.PitchYawRoll||d===c.Math.PitchRollYaw?(l=[f*h,k*h,f*a,k*a],d===c.Math.PitchYawRoll&&(l[0]=-l[0]),
d=[l[3]*g+l[0]*b,l[1]*b+l[2]*g,l[2]*b-l[1]*g,l[3]*b-l[0]*g]):d===c.Math.YawPitchRoll||d===c.Math.YawRollPitch?(l=[k*g,f*g,f*b,k*b],d===c.Math.YawRollPitch&&(l[1]=-l[1]),d=[l[0]*a-l[2]*h,l[3]*h+l[1]*a,l[2]*a+l[0]*h,l[3]*a-l[1]*h]):(l=[a*g,h*b,h*g,a*b],d===c.Math.RollPitchYaw&&(l[2]=-l[2]),d=[l[0]*k+l[1]*f,l[1]*k-l[0]*f,l[3]*f+l[2]*k,l[3]*k-l[2]*f]);return d},quatToTaitBryan:function(b,a){var f=b[3],d,g,h,k=1;if(null===a||"undefined"===typeof a)a=c.Math.RollPitchYaw;if(0>a||6<=a)throw Error("invalid mode");
a===c.Math.RollPitchYaw?(d=b[1],g=b[0],h=b[2],k=-1):a===c.Math.PitchYawRoll?(d=b[2],g=b[1],h=b[0],k=-1):a===c.Math.PitchRollYaw?(d=b[1],g=b[2],h=b[0]):a===c.Math.YawPitchRoll?(d=b[2],g=b[0],h=b[1]):a===c.Math.YawRollPitch?(d=b[0],g=b[2],h=b[1],k=-1):(d=b[0],g=b[1],h=b[2]);var l=g*g,m=Math.atan2(2*(f*d-k*g*h),1-2*(d*d+l)),n=2*(f*g+k*d*h);1<n&&(n=1);-1>n&&(n=-1);n=Math.asin(n);g=Math.atan2(2*(f*h-k*d*g),1-2*(l+h*h));m*=c.Math.Num180DividedByPi;n*=c.Math.Num180DividedByPi;g*=c.Math.Num180DividedByPi;
if(1E-6>Math.abs(n-90)||1E-6>Math.abs(n+90))g=0,m=Math.atan2(d,f)*c.Math.Num180DividedByPi,isNaN(m)&&(m=0);f=[];a===c.Math.RollPitchYaw?(f[0]=n,f[1]=m,f[2]=g):a===c.Math.PitchYawRoll?(f[0]=g,f[1]=n,f[2]=m):a===c.Math.PitchRollYaw?(f[0]=g,f[1]=m,f[2]=n):a===c.Math.YawPitchRoll?(f[0]=n,f[1]=g,f[2]=m):a===c.Math.YawRollPitch?(f[0]=m,f[1]=g,f[2]=n):(f[0]=m,f[1]=n,f[2]=g);return f},quatNlerp:function(b,a,f){var d=1-f,g=b[0]*d,h=b[1]*d,k=b[2]*d,d=b[3]*d,l=a[0]*f,m=a[1]*f,n=a[2]*f;f*=a[3];return 0>b[0]*
a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]?c.Math.quatNormInPlace([g-l,h-m,k-n,d-f]):c.Math.quatNormInPlace([g+l,h+m,k+n,d+f])},quatSlerp:function(b,a,f){var d=c.Math.quatDot(b,a),g=a;0>d&&(g=[-a[0],-a[1],-a[2],-a[3]],d=c.Math.quatDot(b,g));a=0;if(-1<d)if(1>d){if(a=Math.acos(d),0===a)return g.slice(0,4)}else return g.slice(0,4);else a=Math.PI;var h=1/Math.sin(a),d=Math.sin((1-f)*a)*h;f=Math.sin(f*a)*h;return[b[0]*d+g[0]*f,b[1]*d+g[1]*f,b[2]*d+g[2]*f,b[3]*d+g[3]*f]},quatRotate:function(b,a,f,d,g){return c.Math.quatMultiply(b,
c.Math.quatFromAxisAngle(a,f,d,g))},quatTransform:function(b,a){var c=b[1]*a[2]-b[2]*a[1]+a[0]*b[3],d=b[2]*a[0]-b[0]*a[2]+a[1]*b[3],g=b[0]*a[1]-b[1]*a[0]+a[2]*b[3],h=b[0]*a[0]+b[1]*a[1]+b[2]*a[2];return[c*b[3]-(d*b[2]-g*b[1])+b[0]*h,d*b[3]-(g*b[0]-c*b[2])+b[1]*h,g*b[3]-(c*b[1]-d*b[0])+b[2]*h,1]},quatFromMat4:function(b){var a=[],c=b[1],d=b[2],g=b[4],h=b[6],k=b[8],l=b[9],m=b[0]+b[5]+b[10];0<=m?(b=.5*Math.sqrt(m+1),m=.25/b,a[0]=(h-l)*m,a[1]=(k-d)*m,a[2]=(c-g)*m,a[3]=b):b[0]>b[5]&&b[0]>b[10]?(b=.5*Math.sqrt(1+
b[0]-b[5]-b[10]),m=.25/b,a[0]=b,a[1]=(g+c)*m,a[2]=(d+k)*m,a[3]=(h-l)*m):b[5]>b[10]?(b=.5*Math.sqrt(1+b[5]-b[0]-b[10]),m=.25/b,a[0]=(g+c)*m,a[1]=b,a[2]=(l+h)*m,a[3]=(k-d)*m):(b=.5*Math.sqrt(1+b[10]-b[0]-b[5]),m=.25/b,a[0]=(k+d)*m,a[1]=(l+h)*m,a[2]=b,a[3]=(c-g)*m);return a},mat4toMat3:function(b){return[b[0],b[1],b[2],b[4],b[5],b[6],b[8],b[9],b[10]]},mat4transpose:function(b){return c.Math.mat4transposeInPlace(b.slice(0,16))},mat4transposeInPlace:function(b){var a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=
b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return b},mat4inverseTranspose3:function(b){if(0===b[1]&&0===b[2]&&0===b[4]&&0===b[6]&&0===b[8]&&0===b[9])return 1===b[0]&&1===b[5]&&1===b[10]?[1,0,0,0,1,0,0,0,1]:0!==b[0]*b[5]*b[10]?[1/b[0],0,0,0,1/b[5],0,0,0,1/b[10]]:[1,0,0,0,1,0,0,0,1];b=[b[0],b[1],b[2],b[4],b[5],b[6],b[8],b[9],b[10]];var a=b[0]*b[4]*b[8]+b[3]*b[7]*b[2]+b[6]*b[1]*b[5]-b[6]*b[4]*b[2]-b[3]*b[1]*b[8]-b[0]*b[7]*b[5];
if(0===a)return[1,0,0,0,1,0,0,0,1];a=1/a;return[(-b[5]*b[7]+b[4]*b[8])*a,(b[5]*b[6]-b[3]*b[8])*a,(-b[4]*b[6]+b[3]*b[7])*a,(b[2]*b[7]-b[1]*b[8])*a,(-b[2]*b[6]+b[0]*b[8])*a,(b[1]*b[6]-b[0]*b[7])*a,(-b[2]*b[4]+b[1]*b[5])*a,(b[2]*b[3]-b[0]*b[5])*a,(-b[1]*b[3]+b[0]*b[4])*a]},mat4scale:function(b,a,c,d){var g;"undefined"!==typeof c&&"undefined"!==typeof d?(g=a,a=d):(g=a[0],c=a[1],a=a[2]);return[b[0]*g,b[1]*g,b[2]*g,b[3]*g,b[4]*c,b[5]*c,b[6]*c,b[7]*c,b[8]*a,b[9]*a,b[10]*a,b[11]*a,b[12],b[13],b[14],b[15]]},
mat4scaled:function(b,a,c){return"undefined"!==typeof a&&"undefined"!==typeof c?[b,0,0,0,0,a,0,0,0,0,c,0,0,0,0,1]:[b[0],0,0,0,0,b[1],0,0,0,0,b[2],0,0,0,0,1]},mat4transform:function(b,a,c,d,g){var h;"undefined"!==typeof c&&"undefined"!==typeof d&&"undefined"!==typeof g?(h=a,a=g):(h=a[0],c=a[1],d=a[2],a=a[3]);return[h*b[0]+c*b[4]+d*b[8]+a*b[12],h*b[1]+c*b[5]+d*b[9]+a*b[13],h*b[2]+c*b[6]+d*b[10]+a*b[14],h*b[3]+c*b[7]+d*b[11]+a*b[15]]},mat4transformVec3:function(b,a,c,d){var g;"undefined"!==typeof c&&
"undefined"!==typeof d?(g=a,a=d):(g=a[0],c=a[1],a=a[2]);return[g*b[0]+c*b[4]+a*b[8]+b[12],g*b[1]+c*b[5]+a*b[9]+b[13],g*b[2]+c*b[6]+a*b[10]+b[14],g*b[3]+c*b[7]+a*b[11]+b[15]]},mat3transform:function(b,a,c,d){var g;"undefined"!==typeof c&&"undefined"!==typeof d?(g=a,a=d):(g=a[0],c=a[1],a=a[2]);return[g*b[0]+c*b[3]+a*b[6],g*b[1]+c*b[4]+a*b[7],g*b[2]+c*b[5]+a*b[8]]},mat4translated:function(b,a,c){var d;"undefined"!==typeof a&&"undefined"!==typeof c?(d=b,b=c):(d=b[0],a=b[1],b=b[2]);return[1,0,0,0,0,1,
0,0,0,0,1,0,d,a,b,1]},mat4translate:function(b,a,c,d){var g;"undefined"!==typeof c&&"undefined"!==typeof d?(g=a,a=d):(g=a[0],c=a[1],a=a[2]);return[b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9],b[10],b[11],b[0]*g+b[4]*c+b[8]*a+b[12],b[1]*g+b[5]*c+b[9]*a+b[13],b[2]*g+b[6]*c+b[10]*a+b[14],b[3]*g+b[7]*c+b[11]*a+b[15]]},mat4perspective:function(b,a,f,d){b=1/Math.tan((0<=b&&360>b?b:b%360+(0>b?360:0))*c.Math.PiDividedBy360);var g;g=1/(f-d);return[b/a,0,0,0,0,b,0,0,0,0,g*(f+d),-1,0,0,g*f*d*2,0]},mat4lookat:function(b,
a,f){f||(f=[0,1,0]);a||(a=[0,0,0]);a=[a[0]-b[0],a[1]-b[1],a[2]-b[2]];var d=c.Math.vec3length(a);if(1E-6>d)return c.Math.mat4identity();d=1/d;a[0]*=d;a[1]*=d;a[2]*=d;f=c.Math.vec3norm(f);f=c.Math.vec3cross(a,f);c.Math.vec3normInPlace(f);d=c.Math.vec3cross(f,a);c.Math.vec3normInPlace(d);a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return[f[0],d[0],a[0],0,f[1],d[1],a[1],0,f[2],d[2],a[2],0,-c.Math.vec3dot(b,f),-c.Math.vec3dot(b,d),-c.Math.vec3dot(b,a),1]},mat4ortho:function(b,a,c,d,g,h){var k=1/(a-b),l=1/(d-c),m=
1/(h-g);return[2*k,0,0,0,0,2*l,0,0,0,0,-2*m,0,-(b+a)*k,-(d+c)*l,-(g+h)*m,1]},mat4perspectiveHorizontal:function(b,a,f,d){return c.Math.mat4perspective(c.Math.Num360DividedByPi*Math.atan2(Math.tan((0<=b&&360>b?b:b%360+(0>b?360:0))*c.Math.PiDividedBy360),a),a,f,d)},mat4ortho2d:function(b,a,f,d){return c.Math.mat4ortho2d(b,a,f,d,-1,1)},mat4ortho2dAspect:function(b,a,f,d,g){return c.Math.mat4orthoAspect(b,a,f,d,-1,1,g)},mat4orthoAspect:function(b,a,f,d,g,h,k){k/=Math.abs((a-b)/(d-f));var l=Math.abs(a-
b),m=Math.abs(d-f);1>k?(k=m/k,d>f?(f-=.5*(k-m),d+=.5*(k-m)):(d-=.5*(k-m),f+=.5*(k-m))):(k*=l,a>b?(b-=.5*(k-l),a+=.5*(k-l)):(a-=.5*(k-l),b+=.5*(k-l)));return c.Math.mat4ortho(b,a,f,d,g,h)},mat4frustum:function(b,a,c,d,g,h){var k=2*g,l=1/(a-b),m=1/(d-c),n=1/(h-g);return[k*l,0,0,0,0,k*m,0,0,(b+a)*l,(d+c)*m,-(h+g)*n,-1,0,0,-(k*h)*n,0]},mat4scaleInPlace:function(b,a,c,d){var g;"undefined"!==typeof c&&"undefined"!==typeof d?(g=a,a=d):(g=a[0],c=a[1],a=a[2]);b[0]*=g;b[1]*=g;b[2]*=g;b[3]*=g;b[4]*=c;b[5]*=
c;b[6]*=c;b[7]*=c;b[8]*=a;b[9]*=a;b[10]*=a;b[11]*=a;return b},mat4multiply:function(b,a){for(var c=[],d=0;16>d;d+=4)for(var g=0;4>g;g++)c[d+g]=a[d]*b[g]+a[d+1]*b[g+4]+a[d+2]*b[g+8]+a[d+3]*b[g+12];return c},quatMultiply:function(b,a){return[b[3]*a[0]+b[0]*a[3]+b[1]*a[2]-b[2]*a[1],b[3]*a[1]+b[1]*a[3]+b[2]*a[0]-b[0]*a[2],b[3]*a[2]+b[2]*a[3]+b[0]*a[1]-b[1]*a[0],b[3]*a[3]-b[0]*a[0]-b[1]*a[1]-b[2]*a[2]]},mat4rotate:function(b,a,f,d,g){var h,k;"undefined"!==typeof d&&"undefined"!==typeof g?(h=f,k=d,f=g,
g=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.Math.PiDividedBy180):"undefined"===typeof f?(h=a[0],k=a[1],f=a[2],g=a[3],g=(0<=g&&360>g?g:g%360+(0>g?360:0))*c.Math.PiDividedBy180):(h=f[0],k=f[1],f=f[2],g=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.Math.PiDividedBy180);a=Math.cos(g);var l=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(g);if(1===h&&0===k&&0===f)return[b[0],b[1],b[2],b[3],a*b[4]+b[8]*l,a*b[5]+b[9]*l,a*b[6]+b[10]*l,a*b[7]+b[11]*l,a*b[8]-l*b[4],a*b[9]-l*b[5],
a*b[10]-l*b[6],a*b[11]-l*b[7],b[12],b[13],b[14],b[15]];if(0===h&&1===k&&0===f)return[a*b[0]-l*b[8],a*b[1]-l*b[9],a*b[2]-l*b[10],a*b[3]-l*b[11],b[4],b[5],b[6],b[7],a*b[8]+b[0]*l,a*b[9]+b[1]*l,a*b[10]+b[2]*l,a*b[11]+b[3]*l,b[12],b[13],b[14],b[15]];if(0===h&&0===k&&1===f)return[a*b[0]+b[4]*l,a*b[1]+b[5]*l,a*b[2]+b[6]*l,a*b[3]+b[7]*l,a*b[4]-l*b[0],a*b[5]-l*b[1],a*b[6]-l*b[2],a*b[7]-l*b[3],b[8],b[9],b[10],b[11],b[12],b[13],b[14],b[15]];if(0===h&&0===k&&0===f)return b.slice(0,16);g=1/Math.sqrt(h*h+k*k+
f*f);h*=g;k*=g;f*=g;var m=k*k;d=1-a;var n=h*k,p=k*f;g=h*l;k*=l;var q=f*l,l=d*p,r=d*n,t=d*h*f;h=a+d*h*h;n=r+q;p=t-k;m=a+d*m;q=r-q;r=l+g;f=a+d*f*f;a=t+k;g=l-g;return[b[0]*h+b[4]*n+b[8]*p,b[1]*h+b[5]*n+b[9]*p,b[10]*p+b[2]*h+b[6]*n,b[11]*p+b[3]*h+b[7]*n,b[0]*q+b[4]*m+b[8]*r,b[1]*q+b[5]*m+b[9]*r,b[10]*r+b[2]*q+b[6]*m,b[11]*r+b[3]*q+b[7]*m,b[0]*a+b[4]*g+b[8]*f,b[1]*a+b[5]*g+b[9]*f,b[10]*f+b[2]*a+b[6]*g,b[11]*f+b[3]*a+b[7]*g,b[12],b[13],b[14],b[15]]},mat4rotated:function(a,e,f,d){var g;"undefined"!==typeof f&&
"undefined"!==typeof d?(g=e,e=d,d=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.Math.PiDividedBy180):"undefined"===typeof e?(g=a[0],f=a[1],e=a[2],d=a[3],d=(0<=d&&360>d?d:d%360+(0>d?360:0))*c.Math.PiDividedBy180):(g=e[0],f=e[1],e=e[2],d=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.Math.PiDividedBy180);a=Math.cos(d);var h=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);if(1===g&&0===f&&0===e)return[1,0,0,0,0,a,h,0,0,-h,a,0,0,0,0,1];if(0===g&&1===f&&0===e)return[a,0,-h,0,0,
1,0,0,h,0,a,0,0,0,0,1];if(0===g&&0===f&&1===e)return[a,h,0,0,-h,a,0,0,0,0,1,0,0,0,0,1];if(0===g&&0===f&&0===e)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];d=1/Math.sqrt(g*g+f*f+e*e);g*=d;f*=d;e*=d;d=g*g;var k=f*f,l=e*e,m=g*e,n=f*e,p=g*h,q=f*h,h=e*h,r=1-a;g=r*g*f;f=r*m;e=r*n;return[a+r*d,g+h,f-q,0,g-h,a+r*k,e+p,0,f+q,e-p,a+r*l,0,0,0,0,1]}};c.Math.planeNormInPlace=function(a){var c=a[0],f=a[1],d=a[2],c=Math.sqrt(c*c+f*f+d*d);0!==c&&(c=1/c,a[0]*=c,a[1]*=c,a[2]*=c,a[3]*=c);return a};c.Math.planeNorm=function(a){return c.Math.planeNormInPlace(a.slice(0,
4))};c.Math.mat4toFrustumPlanes=function(a){var e=[[],[],[],[],[],[]];e[0]=c.Math.planeNormInPlace([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]]);e[1]=c.Math.planeNormInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);e[2]=c.Math.planeNormInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);e[3]=c.Math.planeNormInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]);e[4]=c.Math.planeNormInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);e[5]=c.Math.planeNormInPlace([a[3]-a[2],a[7]-a[6],a[11]-
a[10],a[15]-a[14]]);return e};c.Math.frustumHasSphere=function(a,c,f,d,g){if(0>g)throw Error("radius is negative");for(var h=0;6>h;h++){var k=a[h];if(k[3]+k[0]*c+k[1]*f+k[2]*d<-g)return!1}return!0};c.Math.boxIsEmpty=function(a){return!(a[0]<=a[3]&&a[1]<=a[4]&&a[2]<=a[5])};c.Math.frustumHasBox=function(a,e){if(c.Math.boxIsEmpty(e))return!1;for(var f=0;6>f;f++){var d=a[f],g=d[3],h=d[0]*e[0],k=d[2]*e[2],l=d[1]*e[1];if(0>=h+l+k+g&&0>=d[0]*e[3]+d[1]*e[4]+d[2]*e[5]+g&&0>=h+d[1]*e[4]+k+g&&0>=h+d[1]*e[4]+
d[2]*e[5]+g&&0>=h+l+d[2]*e[5]+g&&0>=d[0]*e[3]+d[1]*e[4]+k+g&&0>=d[0]*e[3]+l+k+g&&0>=d[0]*e[3]+l+d[2]*e[5]+g)return!1}return!0};c.Math.frustumHasPoint=function(a,c,f,d){for(var g=0;6>g;g++)if(0>=a[g][0]*c+a[g][1]*f+a[g][2]*d+a[g][3])return!1;return!0};c.Math.quatDot=c.Math.vec4dot;c.Math.quatNormInPlace=c.Math.vec4normInPlace;c.Math.quatNorm=c.Math.vec4norm;c.Math.quatLength=c.Math.vec4length;c.Math.quatScaleInPlace=c.Math.vec4scaleInPlace;c.Math.quatCopy=c.Math.vec4copy;c.Math.PiTimes2=6.283185307179586;
c.Math.HalfPi=1.5707963267948966;c.Math.PiDividedBy180=.017453292519943295;c.Math.PiDividedBy360=.008726646259971648;c.Math.Num360DividedByPi=114.59155902616465;c.Math.Num180DividedByPi=57.29577951308232;c.Math.PitchYawRoll=0;c.Math.PitchRollYaw=1;c.Math.YawPitchRoll=2;c.Math.YawRollPitch=3;c.Math.RollPitchYaw=4;c.Math.RollYawPitch=5;c.Math.quatInverse=c.Math.quatInvert}});var SubMesh=function(a,c,b){this._initialize(a,c,b)};H3DU.Mesh=function(a,c,b){this.subMeshes=null!==a&&"undefined"!==typeof a?[new SubMesh(a,c,b)]:[];this._elementsDefined=0;this.currentMode=-1;this.normal=[0,0,0];this.color=[0,0,0];this.tangent=[0,0,0];this.bitangent=[0,0,0];this.texCoord=[0,0]};H3DU.Mesh._primitiveType=function(a){return a===H3DU.Mesh.LINES||a===H3DU.Mesh.LINE_STRIP?H3DU.Mesh.LINES:a===H3DU.Mesh.POINTS?H3DU.Mesh.POINTS:H3DU.Mesh.TRIANGLES};
H3DU.Mesh._isCompatibleMode=function(a,c){return a===c||H3DU.Mesh._primitiveType(a)===H3DU.Mesh._primitiveType(c)?!0:!1};H3DU.Mesh._recalcNormalsStart=function(a,c,b,e,f,d){for(b=0;b<a.length;b+=e)if(a[b+f]=0,a[b+f+1]=0,a[b+f+2]=0,!d){var g=[a[b],a[b+1],a[b+2]];c[g]?c[g].push(b+f):c[g]=[b+f]}};
H3DU.Mesh._recalcNormalsFinish=function(a,c,b,e,f,d){b=[];var g=0;if(!d)for(var h in c){var k=c[h];if(k&&k.constructor===Array&&2<=k.length){d=k[0];var l=a[d],m=a[d+1],n=a[d+2];b[0]=l;b[1]=m;b[2]=n;g=3;for(d=1;d<k.length;d++){for(var p=!1,q=a[k[d]],r=a[k[d]+1],t=a[k[d]+2],u=0;u<g;u+=3)if(q===b[u]&&r===b[u+1]&&t===b[u+2]){p=!0;break}p||(b[g++]=q,b[g++]=r,b[g++]=t,l+=q,m+=r,n+=t)}for(d=0;d<k.length;d++)a[k[d]]=l,a[k[d]+1]=m,a[k[d]+2]=n}}for(d=0;d<a.length;d+=e)if(h=a[d+f],b=a[d+f+1],g=a[d+f+2],c=Math.sqrt(h*
h+b*b+g*g))c=1/c,a[d+f]=h*c,a[d+f+1]=b*c,a[d+f+2]=g*c};
H3DU.Mesh._recalcNormals=function(a,c,b,e,f,d){d=d?-1:1;var g={},h;H3DU.Mesh._recalcNormalsStart(a,g,c,b,e,f);for(var k=0;k<c.length;k+=3){var l=c[k]*b,m=c[k+1]*b,n=c[k+2]*b;h=[a[l]-a[n],a[l+1]-a[n+1],a[l+2]-a[n+2]];var p=[a[m]-a[n],a[m+1]-a[n+1],a[m+2]-a[n+2]],q=h[1]*p[2]-h[2]*p[1],r=h[2]*p[0]-h[0]*p[2],p=h[0]*p[1]-h[1]*p[0];h=Math.sqrt(q*q+r*r+p*p);0!==h&&(h=1/h,h*=d,q*=h,r*=h,p*=h,a[l+e]+=q,a[l+e+1]+=r,a[l+e+2]+=p,a[m+e]+=q,a[m+e+1]+=r,a[m+e+2]+=p,a[n+e]+=q,a[n+e+1]+=r,a[n+e+2]+=p)}H3DU.Mesh._recalcNormalsFinish(a,
g,c,b,e,f)};H3DU.Mesh.prototype.mode=function(a){if(0>a)throw Error("invalid mode");if(-1!==this.currentMode&&H3DU.Mesh._isCompatibleMode(this.currentMode,a))this.subMeshes[this.subMeshes.length-1].newPrimitive();else{var c=0,b=H3DU.Mesh._primitiveType(a);b===H3DU.Mesh.LINES?c|=H3DU.Mesh.LINES_BIT:b===H3DU.Mesh.POINTS&&(c|=H3DU.Mesh.POINTS_BIT);this.subMeshes.push(new SubMesh([],[],c))}this.currentMode=a;return this};
H3DU.Mesh.prototype.merge=function(a){for(var c=this.subMeshes[this.subMeshes.length-1],b=c?c.attributeBits&H3DU.Mesh.PRIMITIVES_BITS:0,e=0;e<a.subMeshes.length;e++){var f=a.subMeshes[e];if(0!==f.indices.length)if(!c||(f.attributeBits&H3DU.Mesh.PRIMITIVES_BITS)!==b||196605<c.vertices.length+f.vertices.length||c.attributeBits!==f.attributeBits)c=new SubMesh(f.vertices.slice(0,f.vertices.length),f.indices.slice(0,f.indices.length),f.attributeBits),this.subMeshes.push(c),b=c.attributeBits&H3DU.Mesh.PRIMITIVES_BITS;
else{var d=c.vertexCount(),e=c.indices.length;c.vertices.push.apply(c.vertices,f.vertices);for(c.indices.push.apply(c.indices,f.indices);e<c.indices.length;e++)c.indices[e]+=d}}c.newPrimitive();return this};H3DU.Mesh.prototype.normal3=function(a,c,b){"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.normal[0]=a,this.normal[1]=c,this.normal[2]=b):(this.normal[0]=a[0],this.normal[1]=a[1],this.normal[2]=a[2]);this._elementsDefined|=H3DU.Mesh.NORMALS_BIT;return this};
H3DU.Mesh.prototype.tangent3=function(a,c,b){"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.tangent[0]=a,this.tangent[1]=c,this.tangent[2]=b):(this.tangent[0]=a[0],this.tangent[1]=a[1],this.tangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.TANGENTS_BIT;return this};
H3DU.Mesh.prototype.bitangent3=function(a,c,b){"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.bitangent[0]=a,this.bitangent[1]=c,this.bitangent[2]=b):(this.bitangent[0]=a[0],this.bitangent[1]=a[1],this.bitangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.BITANGENTS_BIT;return this};H3DU.Mesh.prototype.transform=function(a){for(var c=0;c<this.subMeshes.length;c++)this.subMeshes[c].transform(a);return this};
H3DU.Mesh.prototype.color3=function(a,c,b){"string"===typeof a?(a=H3DU.toGLColor(a),this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]):"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.color[0]=a,this.color[1]=c,this.color[2]=b):(this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]);this._elementsDefined|=H3DU.Mesh.COLORS_BIT;return this};
H3DU.Mesh.prototype.texCoord2=function(a,c){"number"===typeof a&&"number"===typeof c?(this.texCoord[0]=a,this.texCoord[1]=c):(this.texCoord[0]=a[0],this.texCoord[1]=a[1]);this._elementsDefined|=H3DU.Mesh.TEXCOORDS_BIT;return this};
H3DU.Mesh.prototype.vertex3=function(a,c,b){0===this.subMeshes.length&&this.subMeshes.push(new SubMesh);var e=this.subMeshes[this.subMeshes.length-1];null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?e.vertex3(a,c,b,this):"number"!==typeof a?e.vertex3(a[0],a[1],a[2],this):e.vertex3(a,a,a,this);return this};
H3DU.Mesh.prototype.vertex2=function(a,c){return null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c?this.vertex3(a,c,0):"number"!==typeof a?this.vertex3(a[0],a[1],0):this.vertex3(a,a,0)};H3DU.Mesh.prototype.setColor3=function(a,c,b){var e=a;"string"===typeof a&&(a=H3DU.toGLColor(a),e=a[0],c=a[1],b=a[2]);for(a=0;a<this.subMeshes.length;a++)this.subMeshes[a].setColor3(e,c,b);return this};
H3DU.Mesh.prototype.recalcTangents=function(){for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].primitiveType()===H3DU.Mesh.TRIANGLES&&this.subMeshes[a].recalcTangents();return this};H3DU.Mesh.prototype.recalcNormals=function(a,c){for(var b=0;b<this.subMeshes.length;b++){var e=this.subMeshes[b].primitiveType();e!==H3DU.Mesh.POINTS&&e!==H3DU.Mesh.LINES&&this.subMeshes[b].recalcNormals(a,c)}return this};
H3DU.Mesh.prototype.normalizeNormals=function(){for(var a=0;a<this.subMeshes.length;a++){var c=this.subMeshes[a].getStride(),b=this.subMeshes[a].vertices,e=H3DU.Mesh._normalOffset(this.subMeshes[a].attributeBits);if(!(0>e))for(a=0;a<b.length;a+=c){var f=b[a+e],d=b[a+e+1],g=b[a+e+2],f=Math.sqrt(f*f+d*d+g*g);0!==f&&(f=1/f,b[a+e]*=f,b[a+e+1]*=f,b[a+e+2]*=f)}}return this};
H3DU.Mesh.prototype.toWireFrame=function(){for(var a=new H3DU.Mesh,c=0;c<this.subMeshes.length;c++)a.subMeshes.push(this.subMeshes[c].toWireFrame());return a};H3DU.Mesh.prototype.setVertex=function(a,c,b,e){if(0>a)return this;"undefined"===typeof b&&"undefined"===typeof e&&(b=c[1],e=c[2],c=c[0]);for(var f=0,d=0;d<this.subMeshes.length;d++){var g=this.subMeshes[d],h=g.vertexCount(),h=f+h;if(a<h){a-=f;a*=g.getStride();g.vertices[a]=c;g.vertices[a+1]=b;g.vertices[a+2]=e;break}f=h}return this};
H3DU.Mesh.prototype.setVertexNormal=function(a,c,b,e){if(0>a)return this;var f=0;"undefined"===typeof b&&"undefined"===typeof e&&(b=c[1],e=c[2],c=c[0]);for(var d=0;d<this.subMeshes.length;d++){var g=this.subMeshes[d],h=g.vertexCount(),h=f+h;if(a<h){a-=f;g._rebuildVertices(H3DU.Mesh.NORMALS_BIT);a*=g.getStride();a+=H3DU.Mesh._normalOffset(g.attributeBits);g.vertices[a]=c;g.vertices[a+1]=b;g.vertices[a+2]=e;break}f=h}return this};
H3DU.Mesh.prototype.getVertex=function(a){if(0>a)return null;for(var c=0,b=0;b<this.subMeshes.length;b++){var e=this.subMeshes[b],f=e.vertexCount(),f=c+f;if(a<f)return a-=c,a*=e.getStride(),e.vertices.slice(a,a+3);c=f}return null};
H3DU.Mesh.prototype.getVertexNormal=function(a){for(var c=0,b=0;b<this.subMeshes.length;b++){var e=this.subMeshes[b],f=e.vertexCount(),f=c+f;if(a<f)return 0!==(e.attributeBits&H3DU.Mesh.NORMALS_BIT)?(a-=c,a*=e.getStride(),a+=H3DU.Mesh._normalOffset(e.attributeBits),e.vertices.slice(a,a+3)):[0,0,0];c=f}return null};H3DU.Mesh.prototype.vertexCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].vertexCount();return a};
H3DU.Mesh.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].primitiveCount();return a};
SubMesh.prototype._initialize=function(a,c,b){this.vertices=a||[];this.indices=c||[];this.startIndex=0;a=b&H3DU.Mesh.PRIMITIVES_BITS;if(0!==a&&a!==H3DU.Mesh.LINES_BIT&&a!==H3DU.Mesh.POINTS_BIT)throw Error("invalid format");this.attributeBits=null===b||"undefined"===typeof b?0:b;this.vertexCount=function(){return this.vertices.length/this.getStride()};this.getStride=function(){return H3DU.Mesh._getStride(this.attributeBits)};this.newPrimitive=function(a){this.startIndex=this.vertices.length;return this};
this.primitiveType=function(){var a=H3DU.Mesh.TRIANGLES;0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)&&(a=H3DU.Mesh.LINES);0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)&&(a=H3DU.Mesh.POINTS);return a};this._rebuildVertices=function(a){var b=this.attributeBits;a=b|a&H3DU.Mesh.ATTRIBUTES_BITS;if(a!==b){for(var c=this.getStride(),g,h,k,l=[],m=0;m<this.vertices.length;m+=c){var n=m+3;l.push(this.vertices[m],this.vertices[m+1],this.vertices[m+2]);0!==(a&H3DU.Mesh.NORMALS_BIT)&&(0!==(b&H3DU.Mesh.NORMALS_BIT)?
(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+2],n+=3,l.push(g,h,k)):l.push(0,0,0));0!==(a&H3DU.Mesh.COLORS_BIT)&&(0!==(b&H3DU.Mesh.COLORS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+2],n+=3,l.push(g,h,k)):l.push(0,0,0));0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(0!==(b&H3DU.Mesh.TEXCOORDS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],n+=2,l.push(g,h)):l.push(0,0));0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(0!==(b&H3DU.Mesh.TANGENTS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+
2],n+=3,l.push(g,h,k)):l.push(0,0,0));0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(0!==(b&H3DU.Mesh.BITANGENTS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+2],l.push(g,h,k)):l.push(0,0,0))}this.vertices=l;this.attributeBits=a}};this._setTriangle=function(a,b,c,g,h){var k=c*b,l=g*b,m=h*b,n=0,p=this.vertices;for(a-=b;0<=a&&16>n;a-=b,n++){for(var q=7,r=0;r<b&&0!==q;r++)0!==(q&1)&&p[k+r]!==p[a+r]&&(q&=-2),0!==(q&2)&&p[l+r]!==p[a+r]&&(q&=-3),0!==(q&4)&&p[m+r]!==p[a+r]&&(q&=-5);if(0!==(q&1)){c=
a/b;k=c*b;break}if(0!==(q&2)){g=a/b;l=g*b;break}if(0!==(q&4)){h=a/b;m=h*b;break}}p[k]===p[l]&&p[k+1]===p[l+1]&&p[k+2]===p[l+2]||p[k]===p[m]&&p[k+1]===p[m+1]&&p[k+2]===p[m+2]||p[l]===p[m]&&p[l+1]===p[m+1]&&p[l+2]===p[m+2]||this.indices.push(c,g,h)};this.vertex3=function(a,b,c,g){var h=g.currentMode;if(-1===h)throw Error("mode() not called");this._rebuildVertices(g._elementsDefined);var k=this.vertices.length;this.vertices.push(a,b,c);0!==(this.attributeBits&H3DU.Mesh.NORMALS_BIT)&&this.vertices.push(g.normal[0],
g.normal[1],g.normal[2]);0!==(this.attributeBits&H3DU.Mesh.COLORS_BIT)&&this.vertices.push(g.color[0],g.color[1],g.color[2]);0!==(this.attributeBits&H3DU.Mesh.TEXCOORDS_BIT)&&this.vertices.push(g.texCoord[0],g.texCoord[1]);0!==(this.attributeBits&H3DU.Mesh.TANGENTS_BIT)&&this.vertices.push(g.tangent[0],g.tangent[1],g.tangent[2]);0!==(this.attributeBits&H3DU.Mesh.BITANGENTS_BIT)&&this.vertices.push(g.bitangent[0],g.bitangent[1],g.bitangent[2]);a=this.getStride();h===H3DU.Mesh.QUAD_STRIP&&this.vertices.length-
this.startIndex>=4*a&&0===(this.vertices.length-this.startIndex)%(2*a)?(h=this.vertices.length/a-4,this._setTriangle(k,a,h,h+1,h+2),this._setTriangle(k,a,h+2,h+1,h+3)):h===H3DU.Mesh.QUADS&&0===(this.vertices.length-this.startIndex)%(4*a)?(h=this.vertices.length/a-4,this._setTriangle(k,a,h,h+1,h+2),this._setTriangle(k,a,h,h+2,h+3)):h===H3DU.Mesh.TRIANGLES&&0===(this.vertices.length-this.startIndex)%(3*a)?(h=this.vertices.length/a-3,this._setTriangle(k,a,h,h+1,h+2)):h===H3DU.Mesh.LINES&&0===(this.vertices.length-
this.startIndex)%(2*a)?(h=this.vertices.length/a-2,this.indices.push(h,h+1)):h===H3DU.Mesh.TRIANGLE_FAN&&this.vertices.length-this.startIndex>=3*a?(h=this.vertices.length/a-2,b=this.startIndex/a,this._setTriangle(k,a,b,h,h+1)):h===H3DU.Mesh.LINE_STRIP&&this.vertices.length-this.startIndex>=2*a?(h=this.vertices.length/a-2,this.indices.push(h,h+1)):h===H3DU.Mesh.POINTS?(h=this.vertices.length/a-1,this.indices.push(h)):h===H3DU.Mesh.TRIANGLE_STRIP&&this.vertices.length-this.startIndex>=3*a&&(h=this.vertices.length/
a-3,b=this.startIndex/a,0===(h-b&1)?this._setTriangle(k,a,h,h+1,h+2):this._setTriangle(k,a,h+1,h,h+2));return this}};SubMesh.prototype.makeRedundant=function(){for(var a=[],c=this.getStride(),b=this.indices.length,e=0;e<b;e++){var f=this.indices[e];if(a[f]){for(var d=f*c,g=this.vertices.length/c,h=0;h<c;h++)this.vertices.push(this.vertices[d+h]);this.indices[e]=g}a[f]=!0}return this};
SubMesh.prototype.primitiveCount=function(){return 0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};
SubMesh.prototype.toWireFrame=function(){function a(a,b,c,d){if(c<d){var e=c;c=d;d=e}(e=b[c])?0>e.indexOf(d)&&(e.push(d),a.push(c,d)):(b[c]=[d],a.push(c,d))}if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var c=[],b={},e=0;e<this.indices.length;e+=3){var f=this.indices[e],d=this.indices[e+1],g=this.indices[e+2];a(c,b,f,d);a(c,b,d,g);a(c,b,g,f)}return new SubMesh(this.vertices,c,this.attributeBits|H3DU.Mesh.LINES_BIT)};
SubMesh._isIdentityInUpperLeft=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[8]&&0===a[9]&&1===a[10]?!0:!1};
SubMesh.prototype.transform=function(a){var c=this.getStride(),b=this.vertices,e=!SubMesh._isIdentityInUpperLeft(a),f=H3DU.Mesh._normalOffset(this.attributeBits),d=null;0<=f&&e&&(d=H3DU.Math.mat4inverseTranspose3(a));for(var g=0;g<b.length;g+=c){var h=H3DU.Math.mat4transform(a,b[g],b[g+1],b[g+2],1);b[g]=h[0];b[g+1]=h[1];b[g+2]=h[2];0<=f&&e&&(h=H3DU.Math.mat3transform(d,b[g+f],b[g+f+1],b[g+f+2]),H3DU.Math.vec3normInPlace(h),b[g+f]=h[0],b[g+f+1]=h[1],b[g+f+2]=h[2])}this.newPrimitive();return this};
H3DU.Mesh.prototype.reverseWinding=function(){for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].reverseWinding();return this};
H3DU.Mesh.prototype.enumPrimitives=function(a){for(var c=0;c<this.subMeshes.length;c++){var b=this.subMeshes[c],e=b.primitiveType(),f=H3DU.Mesh._normalOffset(b.attributeBits),d=H3DU.Mesh._colorOffset(b.attributeBits),g=H3DU.Mesh._texCoordOffset(b.attributeBits),h=b.getStride(),k=b.vertices,l=3;e===H3DU.Mesh.LINES&&(l=2);e===H3DU.Mesh.POINTS&&(l=1);for(e=0;e<b.indices.length;e+=l){for(var m=[],n=0;n<l;n++){var p=b.indices[e+n]*h,q={};q.position=[k[p],k[p+1],k[p+2]];0<=f&&(q.normal=[k[p+f],k[p+f+1],
k[p+f+2]]);0<=d&&(q.color=[k[p+d],k[p+d+1],k[p+d+2]]);0<=g&&(q.uv=[k[p+g],k[p+g+1]]);m.push(q)}a(m)}}return this};
H3DU.Mesh.prototype.getBoundingBox=function(){for(var a=!0,c=Number.POSITIVE_INFINITY,c=[c,c,c,-c,-c,-c],b=0;b<this.subMeshes.length;b++)for(var e=this.subMeshes[b],f=e.getStride(),d=e.vertices,g=0;g<e.indices.length;g++){var h=e.indices[g]*f;a?(a=!1,c[0]=c[3]=d[h],c[1]=c[4]=d[h+1],c[2]=c[5]=d[h+2]):(c[0]=Math.min(c[0],d[h]),c[3]=Math.max(c[3],d[h]),c[1]=Math.min(c[1],d[h+1]),c[4]=Math.max(c[4],d[h+1]),c[2]=Math.min(c[2],d[h+2]),c[5]=Math.max(c[5],d[h+2]))}return c};
H3DU.Mesh._findTangentAndBitangent=function(a,c,b,e,f){var d=a[b]-a[c],g=a[b+1]-a[c+1],h=a[b+2]-a[c+2],k=a[e]-a[c],l=a[e+1]-a[c+1],m=a[e+2]-a[c+2],n=a[b+f]-a[c+f],p=a[b+f+1]-a[c+f+1];b=a[e+f]-a[c+f];a=a[e+f+1]-a[c+f+1];c=n*a-p*b;if(0===c)return[0,0,0,0,0,0];c=1/c;p=-p;b=-b;return[(a*d+p*k)*c,(a*g+p*l)*c,(a*h+p*m)*c,(b*d+n*k)*c,(b*g+n*l)*c,(b*h+n*m)*c]};
H3DU.Mesh._recalcTangentsInternal=function(a,c,b,e,f,d){for(var g=[0,0,0],h=0;h<c.length;h+=3){g[0]=c[h]*b;g[1]=c[h+1]*b;g[2]=c[h+2]*b;for(var k=H3DU.Mesh._findTangentAndBitangent(a,g[0],g[1],g[2],e),l=0;3>l;l++){var m=k,n=g[l],p=a[n+f],q=a[n+f+1],r=a[n+f+2],t=m[0]*p+m[1]*q+m[2]*r,t=H3DU.Math.vec3normInPlace([m[0]-t*p,m[1]-t*q,m[2]-t*r]),u=m[3]*p+m[4]*q+m[5]*r,x=m[3]*t[0]+m[4]*t[1]+m[5]*t[2],m=H3DU.Math.vec3normInPlace([m[3]-u*p-x*t[0],m[4]-u*q-x*t[1],m[5]-u*r-x*t[2]]);a[n+d]=t[0];a[n+d+1]=t[1];a[n+
d+2]=t[2];a[n+d+3]=m[0];a[n+d+4]=m[1];a[n+d+5]=m[2]}}};
SubMesh.prototype.recalcTangents=function(){var a=H3DU.Mesh.TANGENTS_BIT|H3DU.Mesh.BITANGENTS_BIT,c=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~a),b=H3DU.Mesh._texCoordOffset(this.attributeBits),e=H3DU.Mesh._normalOffset(this.attributeBits);if(0>b||0>e)return this;this._rebuildVertices(a);c&&this.makeRedundant();this.primitiveType()===H3DU.Mesh.TRIANGLES&&(a=H3DU.Mesh._tangentOffset(this.attributeBits),H3DU.Mesh._recalcTangentsInternal(this.vertices,this.indices,this.getStride(),b,e,a));return this};
H3DU.Mesh.prototype.reverseNormals=function(){for(var a=0;a<this.subMeshes.length;a++){var c=this.subMeshes[a].getStride(),b=this.subMeshes[a].vertices,e=H3DU.Mesh._normalOffset(this.subMeshes[a].attributeBits);if(!(0>e))for(a=0;a<b.length;a+=c){var f=b[a+e+1],d=b[a+e+2];b[a+e]=-b[a+e];b[a+e+1]=-f;b[a+e+2]=-d}}return this};
SubMesh.prototype.reverseWinding=function(){if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var a=0;a<this.indices.length;a+=3){var c=this.indices[a+2];this.indices[a+2]=this.indices[a+1];this.indices[a+1]=c}return this};
SubMesh.prototype.recalcNormals=function(a,c){var b=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~H3DU.Mesh.NORMALS_BIT);this._rebuildVertices(H3DU.Mesh.NORMALS_BIT);(b||a)&&this.makeRedundant();b=this.primitiveType();b!==H3DU.Mesh.LINES&&b!==H3DU.Mesh.POINTS&&H3DU.Mesh._recalcNormals(this.vertices,this.indices,this.getStride(),3,a,c);return this};
SubMesh.prototype.setColor3=function(a,c,b){this._rebuildVertices(H3DU.Mesh.COLORS_BIT);for(var e=this.getStride(),f=H3DU.Mesh._colorOffset(this.attributeBits);f<this.vertices.length;f+=e)this.vertices[f]=a,this.vertices[f+1]=c,this.vertices[f+2]=b;return this};H3DU.Mesh._getStride=function(a){var c=[3,6,6,9,5,8,8,11][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)];0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(c+=3);0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(c+=3);return c};
H3DU.Mesh._normalOffset=function(a){return[-1,3,-1,3,-1,3,-1,3][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh._tangentOffset=function(a){var c=3;if(0===(a&H3DU.Mesh.TANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(c+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(c+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(c+=2);return c};
H3DU.Mesh._bitangentOffset=function(a){var c=3;if(0===(a&H3DU.Mesh.BITANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(c+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(c+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(c+=2);0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(c+=3);return c};H3DU.Mesh._colorOffset=function(a){return[-1,-1,3,6,-1,-1,3,6][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};
H3DU.Mesh._texCoordOffset=function(a){return[-1,-1,-1,-1,3,6,6,9][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh.ATTRIBUTES_BITS=255;H3DU.Mesh.PRIMITIVES_BITS=768;H3DU.Mesh.NORMALS_BIT=1;H3DU.Mesh.COLORS_BIT=2;H3DU.Mesh.TEXCOORDS_BIT=4;H3DU.Mesh.TANGENTS_BIT=8;H3DU.Mesh.BITANGENTS_BIT=16;H3DU.Mesh.LINES_BIT=256;H3DU.Mesh.POINTS_BIT=512;H3DU.Mesh.TRIANGLES=4;H3DU.Mesh.QUAD_STRIP=8;H3DU.Mesh.QUADS=7;H3DU.Mesh.LINES=1;H3DU.Mesh.TRIANGLE_FAN=6;
H3DU.Mesh.TRIANGLE_STRIP=5;H3DU.Mesh.LINE_STRIP=3;H3DU.Mesh.POINTS=0;this.H3DU.Mesh=H3DU.Mesh;H3DU.SubMeshBuffer=function(a){this.vertices=new Float32Array(a.vertices);65536<=a.vertices.length||65536<=a.indices.length?(this.indexBufferSize=4,this.indices=new Uint32Array(a.indices)):256>=a.vertices.length&&256>=a.indices.length?(this.indexBufferSize=1,this.indices=new Uint8Array(a.indices)):(this.indexBufferSize=2,this.indices=new Uint16Array(a.indices));this.numVertices=a.vertices.length/a.getStride();this.facesLength=a.indices.length;this.format=a.attributeBits;this._stride=H3DU.Mesh._getStride(this.format);
this._attribsUsed=[0,H3DU.Mesh._normalOffset(this.format),H3DU.Mesh._colorOffset(this.format),H3DU.Mesh._texCoordOffset(this.format),H3DU.Mesh._tangentOffset(this.format),H3DU.Mesh._bitangentOffset(this.format)];this._sizes=[3,3,3,2,3,3]};H3DU.SubMeshBuffer.prototype.primitiveCount=function(){return 0!==(this.format&H3DU.Mesh.LINES_BIT)?Math.floor(this.facesLength/2):0!==(this.format&H3DU.Mesh.POINTS_BIT)?this.facesLength:Math.floor(this.facesLength/3)};
H3DU.MeshBuffer=function(a){this.subMeshes=[];this._bounds=a.getBoundingBox();for(var c=0;c<a.subMeshes.length;c++){var b=a.subMeshes[c];0!==b.indices.length&&this.subMeshes.push(new H3DU.SubMeshBuffer(b))}};H3DU.MeshBuffer.prototype._getBounds=function(){return this._bounds};H3DU.MeshBuffer.prototype.getFormat=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a|=this.subMeshes[c].format;return a};
H3DU.MeshBuffer.prototype.vertexCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].numVertices;return a};H3DU.MeshBuffer.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].primitiveCount();return a};H3DU.Meshes={};
H3DU.Meshes.createBox=function(a,c,b,e){a*=.5;c*=.5;b*=.5;a=[-a,-c,b,-1,0,0,1,0,-a,c,b,-1,0,0,1,1,-a,c,-b,-1,0,0,0,1,-a,-c,-b,-1,0,0,0,0,a,-c,-b,1,0,0,1,0,a,c,-b,1,0,0,1,1,a,c,b,1,0,0,0,1,a,-c,b,1,0,0,0,0,a,-c,-b,0,-1,0,1,0,a,-c,b,0,-1,0,1,1,-a,-c,b,0,-1,0,0,1,-a,-c,-b,0,-1,0,0,0,a,c,b,0,1,0,1,0,a,c,-b,0,1,0,1,1,-a,c,-b,0,1,0,0,1,-a,c,b,0,1,0,0,0,-a,-c,-b,0,0,-1,1,0,-a,c,-b,0,0,-1,1,1,a,c,-b,0,0,-1,0,1,a,-c,-b,0,0,-1,0,0,a,-c,b,0,0,1,1,0,a,c,b,0,0,1,1,1,-a,c,b,0,0,1,0,1,-a,-c,b,0,0,1,0,0];if(e)for(e=
0;e<a.length;e+=8)a[e+3]=-a[e+3],a[e+4]=-a[e+4],a[e+5]=-a[e+5];return new H3DU.Mesh(a,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.TEXCOORDS_BIT)};
H3DU.Meshes.createCylinder=function(a,c,b,e,f,d,g){var h=new H3DU.Mesh;if(null===e||"undefined"===typeof e)e=32;if(null===f||"undefined"===typeof f)f=1;if(2>=e)throw Error("too few slices");if(1>f)throw Error("too few stacks");if(0>b)throw Error("negative height");if(0>=a&&0>=c||0===b)return h;for(var k=g?-1:1,l=[0,1],m=[0],n=H3DU.Math.PiTimes2,p=1;p<e;p++){var q=1*p/e,r=n*q,t=Math.cos(r);l.push(0<=r&&6.283185307179586>r?3.141592653589793>=r?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(r),t);m.push(q)}l.push(0,
1);m.push(1);e*=2;if(0<b)for(n=0,q=a,p=0,a===c?(t=0,r=k):(p=Math.atan2(a-c,b),r=Math.cos(p),t=0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-r*r):-Math.sqrt(1-r*r):Math.sin(p),t*=k,r*=k),k=1/f,p=0;p<f;p++){var u=n,x=p+1==f?1:(p+1)*k,A=b*u,w=b*x,B=q,y=a+(c-a)*x,n=x,q=y;h.mode(H3DU.Mesh.TRIANGLE_STRIP);h.texCoord2(1,u);h.normal3(0,r,t);h.vertex3(0,B,A);h.texCoord2(1,x);h.normal3(0,r,t);h.vertex3(0,y,w);for(var C=2,I=1;C<=e;C+=2,I++){var v=m[I],z,D;z=l[C];D=l[C+1];h.texCoord2(1-v,u);h.normal3(z*
r,D*r,t);h.vertex3(z*B,D*B,A);h.texCoord2(1-v,x);h.normal3(z*r,D*r,t);h.vertex3(z*y,D*y,w)}}return d?h.recalcNormals(d,g):h};
H3DU.Meshes.createLathe=function(a,c,b,e){var f=new H3DU.Mesh;if(4>a.length)throw Error("too few points");if(null===c||"undefined"===typeof c)c=32;if(2>=c)throw Error("too few slices");if(0!=a.length%1)throw Error("points array length is not an even number");for(var d=0;d<a.length;d+=2)if(0>a[d<<1])throw Error("point's x is less than 0");for(var g=[0,1],h=[0],k=H3DU.Math.PiTimes2,d=1;d<c;d++){var l=1*d/c,m=k*l,n=Math.cos(m);g.push(0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-n*n):-Math.sqrt(1-
n*n):Math.sin(m),n);h.push(l)}g.push(0,1);h.push(1);c*=2;for(var p=0,k=a.length/2-1,l=1/k,d=0;d<k;d++){var m=p,n=d+1==k?1:(d+1)*l,p=d<<1,q=a[p+1],r=a[p+3],t=Math.min(q,r),q=Math.max(q,r),r=a[p],u=a[p+2],p=n;f.mode(H3DU.Mesh.TRIANGLE_STRIP);f.texCoord2(1,m);f.vertex3(0,r,t);f.texCoord2(1,n);f.vertex3(0,u,q);for(var x=2,A=1;x<=c;x+=2,A++){var w=h[A],B,y;B=g[x];y=g[x+1];f.texCoord2(1-w,m);f.vertex3(B*r,y*r,t);f.texCoord2(1-w,n);f.vertex3(B*u,y*u,q)}}return f.recalcNormals(b,e)};
H3DU.Meshes.createClosedCylinder=function(a,c,b,e,f,d,g){f=H3DU.Meshes.createCylinder(a,c,b,e,f,d,g);a=H3DU.Meshes.createDisk(0,a,e,2,!g).reverseWinding();c=H3DU.Meshes.createDisk(0,c,e,2,g);c.transform(H3DU.Math.mat4translated(0,0,b));return f.merge(a).merge(c)};H3DU.Meshes.createDisk=function(a,c,b,e,f){return H3DU.Meshes.createPartialDisk(a,c,b,e,0,360,f)};
H3DU.Meshes.createPartialDisk=function(a,c,b,e,f,d,g){var h=new H3DU.Mesh;if(null===b||"undefined"===typeof b)b=32;if(null===e||"undefined"===typeof e)e=1;if(null===f||"undefined"===typeof f)f=0;if(null===d||"undefined"===typeof d)d=360;if(2>=b)throw Error("too few slices");if(1>e)throw Error("too few loops");if(a>c)throw Error("inner greater than outer");0>a&&(a=0);0>c&&(c=0);if(0===c||0===d)return h;var k=360===d&&0===f,l=0>d?-1:1;0>d&&(d=-d);d%=360;0===d&&(d=360);var m=[],n=[],p=H3DU.Math.PiTimes2;
d=360===d?p:d*H3DU.Math.PiDividedBy180;f*=H3DU.Math.PiDividedBy180;0>l&&(d=-d);for(l=0;l<=b;l++){var q=1*l/b,r=1===q&&d===p?f:f+d*q,r=0>r?p- -r%p:r%p,t=Math.cos(r);m.push(0<=r&&6.283185307179586>r?3.141592653589793>=r?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(r),t);n.push(q)}k&&(m[0]=0,m[1]=1,m[m.length-1]=1,m[m.length-2]=0,n[0]=0,n[n.length-1]=1);b*=2;f=c-a;k=a;g?h.normal3(0,0,-1):h.normal3(0,0,1);for(l=0;l<e;l++){g=k;n=a+(l+1)/e*f;p=g/c;d=n/c;k=n;q=0===l&&0===a;h.mode(q?H3DU.Mesh.TRIANGLE_FAN:
H3DU.Mesh.TRIANGLE_STRIP);var u;if(q)for(r=b/2,q=b,u=r;0<=q;q-=2,u--)r=m[q],t=m[q+1],q===b&&(h.texCoord2(.5*(1+r*p),.5*(1+t*p)),h.vertex3(r*g,t*g,0)),h.texCoord2(.5*(1+r*d),.5*(1+t*d)),h.vertex3(r*n,t*n,0);else for(u=q=0;q<=b;q+=2,u++)r=m[q],t=m[q+1],h.texCoord2(.5*(1+r*d),.5*(1+t*d)),h.vertex3(r*n,t*n,0),h.texCoord2(.5*(1+r*p),.5*(1+t*p)),h.vertex3(r*g,t*g,0)}return h};
H3DU.Meshes.createTorus=function(a,c,b,e,f,d){var g=new H3DU.Mesh;if(null===e||"undefined"===typeof e)e=16;if(null===b||"undefined"===typeof b)b=16;if(3>e)throw Error("crosswise is less than 3");if(3>b)throw Error("lengthwise is less than 3");if(0>a||0>c)throw Error("inner or outer is less than 0");if(0===c||0===a)return g;for(var h=H3DU.Math.PiTimes2,k=[],l=[],m,n,p=0;p<e;p++)n=p*h/e,m=Math.cos(n),n=0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(n),k.push(n,
m);k.push(k[0]);k.push(k[1]);for(p=0;p<b;p++)n=p*h/b,m=Math.cos(n),n=0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(n),l.push(n,m);l.push(l[0]);l.push(l[1]);for(h=0;h<b;h++){m=h/b;var q=(h+1)/b,r=l[2*h],t=l[2*h+1],u=l[2*h+2],x=l[2*h+3];g.mode(H3DU.Mesh.TRIANGLE_STRIP);for(p=0;p<=e;p++){n=p/e;var A=k[2*p],w=k[2*p+1],B=w*(c+x*a),y=A*(c+x*a),C=u*a,I=x*w,v=x*A,z=u;g.normal3(I,v,z);g.texCoord2(n,q);g.vertex3(B,y,C);B=w*(c+t*a);y=A*(c+t*a);C=r*a;I=t*w;v=t*A;z=
r;g.normal3(I,v,z);g.texCoord2(n,m);g.vertex3(B,y,C)}}return f?g.recalcNormals(f,d):g};
H3DU.Meshes.createPlane=function(a,c,b,e,f){var d=new H3DU.Mesh;if(null===a||"undefined"===typeof a)a=1;if(null===c||"undefined"===typeof c)c=1;if(null===b||"undefined"===typeof b)b=1;if(null===e||"undefined"===typeof e)e=1;if(0>a||0>c)throw Error("width or height is less than 0");if(0>=e||0>=b)throw Error("widthDiv or heightDiv is 0 or less");if(0===a||0===c)return d;var g=.5*-a,h=.5*-c;f?d.normal3(0,0,-1):d.normal3(0,0,1);for(f=0;f<e;f++){d.mode(H3DU.Mesh.TRIANGLE_STRIP);var k=f/e,l=(f+1)/e,m=h+
c*k,n=h+c*l;d.texCoord2(0,l);d.vertex3(g,n,0);d.texCoord2(0,k);d.vertex3(g,m,0);for(var p=0;p<b;p++){var q=(p+1)/b,r=g+a*q;d.texCoord2(q,l);d.vertex3(r,n,0);d.texCoord2(q,k);d.vertex3(r,m,0)}}return d};H3DU.Meshes.createSphere=function(a,c,b,e,f){return H3DU.Meshes._createCapsule(a,0,c,b,1,e,f)};H3DU.Meshes.createCapsule=function(a,c,b,e,f,d,g){if(null===e||"undefined"===typeof e)e=8;if(1>e)throw Error("too few stacks");return H3DU.Meshes._createCapsule(a,c,b,2*e,f,d,g)};
H3DU.Meshes._createCapsule=function(a,c,b,e,f,d,g){function h(a,b,c,d,e,g){a.normal3(c*b,d*b,e*b);a.vertex3(c,d,e+g)}var k=new H3DU.Mesh;if(null===b||"undefined"===typeof b)b=16;if(null===e||"undefined"===typeof e)e=16;if(null===f||"undefined"===typeof f)f=1;if(null===a||"undefined"===typeof a)a=1;if(null===c||"undefined"===typeof c)c=1;if(2>e)throw Error("too few stacks");if(2>=b)throw Error("too few slices");if(1>f&&0<c)throw Error("too few middle stacks");if(0>c)throw Error("negative length");
if(0>a)throw Error("negative radius");if(0===a)return k;for(var l=.5*c,m=e/2,n=g?-1:1,p=[0,1],q=[],r=[],t=[0],u,x,A=H3DU.Math.PiTimes2,w=1;w<b;w++){var B=1*w/b;u=A*B;var y=Math.cos(u);u=0<=u&&6.283185307179586>u?3.141592653589793>=u?Math.sqrt(1-y*y):-Math.sqrt(1-y*y):Math.sin(u);p.push(u,y);t.push(B)}p.push(0,1);t.push(1);A=2*a;A/=A+c;B=[];for(w=1;w<e;w++){var C=1*w/e;u=Math.PI*C;y=Math.cos(u);u=0<=u&&6.283185307179586>u?3.141592653589793>=u?Math.sqrt(1-y*y):-Math.sqrt(1-y*y):Math.sin(u);q.push(u);
B.push(-y);r.push(C)}q.push(0);r.push(1);B.push(1);b*=2;for(var y=-1,I=u=0,w=0;w<e;w++){var v=B[w],z=r[w];x=a*y;var C=a*v,D=w<m?-l:l,J=u,F=a*q[w],L=I,M=z;0<c&&(L=w<m?I*A:1-(1-I)*A,M=w<m?z*A:1-(1-z)*A);y=v;I=z;u=F;w===e-1||0===w?k.mode(H3DU.Mesh.TRIANGLES):(k.mode(H3DU.Mesh.TRIANGLE_STRIP),k.texCoord2(1,L),h(k,n,0,J,x,D),k.texCoord2(1,M),h(k,n,0,F,C,D));for(var K=0,N=0,G=1,E,H,z=2,O=1;z<=b;z+=2,O++)v=t[O],w===e-1?(E=K+.5*(v-K),k.texCoord2(1-K,L),h(k,n,N*J,G*J,x,D),k.texCoord2(1-E,M),h(k,n,0,F,C,D),
E=p[z],H=p[z+1],k.texCoord2(1-v,L),h(k,n,E*J,H*J,x,D),N=E,G=H,K=v):0===w?(E=K+.5*(v-K),k.texCoord2(1-E,L),h(k,n,0,J,x,D),k.texCoord2(1-K,M),h(k,n,N*F,G*F,C,D),E=p[z],H=p[z+1],k.texCoord2(1-v,M),h(k,n,E*F,H*F,C,D),N=E,G=H,K=v):(E=p[z],H=p[z+1],k.texCoord2(1-v,L),h(k,n,E*J,H*J,x,D),k.texCoord2(1-v,M),h(k,n,E*F,H*F,C,D));if(w+1===m&&0<c)for(D=.5*A,J=2*l,K=1-D,N=1-A,G=0;G<f;G++){x=-l+(0===G?0:J*G/f);var P=G===f-1?l:-l+J*(G+1)/f,L=D+(0===G?0:N*G/f),M=G===f-1?K:D+N*(G+1)/f;k.mode(H3DU.Mesh.TRIANGLE_STRIP);
k.texCoord2(1,L);h(k,n,0,F,C,x);k.texCoord2(1,M);h(k,n,0,F,C,P);z=2;for(O=1;z<=b;z+=2,O++)v=t[O],E=p[z],H=p[z+1],k.texCoord2(1-v,L),h(k,n,E*F,H*F,C,x),k.texCoord2(1-v,M),h(k,n,E*F,H*F,C,P)}}return d?k.recalcNormals(d,g):k.normalizeNormals()};
H3DU.Meshes.createPointedStar=function(a,c,b,e){var f=new H3DU.Mesh;if(2>a||0>c||0>b||0>=c&&0>=b)return f;f.mode(H3DU.Mesh.TRIANGLE_FAN);var d=0,g=0,h=H3DU.Math.PiTimes2,k=1/(2*a),l=1/Math.max(c,b);f.normal3(0,0,e?-1:1).texCoord2(.5,.5).vertex2(0,0);for(e=0;e<2*a;e++){var m=h*e*k,n=Math.cos(m),p=0===(e&1)?c:b,m=-(0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(m))*p,n=n*p,p=.5*(1+m*l),q=.5*(1+n*l);0===e&&(d=m,g=n);f.texCoord2(p,q).vertex2(m,n)}f.texCoord2(.5*
(1+d*l),.5*(1+g*l)).vertex2(d,g);return f};this.H3DU.Meshes=H3DU.Meshes;H3DU.RenderPass3D=function(a,c){this.subScene=a;this.clearStencil=this.clearDepth=this.clearColor=!0;this.frameBuffer=null;this.setParams(c)};H3DU.RenderPass3D.prototype.setParams=function(a){a&&("undefined"!==typeof a.clearColor&&(this.clearColor=a.clearColor),"undefined"!==typeof a.clearDepth&&(this.clearDepth=a.clearDepth),"undefined"!==typeof a.clearStencil&&(this.clearStencil=a.clearStencil),"undefined"!==typeof a.frameBuffer&&(this.frameBuffer=a.frameBuffer))};H3DU.Scene3D=function(a){var c=a;"function"===typeof a.getContext&&(c=HTMLCanvasElement&&c.constructor===HTMLCanvasElement?H3DU.get3DContext(a):H3DU._toContext(c));this.context=c;this.textureCache={};this._textureLoader=new H3DU.TextureLoader;this._meshLoader=new H3DU.BufferedMesh._MeshLoader;this._renderedOutsideScene=!1;this.shapes=[];this._errors=!1;this._frontFace=H3DU.Scene3D.CCW;this._cullFace=H3DU.Scene3D.NONE;this.clearColor=[0,0,0,1];this.fboFilter=null;this._subScene=new H3DU.Batch3D;this._subScene.getLights().setDefaults();
this._programs=new H3DU.Scene3D.ProgramCache;this.useDevicePixelRatio=!1;this._pixelRatio=1;this.autoResize=!0;this.width=Math.ceil(1*this.context.canvas.clientWidth);this.height=Math.ceil(1*this.context.canvas.clientHeight);this.context.canvas.width=this.width;this.context.canvas.height=this.height;if(this._is3d=H3DU.is3DContext(this.context))this._programs.getProgram(H3DU.Scene3D.LIGHTING_ENABLED|H3DU.Scene3D.SPECULAR_ENABLED|H3DU.Scene3D.SPECULAR_MAP_ENABLED,this.context),this.context.viewport(0,
0,this.width,this.height),this.context.enable(this.context.BLEND),this.context.blendFunc(this.context.SRC_ALPHA,this.context.ONE_MINUS_SRC_ALPHA),this.context.enable(this.context.DEPTH_TEST),this.context.depthFunc(this.context.LEQUAL),this.context.disable(this.context.CULL_FACE),this.context.clearDepth(1),this._setClearColor(),this._setFace()};H3DU.Scene3D.prototype.getCanvas=function(){return this.context.canvas};H3DU.Scene3D.LIGHTING_ENABLED=1;H3DU.Scene3D.SPECULAR_MAP_ENABLED=2;
H3DU.Scene3D.NORMAL_ENABLED=4;H3DU.Scene3D.SPECULAR_ENABLED=8;H3DU.Scene3D.TEXTURE_ENABLED=16;H3DU.Scene3D._materialToFlags=function(a){var c;c=0|(a.basic?0:H3DU.Scene3D.LIGHTING_ENABLED);c|=0!=a.specular[0]||0!=a.specular[1]||0!=a.specular[2]?H3DU.Scene3D.SPECULAR_ENABLED:0;c|=a.specularMap?H3DU.Scene3D.SPECULAR_MAP_ENABLED:0;c|=a.normalMap?H3DU.Scene3D.NORMAL_ENABLED:0;return c|=a.texture?H3DU.Scene3D.TEXTURE_ENABLED:0};
H3DU.Scene3D.ProgramCache=function(){this._programs=[];this._customPrograms=[]};H3DU.Scene3D.ProgramCache.prototype.getCustomProgram=function(a,c){if(!c)throw Error();if(a instanceof H3DU.ShaderProgram)return a;for(var b=0;b<this._customPrograms.length;b++){var e=this._customPrograms[b];if(e[0]==a&&e[1]==c)return e[2]._update(),e[2]}b=H3DU.ShaderProgram._fromShaderInfo(c,a);this._customPrograms.push([a,c,b]);return b};
H3DU.Scene3D.ProgramCache.prototype.getProgram=function(a,c){if(!c)throw Error();var b=this._programs[a];if(b)for(var e=0;e<b.length;e++){if(b[e][0]==c)return b[e][1]}else this._programs[a]=[];b="";0!=(a&H3DU.Scene3D.LIGHTING_ENABLED)&&(b+="#define SHADING\n");0!=(a&H3DU.Scene3D.SPECULAR_ENABLED)&&(b+="#define SPECULAR\n");0!=(a&H3DU.Scene3D.NORMAL_ENABLED)&&(b+="#define NORMAL_MAP\n");0!=(a&H3DU.Scene3D.TEXTURE_ENABLED)&&(b+="#define TEXTURE\n");0!=(a&H3DU.Scene3D.SPECULAR_MAP_ENABLED)&&(b+="#define SPECULAR_MAP\n#define SPECULAR\n");
b=new H3DU.ShaderProgram(c,b+H3DU.ShaderProgram.getDefaultVertex(),b+H3DU.ShaderProgram.getDefaultFragment());this._programs[a].push([c,b]);return b};H3DU.Scene3D.prototype.getContext=function(){return this.context};H3DU.Scene3D.NONE=0;H3DU.Scene3D.BACK=1;H3DU.Scene3D.FRONT=2;H3DU.Scene3D.FRONT_AND_BACK=3;H3DU.Scene3D.CCW=0;H3DU.Scene3D.CW=1;H3DU.Scene3D.prototype.cullFace=function(a){this._cullFace=a===H3DU.Scene3D.BACK||a===H3DU.Scene3D.FRONT||a===H3DU.Scene3D.FRONT_AND_BACK?a:0;return this};
H3DU.Scene3D.prototype._setFace=function(){if(this._is3d)return this._cullFace===H3DU.Scene3D.BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.BACK)):this._cullFace===H3DU.Scene3D.FRONT?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT)):this._cullFace===H3DU.Scene3D.FRONT_AND_BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT_AND_BACK)):this.context.disable(this.context.CULL_FACE),this._frontFace===
H3DU.Scene3D.CW?this.context.frontFace(this.context.CW):this.context.frontFace(this.context.CCW),this};H3DU.Scene3D.prototype.frontFace=function(a){this._frontFace=a===H3DU.Scene3D.CW?a:0;return this};H3DU.Scene3D.prototype.setAutoResize=function(a){this.autoResize=!!a;return this};
H3DU.Scene3D.prototype.setUseDevicePixelRatio=function(a){var c=!!this.useDevicePixelRatio;this._pixelRatio=(this.useDevicePixelRatio=!!a)&&window.devicePixelRatio?window.devicePixelRatio:1;c!==this.useDevicePixelRatio&&this.setDimensions(this.width,this.height);return this};H3DU.Scene3D.prototype.getClearColor=function(){return this.clearColor.slice(0,4)};H3DU.Scene3D.prototype.useProgram=function(a){console.warn("The 'useProgram' method is obsolete.  Instead of this method, use the 'setShader' program of individual shapes to set the shader programs they use.")};
H3DU.Scene3D.prototype.setDimensions=function(a,c){if(0>a||0>c)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(c);this.context.canvas.width=this.width*this._pixelRatio;this.context.canvas.height=this.height*this._pixelRatio;this._is3d&&this.context.viewport(0,0,this.width*this._pixelRatio,this.height*this._pixelRatio);"undefined"!==typeof this.fbo&&this.fbo&&(this.fbo.dispose(),this.fbo=this.createBuffer(),this.fboQuad&&this.fboQuad.setMaterial(this.fbo))};
H3DU.Scene3D.prototype.getWidth=function(){return this.width};H3DU.Scene3D.prototype.getHeight=function(){return this.height};H3DU.Scene3D.prototype.getAspect=function(){var a=this.getHeight();return 0>=a?1:this.getWidth()/a};H3DU.Scene3D.prototype.getClientWidth=function(){return this.context.canvas.clientWidth};H3DU.Scene3D.prototype.getClientHeight=function(){return this.context.canvas.clientHeight};
H3DU.Scene3D.prototype.getClientAspect=function(){var a=this.getClientHeight();return 0>=a?1:this.getClientWidth()/a};H3DU.Scene3D.prototype.createBuffer=function(){return new H3DU.FrameBuffer(this.context,this.getWidth(),this.getHeight())};H3DU.Scene3D.prototype.getProjectionMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene._projectionMatrix.slice(0,16)};
H3DU.Scene3D.prototype.getViewMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._viewMatrix.slice(0,16)};H3DU.Scene3D.prototype.setPerspective=function(a,c,b,e){return this.setProjectionMatrix(H3DU.Math.mat4perspective(a,c,b,e))};
H3DU.Scene3D.prototype.setOrthoAspect=function(a,c,b,e,f,d,g){if(null===g||"undefined"===typeof g)g=this.getClientAspect();0===g&&(g=1);return this.setProjectionMatrix(H3DU.Math.mat4orthoAspect(a,c,b,e,f,d,g))};H3DU.Scene3D.prototype.setOrtho2DAspect=function(a,c,b,e,f){return this.setOrthoAspect(a,c,b,e,-1,1,f)};H3DU.Scene3D.prototype.setFrustum=function(a,c,b,e,f,d){return this.setProjectionMatrix(H3DU.Math.mat4frustum(a,c,e,b,f,d))};
H3DU.Scene3D.prototype.setOrtho=function(a,c,b,e,f,d){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,c,b,e,f,d))};H3DU.Scene3D.prototype.setOrtho2D=function(a,c,b,e){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,c,b,e,-1,1))};H3DU.Scene3D.prototype._setClearColor=function(){this._is3d&&this.context.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);return this};
H3DU.Scene3D.prototype.setClearColor=function(a,c,b,e){this.clearColor=H3DU.toGLColor(a,c,b,e);return this._setClearColor()};H3DU.Scene3D.prototype.loadTexture=function(a){return this._textureLoader.loadTexture(a)};H3DU.Scene3D.prototype.loadAndMapTexture=function(a){var c=null;if(a.constructor===H3DU.Texture)return this.loadAndMapTexture(a.name);var c=this.loadTexture(a),b=this;return c.then(function(a){b._textureLoader.mapTexture(a,b);return a})};
H3DU.Scene3D.prototype.loadAndMapTextures=function(a,c,b){for(var e=[],f=0;f<a.length;f++)e.push(this.loadAndMapTexture(a[f]));return H3DU.getPromiseResults(e,c,b)};H3DU.Scene3D.prototype.clear=function(){this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT|this.context.STENCIL_BUFFER_BIT)};H3DU.Scene3D.prototype.clearDepth=function(){this._is3d&&this.context.clear(this.context.DEPTH_BUFFER_BIT)};
H3DU.Scene3D.prototype.vertexCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.vertexCount()};H3DU.Scene3D.prototype.primitiveCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.primitiveCount()};
H3DU.Scene3D.prototype.setProjectionMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setProjectionMatrix(a);return this};H3DU.Scene3D.prototype.setViewMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setViewMatrix(a);return this};
H3DU.Scene3D.prototype.setLookAt=function(a,c,b){return this.setViewMatrix(H3DU.Math.mat4lookat(a,c,b))};H3DU.Scene3D.prototype.addShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.addShape(a);return this};
H3DU.Scene3D.prototype.makeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return new H3DU.Shape(a)};H3DU.Scene3D.prototype.removeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.removeShape(a);return this};
H3DU.Scene3D.prototype.getLights=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.getLights()};H3DU.Scene3D.prototype.setDirectionalLight=function(a,c,b,e){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setDirectionalLight(a,c,b,e);return this};
H3DU.Scene3D.prototype.setLightParams=function(a,c){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setParams(a,c);return this};H3DU.Scene3D.prototype.setAmbient=function(a,c,b,e){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setAmbient(a,c,b,e);return this};
H3DU.Scene3D.prototype.setPointLight=function(a,c,b,e){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setPointLight(a,c,b,e);return this};H3DU.Scene3D.prototype._clearForPass=function(a){var c=0;a.clearColor&&(c|=this.context.COLOR_BUFFER_BIT);a.clearDepth&&(c|=this.context.DEPTH_BUFFER_BIT);a.clearStencil&&(c|=this.context.STENCIL_BUFFER_BIT);this._is3d&&0!=c&&this.context.clear(c)};
H3DU.Scene3D.prototype.render=function(a){if(a instanceof H3DU.Batch3D)return this.render([new H3DU.RenderPass3D(a)]);if(this.autoResize){var c=this.context.canvas;c.height===Math.ceil(c.clientHeight)*this._pixelRatio&&c.width===Math.ceil(c.clientWidth)*this._pixelRatio||this.setDimensions(c.clientWidth,c.clientHeight)}this._setFace();var c=this.getClientWidth(),b=this.getClientHeight();if(null==a)this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT),this._subScene.resize(c,
b),this._subScene.render(this);else{this._renderedOutsideScene=!0;for(var e=0;e<a.length;e++){var f=a[e];f.frameBuffer&&f.frameBuffer.bind();this._clearForPass(f);a[e].subScene.resize(c,b);a[e].subScene.render(this);f.frameBuffer&&f.frameBuffer.unbind()}}this._is3d&&this.context.flush();return this};
H3DU.Scene3D.prototype.useFilter=function(a){console.warn("The useFilter method has no effect. Use the {@link H3DU.Batch3D.forFilter} method to create a subscene for rendering filter effects from a frame buffer.");return this};H3DU.Scene3D.supportsDerivatives=function(a){a=a.getContext?a.getContext():a;return a.getExtension("OES_standard_derivatives")?!0:!1};H3DU.ShaderInfo=function(a,c){if(null===a||"undefined"===typeof a)a=H3DU.ShaderProgram.getDefaultVertex();if(null===c||"undefined"===typeof c)c=H3DU.ShaderProgram.getDefaultFragment();this.vertexShader=a;this.fragmentShader=c;this.uniformValues={}};H3DU.ShaderInfo.prototype.copy=function(){var a=new H3DU.ShaderInfo(this.vertexShader,this.fragmentShader);a.setUniforms(this.uniformValues);return a};
H3DU.ShaderInfo.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,null);return this};
H3DU.ShaderInfo._setUniformInternal=function(a,c,b,e){isCurrentProgram=null;a=a[b];var f=c[b];if("number"===typeof a){var d=!1;null===f||"undefined"===typeof f?(c[b]=f=a,d=!0):f!==a&&(f=a,c[b]=a,d=!0);d&&e&&(e[b]=f)}else if(3===a.length)if(!f)c[b]=a.slice(0,a.length),e&&(e[b]=a.slice(0,a.length));else{if(f[0]!==a[0]||f[1]!==a[1]||f[2]!==a[2])f[0]=a[0],f[1]=a[1],f[2]=a[2],e&&(e[b]=f.slice(0,f.length))}else if(2===a.length)if(!f)c[b]=a.slice(0,a.length),e&&(e[b]=a.slice(0,a.length));else{if(f[0]!==
a[0]||f[1]!==a[1])f[0]=a[0],f[1]=a[1],e&&(e[b]=f.slice(0,f.length))}else if(4===a.length)if(!f)c[b]=a.slice(0,a.length),e&&(e[b]=a.slice(0,a.length));else{if(f[0]!==a[0]||f[1]!==a[1]||f[2]!==a[2]||f[3]!==a[3])f[0]=a[0],f[1]=a[1],f[2]=a[2],f[3]=a[3],e&&(e[b]=f.slice(0,f.length))}else 16===a.length?f?H3DU.ShaderInfo._copyIfDifferent(a,f,16)&&e&&(e[b]=f.slice(0,f.length)):(c[b]=a.slice(0,a.length),e&&(e[b]=a.slice(0,a.length))):9===a.length&&(f?H3DU.ShaderInfo._copyIfDifferent(a,f,9)&&e&&(e[b]=f.slice(0,
f.length)):(c[b]=a.slice(0,a.length),e&&(e[b]=a.slice(0,a.length))))};H3DU.ShaderInfo._setUniformsInternal=function(a,c,b){var e;if("undefined"!==typeof Object.keys)for(var f=Object.keys(a),d=0;d<f.length;d++)e=f[d],H3DU.ShaderInfo._setUniformInternal(a,c,e,b);else for(e in a)H3DU.ShaderInfo._setUniformInternal(a,c,e,b)};H3DU.ShaderProgram=function(a,c,b){this._init(a,new H3DU.ShaderInfo(c,b))};H3DU.ShaderProgram._fromShaderInfo=function(a,c){var b=new H3DU.ShaderProgram(null);b._init(a,c);return b};
H3DU.ShaderProgram.prototype._init=function(a,c){if(a&&(a=a.getContext?a.getContext():a,this.shaderInfo=c,this.context=a,this.prog=H3DU.ShaderProgram._compileShaders(a,c.vertexShader,c.fragmentShader),this.uniformValues={},this.actives={},this.attributes=[],this.uniformTypes={},this.savedUniforms={},H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms),this.CURRENT_PROGRAM=35725,this.FLOAT=5126,"undefined"!==typeof this.prog&&null!==this.prog)){for(var b=
null,e={},f=a.getProgramParameter(this.prog,a.ACTIVE_ATTRIBUTES),d=0;d<f;++d)if(b=a.getActiveAttrib(this.prog,d),null!==b&&"undefined"!==typeof b){var b=b.name,g=a.getAttribLocation(this.prog,b);0<=g&&(this.attributes.push(g),e[b]=g)}f=a.getProgramParameter(this.prog,a.ACTIVE_UNIFORMS);for(d=0;d<f;++d)g=this.context.getActiveUniform(this.prog,d),null!==g&&"undefined"!==typeof g&&(b=g.name,e[b]=this.context.getUniformLocation(this.prog,b),this.uniformTypes[b]=g.type);this.actives=e}};
H3DU.ShaderProgram.prototype.dispose=function(){this.program&&this.context.deleteProgram(this.program);this.program=this.context=null;this.actives={};this.attributes={};this.uniformTypes={}};H3DU.ShaderProgram.prototype.getContext=function(){return this.context};
H3DU.ShaderProgram.prototype._setUniformInternal=function(a,c){var b=this.get(c);if(null!==b&&"undefined"!==typeof b){var e=a[c];"number"===typeof e?this.uniformTypes[c]===this.FLOAT?this.context.uniform1f(b,e):this.context.uniform1i(b,e):3===e.length?this.context.uniform3fv(b,e):2===e.length?this.context.uniform2fv(b,e):4===e.length?this.context.uniform4fv(b,e):16===e.length?this.context.uniformMatrix4fv(b,!1,e):9===e.length&&this.context.uniformMatrix3fv(b,!1,e)}};
H3DU.ShaderProgram.prototype.get=function(a){a=this.actives[a];return null===a||"undefined"===typeof a?null:a};H3DU.ShaderProgram.prototype.getUniform=function(a){var c="string"===typeof a?this.get(a):a;if(null===c||"number"===typeof c)return null;a=this.uniformValues[a];return null===a||"undefined"===typeof a?this.context.getUniform(this.program,c):a instanceof Array?a.slice(0,a.length):a};
H3DU.ShaderProgram.prototype._setSavedUniforms=function(){var a,c=0;if("undefined"!==typeof Object.keys)for(var b=Object.keys(this.savedUniforms),c=b.length,e=0;e<c;e++)a=b[e],this._setUniformInternal(this.savedUniforms,a);else for(a in this.savedUniforms)this._setUniformInternal(this.savedUniforms,a),c++;return c};H3DU.ShaderProgram.prototype.use=function(){this.context.useProgram(this.prog);0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
H3DU.ShaderProgram.prototype._update=function(){H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms);return this};H3DU.ShaderProgram.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,this.savedUniforms);this.context.getParameter(this.CURRENT_PROGRAM)===this.prog&&0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
H3DU.ShaderInfo._copyIfDifferent=function(a,c,b){for(var e=0;e<b;e++)if(a[e]!==c[e]){c[e]=a[e];for(e+=1;e<b;e++)c[e]=a[e];return!0}return!1};
H3DU.ShaderProgram._compileShaders=function(a,c,b){function e(a,b,c){var e=a.createShader(b);a.shaderSource(e,c);a.compileShader(e);if(!a.getShaderParameter(e,a.COMPILE_STATUS)){c=c.split("\n");for(var f=0;f<c.length;f++)c[f]="/* "+(f+1)+" */   "+c[f];console.log(c.join("\n"));console.log((b===a.VERTEX_SHADER?"vertex: ":"fragment: ")+a.getShaderInfoLog(e));return null}return e}c=c&&0!==c.length?e(a,a.VERTEX_SHADER,c):null;b=b&&0!==b.length?e(a,a.FRAGMENT_SHADER,b):null;var f=null;null!==c&&"undefined"!==
typeof c&&null!==b&&"undefined"!==typeof b&&(f=a.createProgram(),a.attachShader(f,c),a.attachShader(f,b),a.linkProgram(f),a.getProgramParameter(f,a.LINK_STATUS)||(console.log("link: "+a.getProgramInfoLog(f)),a.deleteProgram(f),f=null),a.detachShader(f,c),a.detachShader(f,b));null!==c&&"undefined"!==typeof c&&a.deleteShader(c);null!==b&&"undefined"!==typeof b&&a.deleteShader(b);return f};H3DU.ShaderProgram.fragmentShaderHeader=function(){return"#ifdef GL_ES\n#ifndef GL_FRAGMENT_PRECISION_HIGH\nprecision mediump float;\n#else\nprecision highp float;\n#endif\n#endif\n"};
H3DU.ShaderProgram.makeEffectFragment=function(a){var c=H3DU.ShaderProgram.fragmentShaderHeader(),c=c+"uniform sampler2D sampler;\nuniform vec2 textureSize;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n"+a;return c+="\n\nvoid main(){\n // normalize coordinates to 0..1\n vec2 uv=gl_FragCoord.xy/textureSize.xy;\n gl_FragColor=textureEffect(sampler,uv,textureSize);\n}"};
H3DU.ShaderProgram.makeCopyEffect=function(){var a=H3DU.ShaderProgram.fragmentShaderHeader(),a=a+"uniform sampler2D sampler;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n\n\nvoid main(){\n gl_FragColor=texture2D(sampler,uvVar);\n}";return new H3DU.ShaderInfo(H3DU.ShaderProgram.getBasicVertex(),a)};H3DU.ShaderProgram.makeEffect=function(a,c){return new H3DU.ShaderInfo(H3DU.ShaderProgram.getBasicVertex(),H3DU.ShaderProgram.makeEffectFragment(c))};
H3DU.ShaderProgram.getInvertEffect=function(){return H3DU.ShaderProgram.makeEffect(null,"vec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\n vec4 color=texture2D(sampler,uvCoord);\n vec4 ret; ret.xyz=vec3(1.0,1.0,1.0)-color.xyz; ret.w=color.w; return ret;\n}")};H3DU.ShaderProgram.getEdgeDetectEffect=function(){return H3DU.ShaderProgram.makeEffect(null,"float luma(vec3 color) {\n return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}\nconst vec4 edge_color=vec4(0.,0,0,1);\nconst vec4 back_color=vec4(1.,1,1,1);\nvec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\nfloat dx = 1.0 / float(textureSize.x);\nfloat dy = 1.0 / float(textureSize.y);\nfloat s00 = luma(texture2D(sampler, uvCoord + vec2(-dx,dy)).rgb);\nfloat s10 = luma(texture2D(sampler, uvCoord + vec2(-dx,0.0)).rgb);\nfloat s20 = luma(texture2D(sampler, uvCoord + vec2(-dx,-dy)).rgb);\nfloat s01 = luma(texture2D(sampler, uvCoord + vec2(0.0,dy)).rgb);\nfloat s21 = luma(texture2D(sampler, uvCoord + vec2(0.0,-dy)).rgb);\nfloat s02 = luma(texture2D(sampler, uvCoord + vec2(dx, dy)).rgb);\nfloat s12 = luma(texture2D(sampler, uvCoord + vec2(dx, 0.0)).rgb);\nfloat s22 = luma(texture2D(sampler, uvCoord + vec2(dx, -dy)).rgb);\nfloat sx = s00 + 2.0 * s10 + s20 - (s02 + 2.0 * s12 + s22);\nfloat sy = s00 + 2.0 * s01 + s02 - (s20 + 2.0 * s21 + s22);\nfloat dist = sx * sx + sy * sy;\nif(dist > 0.4) {\nreturn edge_color;\n} else {\nreturn back_color;\n}}")};
H3DU.ShaderProgram.getBasicVertex=function(){};H3DU.ShaderProgram.getDefaultVertex=function(){return"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec3 colorAttr;\nattribute vec3 tangent;\nattribute vec3 bitangent;\nuniform mat4 projection;\nuniform mat4 modelViewMatrix;\n#ifdef SHADING\nuniform mat3 normalMatrix; /* internal */\n#ifdef NORMAL_MAP\nuniform mat4 world;\nvarying mat3 tbnMatrixVar;\n#endif\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#endif\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\nvoid main(){\nvec4 positionVec4;\npositionVec4.w=1.0;\npositionVec4.xyz=position;\ngl_PointSize=1.0;\ngl_Position=(projection*modelViewMatrix)*positionVec4;\ncolorAttrVar=colorAttr;\nuvVar=uv;\n#ifdef SHADING\ntransformedNormalVar=normalize(normalMatrix*normal);\n#ifdef NORMAL_MAP\ntbnMatrixVar=mat3(normalize(vec3(world*vec4(tangent,0.0))),\n   normalize(bitangent),transformedNormalVar);\n#endif\nviewPositionVar=modelViewMatrix*positionVec4;\n#endif\n}"};
H3DU.ShaderProgram.getDefaultFragment=function(){var a,c=H3DU.ShaderProgram.fragmentShaderHeader()+"uniform vec4 md;\n#ifdef SHADING\nstruct light {\n vec4 position; /* source light direction/position, in camera/eye space */\n vec4 diffuse; /* source light diffuse color */\n#ifdef SPECULAR\n vec4 specular; /* source light specular color */\n#endif\n vec4 radius; /* light radius */\n};\nuniform vec3 sceneAmbient;\nuniform light lights["+Lights.MAX_LIGHTS+"];\nuniform vec3 ma;\nuniform vec3 me;\n#ifdef SPECULAR\nuniform vec3 ms;\nuniform float mshin;\n#ifdef SPECULAR_MAP\nuniform sampler2D specularMap;\n#endif\n#ifdef NORMAL_MAP\nuniform sampler2D normalMap;\n#endif\n#endif\n#endif\n#ifdef TEXTURE\nuniform sampler2D sampler;\n#endif\nuniform float useColorAttr;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n#ifdef SHADING\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\nvec4 calcLightPower(light lt, vec4 vertexPosition){\n vec3 sdir;\n float attenuation;\n if(lt.position.w == 0.0){ /* directional light */\n  sdir=normalize((lt.position).xyz);\n  attenuation=1.0;\n } else { /* point light */\n  vec3 vertexToLight=(lt.position-vertexPosition).xyz;\n  float dsSquared=dot(vertexToLight,vertexToLight);\n  sdir=inversesqrt(dsSquared)*vertexToLight;\n  if(lt.radius.x == 0.0) {\n    attenuation=1.0; /* Unlimited extent */\n  } else {\n   float radiusPow4=lt.radius.x; /* Radius is light's radius to power of 4 */\n   float distPow4=dsSquared*dsSquared;\n   float attenDivisor=max(0.0001,dsSquared);\n   float cut=clamp(1.0-distPow4/radiusPow4,0.0,1.0);\n   attenuation=(cut*cut)/attenDivisor;\n  }\n }\n return vec4(sdir,attenuation);\n}\n#endif\nvoid main(){\n vec4 tmp;\n vec3 normal;\n tmp.w=1.0;\n tmp.xyz=colorAttrVar;\n#ifdef TEXTURE\n vec4 baseColor=mix(\n   texture2D(sampler,uvVar),\n   tmp, useColorAttr);\n#else\n vec4 baseColor=mix(\n   md,\n   tmp, useColorAttr);\n#endif\n#ifdef SHADING\n#ifdef NORMAL_MAP\nnormal = normalize(tbnMatrixVar*(2.0*texture2D(normalMap,uvVar).rgb - vec3(1.0)));\n#else\nnormal = normalize(transformedNormalVar);\n#endif\nvec4 lightPower["+
Lights.MAX_LIGHTS+"];\nfloat lightCosines["+Lights.MAX_LIGHTS+"];\n",c=c+"if(baseColor.a == 0.0)discard;\nvec3 materialAmbient=ma; /* ambient*/\nvec3 lightedColor=sceneAmbient*materialAmbient; /* ambient*/\n // diffuse\n vec3 materialDiffuse=baseColor.rgb;\n";for(a=0;a<Lights.MAX_LIGHTS;a++)c+="lightPower["+a+"]=calcLightPower(lights["+a+"],viewPositionVar);\n",c+=" /* Lambert diffusion term */\n",c+="lightCosines["+a+"]=clamp(dot(normal,lightPower["+a+"].xyz),0.0,1.0);\n",c+="lightedColor+=lights["+
a+"].diffuse.xyz*lightCosines["+a+"]*\n",c+="   lightPower["+a+"].w*materialDiffuse;\n";c+="#ifdef SPECULAR\nbool spectmp;\nvec3 materialSpecular=ms;\n#ifdef SPECULAR_MAP\nmaterialSpecular*=texture2D(specularMap,uvVar).rgb;\n#endif\n// specular reflection\nif(materialSpecular.x!=0. || materialSpecular.y!=0. || materialSpecular.z!=0.){\nvec3 viewDirection=normalize((-viewPositionVar).xyz);\n";for(a=0;a<Lights.MAX_LIGHTS;a++)c+="  spectmp = lightCosines["+a+"] > 0.0;\n  if (spectmp) {\n    /* Blinn-Phong specular term */\n    float specular=clamp(dot(normalize(viewDirection+lightPower["+
a+"].xyz),normal),0.0,1.0);\n    specular=pow(specular,mshin);\n    lightedColor+=materialSpecular*specular*lightPower["+a+"].w*lights["+a+"].specular.xyz;\n  }\n";c+="}\n#endif\n";return c+=" // emission\n lightedColor+=me;\n baseColor=vec4(lightedColor,baseColor.a);\n#endif\n gl_FragColor=baseColor;\n}"};H3DU.Shape=function(a){if(null===a||"undefined"===typeof a)throw Error("mesh is null");a instanceof H3DU.Mesh?this.bufferedMesh=new H3DU.MeshBuffer(a):(!H3DU.Shape._bufferedMeshWarning&&a instanceof H3DU.BufferedMesh&&(console.warn("Using an H3DU.BufferedMesh in H3DU.Shape objects is deprecated."),H3DU.Shape._bufferedMeshWarning=!0),this.bufferedMesh=a);this.transform=new H3DU.Transform;this.material=new H3DU.Material;this.parent=null;this.visible=!0};H3DU.Shape._bufferedMeshWarning=!1;
H3DU.Shape.prototype.vertexCount=function(){return this.bufferedMesh?this.bufferedMesh.vertexCount():0};H3DU.Shape.prototype.primitiveCount=function(){return this.bufferedMesh?this.bufferedMesh.primitiveCount():0};H3DU.Shape.prototype.setVisible=function(a){this.visible=!!a;return this};H3DU.Shape.prototype.getVisible=function(){return this.visible};H3DU.Shape.prototype.setColor=function(a,c,b,e){a=H3DU.toGLColor(a,c,b,e);return this.setMaterialParams({ambient:a,diffuse:a})};
H3DU.Shape.prototype.setTexture=function(a){return this.setMaterialParams({texture:a})};H3DU.Shape.prototype.setShader=function(a){return this.setMaterialParams({shader:a})};H3DU.Shape.prototype.setMaterialParams=function(a){this.material?this.material.setParams(a):this.material=(new Material).setParams(a);return this};H3DU.Shape.prototype.setTextureAndColor=function(a,c,b,e,f){c=H3DU.toGLColor(c,b,e,f);return this.setMaterialParams({texture:a,ambient:c,diffuse:c})};
H3DU.Shape.prototype.setMaterial=function(a){this.material=a;return this};H3DU.Shape.prototype.copy=function(){var a=new H3DU.Shape(this.bufferedMesh);a.material=this.material.copy();a.transform=this.getTransform().copy();return a};H3DU.Shape.prototype.getTransform=function(){return this.transform};
H3DU.Shape.prototype.getBounds=function(){if(!this.bufferedMesh)return[0,0,0,-1,-1,-1];var a=this.bufferedMesh._getBounds(),c=this.getMatrix();if(H3DU.Math.mat4isIdentity(c))return a.slice(0,6);var b=H3DU.Math.mat4transformVec3(c,a[0],a[1],a[2]),a=H3DU.Math.mat4transformVec3(c,a[3],a[4],a[5]);return[Math.min(b[0],a[0]),Math.min(b[1],a[1]),Math.min(b[2],a[2]),Math.max(b[0],a[0]),Math.max(b[1],a[1]),Math.max(b[2],a[2])]};
H3DU.Shape.prototype.isCulled=function(a){return this.bufferedMesh&&this.visible?!H3DU.Math.frustumHasBox(a,this.getBounds()):!0};H3DU.Shape.prototype.setTransform=function(a){this.transform=a.copy();return this};H3DU.Shape.prototype.setScale=function(a,c,b){this.getTransform().setScale(a,c,b);return this};H3DU.Shape.prototype.setPosition=function(a,c,b){this.getTransform().setPosition(a,c,b);return this};H3DU.Shape.prototype.setQuaternion=function(a){this.getTransform().setQuaternion(a);return this};
H3DU.Shape.prototype.getMatrix=function(){var a=this.getTransform(),c=a.isIdentity();if(null!==this.parent)var b=this.parent.getMatrix(),a=c?b:H3DU.Math.mat4isIdentity(b)?a.getMatrix():H3DU.Math.mat4multiply(b,a.getMatrix());else a=a.getMatrix();return a};H3DU.ShapeGroup=function(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new H3DU.Transform};H3DU.ShapeGroup.prototype.addShape=function(a){a.parent=this;this.shapes.push(a);return this};H3DU.ShapeGroup.prototype.setVisible=function(a){this.visible=!!a;return this};H3DU.ShapeGroup.prototype.getVisible=function(){return this.visible};H3DU.ShapeGroup.prototype.getTransform=function(){return this.transform};
H3DU.ShapeGroup.prototype.getMatrix=function(){var a=this.getTransform(),c=a.isIdentity();if(null!==this.parent)var b=this.parent.getMatrix(),a=c?H3DU.Math.mat4multiply(b,a.getMatrix()):H3DU.Math.mat4isIdentity(b)?a.getMatrix():b;else a=a.getMatrix();return a};H3DU.ShapeGroup.prototype.setTransform=function(a){this.transform=a.copy();return this};H3DU.ShapeGroup.prototype.setMaterial=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setMaterial(a);return this};
H3DU.ShapeGroup.prototype.setTexture=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setTexture(a);return this};H3DU.ShapeGroup.prototype.setShader=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setShader(a);return this};H3DU.ShapeGroup.prototype.setMaterialParams=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setMaterialParams(a);return this};
H3DU.ShapeGroup.prototype.removeShape=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c]===a&&(this.shapes.splice(c,1),c--);return this};
H3DU.ShapeGroup.prototype.getBounds=function(){for(var a=[0,0,0,0,0,0],c=!0,b=0;b<this.shapes.length;b++){var e=this.shapes[b].getBounds();H3DU.Math.boxIsEmpty(e)||(c?(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],c=!1):(a[0]=Math.min(e[0],a[0]),a[1]=Math.min(e[1],a[1]),a[2]=Math.min(e[2],a[2]),a[3]=Math.max(e[3],a[3]),a[4]=Math.max(e[4],a[4]),a[5]=Math.max(e[5],a[5])))}return c?[0,0,0,-1,-1,-1]:a};
H3DU.ShapeGroup.prototype.vertexCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].vertexCount();return a};H3DU.ShapeGroup.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].primitiveCount();return a};H3DU.ShapeGroup.prototype.setPosition=function(a,c,b){this.transform.setPosition(a,c,b);return this};H3DU.ShapeGroup.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};
H3DU.ShapeGroup.prototype.setScale=function(a,c,b){this.transform.setScale(a,c,b);return this};H3DU.Texture=function(a){this.image=null;this.loadStatus=0;this.name=a;this.width=0;this.clamp=!1;this.height=0};H3DU.Texture.prototype.setClamp=function(a){this.clamp=a;return this};H3DU.Texture.loadTexture=function(a,c){if(c&&c[a])return Promise.resolve(c[a]);var b=new H3DU.Texture(a);c&&(c[a]=b);return b.loadImage().then(function(a){return a},function(a){return Promise.reject(a.name)})};
H3DU.Texture.fromUint8Array=function(a,c,b){if(0>c)throw Error("width less than 0");if(0>b)throw Error("height less than 0");if(a.length<c*b*4)throw Error("array too short for texture");var e=new H3DU.Texture("");e.image=a;e.width=Math.ceil(c);e.height=Math.ceil(b);e.loadStatus=2;return e};
H3DU.Texture.loadTga=function(a){return H3DU.loadFileFromUrl(a,"arraybuffer").then(function(a){var b=new DataView(a.data);b.getUint8(0);b.getUint8(1);var e=b.getUint8(2);if(2!==e&&3!==e)return Promise.reject(Error("unsupported image type"));var f=b.getUint16(8,!0),d=b.getUint16(10,!0);if(0!==f||0!==d)return Promise.reject(Error("unsupported origins"));f=b.getUint16(12,!0);d=b.getUint16(14,!0);if(0===f||0===d)return Promise.reject(Error("invalid width or height"));var g=b.getUint8(16);if(!(32===g&&
2===e||24===g&&2===e||8===g&&3===e))return Promise.reject(Error("unsupported pixelsize"));var h=f*d;if(h>a.data.length)return Promise.reject(Error("size too big"));var k=new Uint8Array(4*h),l=18,m=0;if(32===g&&2===e)for(m=e=0;e<h;e++,m+=4)k[m+2]=b.getUint8(l),k[m+1]=b.getUint8(l+1),k[m]=b.getUint8(l+2),k[m+3]=b.getUint8(l+3),l+=4;else if(24===g&&2===e)for(m=e=0;e<h;e++,m+=4)k[m+2]=b.getUint8(l),k[m+1]=b.getUint8(l+1),k[m]=b.getUint8(l+2),k[m+3]=255,l+=3;else if(8===g&&3===e)for(m=e=0;e<h;e++,m+=4)g=
b.getUint8(l),k[m]=g,k[m+1]=g,k[m+2]=g,k[m+3]=255,l++;a.data=null;return{width:f,height:d,image:k}})};
H3DU.Texture.prototype.loadImage=function(){if(null!==this.image)return Promise.resolve(this);var a=this,c=this.name;a.loadStatus=1;return/\.tga$/i.test(c)?H3DU.Texture.loadTga(c).then(function(b){a.image=b.image;a.width=b.width;a.height=b.height;a.loadStatus=2;return a},function(b){a.loadStatus=-1;return Promise.reject({name:c,error:b})}):new Promise(function(b,e){var f=new Image;f.onload=function(c){c=c.target;a.image=c;a.width=c.width;a.height=c.height;a.loadStatus=2;f.onload=null;f.onerror=null;
b(a)};f.onerror=function(b){a.loadStatus=-1;f.onload=null;f.onerror=null;e({name:c,error:b})};f.src=c})};H3DU.Texture.prototype.dispose=function(){this.height=this.width=0;this.name="";this.image&&("undefined"!==typeof image.onload&&null!==image.onload&&(image.onload=null),"undefined"!==typeof image.onerror&&null!==image.onerror&&(image.onerror=null));this.image=null;this.clamp=!1;this.loadStatus=0};H3DU.Texture.prototype.getName=function(){return name};H3DU.TextureLoader=function(){this.loadedTextures=[];this.textureImages={};this.maxAnisotropy=[]};H3DU.TextureLoader.prototype.getTexture=function(a){return this.textureImages[a]||null};H3DU.TextureLoader.prototype.loadTexture=function(a){return H3DU.Texture.loadTexture(a,this.textureImages)};
H3DU.TextureLoader.prototype._setMaxAnisotropy=function(a){a=a.getContext?a.getContext():a;for(var c=this.maxAnisotropy,b=0;b<c.length;b++)if(c[b][0]==a)if(0<=c[b][2])a.texParameteri(a.TEXTURE_2D,c[b][2],c[b][1]);else return;var e=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic");if(e)return b=e.TEXTURE_MAX_ANISOTROPY_EXT,e=a.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT),c.push([a,e,b]),
a.texParameteri(a.TEXTURE_2D,b,e),e;c.push([a,1,-1,null]);return 1};H3DU.TextureLoader.prototype.loadTexturesAll=function(a,c,b){for(var e=[],f=0;f<a.length;f++)e.push(this.loadTexture(a[f]));return H3DU.getPromiseResultsAll(e,c,b)};H3DU.TextureLoader.prototype.loadAndMapTexture=function(a,c){c=c.getContext?c.getContext():c;var b=this;return this.loadTexture(a).then(function(a){b.mapTexture(a,c);return Promise.resolve(a)})};
H3DU.TextureLoader.prototype.loadAndMapTexturesAll=function(a,c,b,e){c=c.getContext?c.getContext():c;for(var f=[],d=0;d<a.length;d++)f.push(this.loadAndMapTexture(a[d],c));return H3DU.getPromiseResultsAll(f,b,e)};H3DU.TextureLoader.prototype.mapTextures=function(a,c){c=c.getContext?c.getContext():c;for(var b=0;b<a.length;b++)this.mapTexture(a[b],c);return this};
H3DU.TextureLoader.prototype.mapTexture=function(a,c){c=c.getContext?c.getContext():c;for(var b=this.loadedTextures,e=0;e<b.length;e++)if(b[e][0]==a&&b[e][1]==c)return b[e][2];e=new H3DU._LoadedTexture(a,c);b.push([a,c,e]);return e};H3DU.TextureLoader.prototype.dispose=function(){for(var a in this.textureImages)this.textureImages[a].dispose();for(a=0;a<lt.length;a++)this.loadedTextures[a][2].dispose();this.textureImages={};this.loadedTextures=[];this.maxAnisotropy=[]};H3DU.Transform=function(){this.scale=[1,1,1];this.position=[0,0,0];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=H3DU.Math.mat4identity()};H3DU.Transform.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],this.matrix[10]]:this.scale.slice(0,3)};H3DU.Transform.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};
H3DU.Transform.prototype.getQuaternion=function(){return this.complexMatrix?H3DU.Math.quatNormInPlace(H3DU.Math.quatFromMat4(this.matrix)):this.rotation.slice(0,4)};H3DU.Transform.prototype.reset=function(){this.matrix=H3DU.Math.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;return this};
H3DU.Transform.prototype.setMatrix=function(a){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=H3DU.Math.quatFromMat4(this.matrix);this.rotation=H3DU.Math.quatNormInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&
0===a[14]&&1===a[15];return this};H3DU.Transform.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&H3DU.Math.quatIsIdentity(this.rotation);return this._isIdentity};H3DU.Transform.prototype.resetTransform=function(){return this.resetTransform()};
H3DU.Transform.prototype.setScale=function(a,c,b){if(this.complexMatrix)return this;this.scale=null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?[a,c,b]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.setPosition=function(a,c,b){if(this.complexMatrix)return this;this.position=null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?[a,c,b]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.movePosition=function(a,c,b){if(this.complexMatrix)return this;null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?(this.position[0]+=a,this.position[1]+=c,this.position[2]+=b):"number"!==typeof a?(this.position[0]+=a[0],this.position[1]+=a[1],this.position[2]+=a[2]):(this.position[0]+=a,this.position[1]+=a,this.position[2]+=a);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];
this._matrixDirty=!0;return this};H3DU.Transform.prototype.setQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=a.slice(0,4);H3DU.Math.quatNormInPlace(this.rotation);this._matrixDirty=!0;return this};H3DU.Transform.prototype.setOrientation=function(a,c,b,e){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,c,b,e))};
H3DU.Transform.prototype.multQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=H3DU.Math.quatNormInPlace(H3DU.Math.quatMultiply(this.rotation,a));this._matrixDirty=!0;return this};H3DU.Transform.prototype.multOrientation=function(a,c,b,e){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,c,b,e))};
H3DU.Transform.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,H3DU.Math.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=
H3DU.Math.mat4multiply(this.matrix,H3DU.Math.quatToMat4(this.rotation));H3DU.Math.mat4scaleInPlace(this.matrix,this.scale);var a=this.matrix;this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]}else if(this._isIdentity)return H3DU.Math.mat4identity();return this.matrix.slice(0,16)};
H3DU.Transform.prototype.copy=function(){var a=new H3DU.Transform;a.scale=this.scale.slice(0,this.scale.length);a.position=this.position.slice(0,this.scale.length);a.complexMatrix=this.complexMatrix;a._matrixDirty=this._matrixDirty;a.matrix=this.matrix.slice(0,this.matrix.length);return a};var BezierCurve=H3DU.BezierCurve,BezierSurface=H3DU.BezierSurface,BSplineCurve=H3DU.BezierCurve,BSplineSurface=H3DU.BezierSurface,GLUtil=H3DU,GLMath=H3DU.Math,CurveEval=H3DU.CurveEval,Lights=H3DU.Lights,LightSource=H3DU.LightSource,Material=H3DU.Material,Mesh=H3DU.Mesh,Meshes=H3DU.Meshes,Scene3D=H3DU.Scene3D,ShaderProgram=H3DU.ShaderProgram,Shape=H3DU.Shape,ShapeGroup=H3DU.ShapeGroup,Texture=H3DU.Texture,TextureLoader=H3DU.TextureLoader,Batch3D=H3DU.Batch3D,TextureLoader=H3DU.TextureLoader,ShaderInfo=
H3DU.ShaderInfo,RenderPass3D=H3DU.RenderPass3D;
